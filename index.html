<!DOCTYPE html>
<html lang="ja">
<head>
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="TimeManager">
<link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/3652/3652191.png">

<link rel="manifest" href="data:application/manifest+json,{%22name%22:%22TimeManager%20Pro%22,%22short_name%22:%22TimeManager%22,%22start_url%22:%22.%22,%22display%22:%22standalone%22,%22background_color%22:%22%23f4f5f7%22,%22theme_color%22:%22%235c67f2%22}">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Time Manager Pro</title>
    <style>
        :root { --primary: #5c67f2; --shift: #4caf50; --job: #ffa500; --danger: #ff4d4d; --bg: #f4f5f7; --holiday: #ff5252; --sleep: #d8d6f0; }
        body { font-family: sans-serif; background: var(--bg); margin: 0; padding: 10px; display: flex; justify-content: center; -webkit-tap-highlight-color: transparent; overscroll-behavior-y: contain;}
        .container { width: 100%; max-width: 550px; background: white; padding: 15px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .hidden { display: none !important; }
        
        /* Header */
        .header { margin-bottom: 15px; }
        .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; flex-wrap: wrap; gap: 8px; }
        .month-nav { display: flex; align-items: center; gap: 5px; }
        .title-group { display: flex; flex-direction: column; align-items: center; }
        #view-title { cursor: pointer; font-size: 17px; margin: 0; padding: 5px 8px; border-radius: 6px; background: #f0f0f0; }
        .nav-btn { background: #eee; border: none; padding: 10px 12px; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 14px; }
        .reset-btn { background: #fff1f1; color: var(--danger); border: 1px solid #ffcccc; padding: 4px 10px; border-radius: 4px; font-size: 11px; cursor: pointer; margin-top: 4px; touch-action: manipulation; }

        .mode-switch { background: #f0f0f0; padding: 4px; border-radius: 20px; display: inline-flex; margin-bottom: 10px; }
        .mode-btn { border: none; padding: 8px 15px; border-radius: 15px; cursor: pointer; font-size: 11px; }
        .mode-btn.active { background: var(--primary); color: white; }
        .mode-btn.shift-active { background: var(--shift) !important; color: white; }

        /* Calendar */
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; }
        .calendar-day { border: 1px solid #eee; min-height: 95px; padding: 4px; cursor: pointer; font-size: 11px; border-radius: 6px; background: white; display: flex; flex-direction: column; overflow: hidden; position: relative; }
        .calendar-day.shift-mode-active { border: 1.5px dashed var(--shift); background-color: #fafffa; }
        .is-today { border: 2px solid var(--primary) !important; background: #f0f2ff; }
        .is-holiday .day-num { color: var(--holiday); }
        .day-num { font-weight: bold; }
        .holiday-name { font-size: 8px; color: var(--holiday); overflow: hidden; white-space: nowrap; margin-bottom: 2px; }
        
        .job-band { height: 15px; background: var(--job); color: white; font-size: 9px; margin-bottom: 2px; border-radius: 3px; padding: 0 4px; line-height: 15px; overflow: hidden; white-space: nowrap; }
        .job-band.deleted { background: repeating-linear-gradient(45deg, #ff4d4d, #ff4d4d 5px, #ff6666 5px, #ff6666 10px); }
        .shift-band { background: #e8f5e9 !important; color: #2e7d32 !important; border: 1px solid var(--shift); font-weight: bold; }

        /* Timeline */
#timeline-container { 
    position: relative; 
    margin-left: 50px; /* â˜…å·¦å´ã«æ™‚é–“ã®æ•°å­—ãŒå…¥ã‚‹ã‚¹ãƒšãƒ¼ã‚¹ã‚’ç©ºã‘ã‚‹ */
    margin-right: 10px;
}
#timeline { 
    width: 100%; 
    height: 1920px; /* 20px Ã— 96ãƒã‚¹åˆ† */
    border: 1px solid #ccc; 
    position: relative; 
    background: #fff; 
    touch-action: none; 
    box-sizing: border-box; 
    overflow: visible;
}
ã€€ã€€
ã€€.time-slot {
    height: 20px; /* å„ãƒã‚¹ã®é«˜ã•ã‚’20pxã«å›ºå®š */
    box-sizing: border-box;
    border-bottom: 1px solid #eee;
    position: relative;
}
        .time-label { position: absolute; left: -45px; width: 40px; text-align: right; font-size: 10px; color: #888; line-height: 20px; }
        .fixed-busy { background-color: var(--sleep); }
        .shift-busy { background-color: #e8f5e9; border-left: 5px solid var(--shift); }
        
        /* äºˆå®šãƒ–ãƒ­ãƒƒã‚¯ã¨ãƒœã‚¿ãƒ³ã®è¨­å®š */
        .custom-task { position: absolute; left: 0; right: 0; z-index: 10; color: white; font-size: 10px; font-weight: bold; padding: 2px 6px; border-radius: 4px; display: flex; align-items: center; justify-content: space-between; cursor: grab; box-sizing: border-box; overflow: visible;transition: box-shadow 0.2s; }
        
/* æ´ã‚“ã§ã„ã‚‹é–“ã®ã‚«ãƒ¼ã‚½ãƒ«ã‚’ã€Œæ¡ã£ãŸæ‰‹ã€ã«ã™ã‚‹ */
.custom-task:active {
    cursor: grabbing;
}


.custom-task:hover {
    box-shadow: 0 2px 8px rgba(0,0,0,0.2);
}

        .btn-group-mini { display: flex; gap: 2px; z-index: 20; }
        .del-btn-mini { background: rgba(255,255,255,0.9); color: #333; border: 1px solid #ccc; border-radius: 4px; width: 24px; height: 18px; font-size: 11px; cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }

        .move-preview { opacity: 0.6; pointer-events: none; z-index: 50; position: absolute; left: 0; right: 0; border: 1px solid white; }
ã€€ã€€ã€€ã€€.drag-guide {
    position: absolute;
    left: 0;
    right: 0;
    width: 100%;
    background: rgba(92, 103, 242, 0.3);
    border: 2px dashed var(--primary);
    z-index: 1000;
    pointer-events: none;
    box-sizing: border-box;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--primary);
    font-weight: bold;
    font-size: 12px;
}        
        .time-slot::after { content: attr(data-label); position: absolute; right: 10px; top: 50%; transform: translateY(-50%); font-size: 10px; color: rgba(0,0,0,0.1); font-weight: bold; pointer-events: none; }
        .commute-busy, .break-busy { background-color: #f0f0f0 !important; }        

        /* Job Cards & Modals */
        .job-card { background: #fffaf0; border: 1px solid #ffe0b2; padding: 12px; border-radius: 8px; margin-bottom: 8px; }
        .job-card.completed { background: #f0f0f0; border-color: #ccc; opacity: 0.8; }
        .job-card.deleted { background: repeating-linear-gradient(45deg, #fff5f5, #fff5f5 10px, #ffebeb 10px, #ffebeb 20px); border-color: var(--danger); }
        .job-card-row { display: flex; align-items: center; justify-content: space-between; gap: 10px; margin-top: 10px; }
        .progress-input { width: 60px !important; margin: 0 !important; padding: 4px !important; text-align: center; }
        .mini-btn { padding: 6px 10px; font-size: 11px; border-radius: 4px; border: 1px solid #ccc; background: white; cursor: pointer; }

.modal-overlay {
    position: fixed;   /* ç”»é¢ã®æ±ºã¾ã£ãŸä½ç½®ã«å›ºå®š */
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5); /* èƒŒæ™¯ã‚’æš—ãã™ã‚‹ */
    display: none;     /* â˜… ã“ã“ï¼æœ€åˆã¯éè¡¨ç¤ºã«ã™ã‚‹ */
    justify-content: center;
    align-items: center;
    z-index: 1000;     /* ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚ˆã‚Šæ‰‹å‰ã«è¡¨ç¤º */
}
        .modal { background: white; padding: 20px; border-radius: 12px; width: 100%; max-width: 360px; position: relative; }
        input, select { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ddd; border-radius: 6px; font-size: 16px; box-sizing: border-box; }
        .save-btn { width: 100%; padding: 14px; background: var(--primary); color: white; border: none; border-radius: 8px; font-weight: bold; margin-top: 10px; }
    </style>
</head>
<body>
<div id="app-notification" style="display:none; position:fixed; top:20px; left:50%; transform:translateX(-50%); width:90%; max-width:400px; background:#333; color:#fff; padding:15px; border-radius:10px; box-shadow:0 4px 15px rgba(0,0,0,0.3); z-index:10000; cursor:pointer;">
    <div id="notification-title" style="font-weight:bold; font-size:16px; margin-bottom:5px;"></div>
    <div id="notification-body" style="font-size:14px; white-space:pre-wrap;"></div>
</div>

<div class="container">
    <div class="header">
        <div class="top-bar">
            <button id="back-to-cal-btn" class="nav-btn hidden" onclick="showCalendar()">â† æˆ»ã‚‹</button>
            <div class="month-nav">
                <button class="nav-btn" onclick="changeMonth(-1)">ã</button>
                <div class="title-group">
                    <h2 id="view-title" onclick="openJumpModal()"></h2>
                    <button class="reset-btn" id="month-reset-btn">æœˆé–“ãƒªã‚»ãƒƒãƒˆ</button>
                </div>
                <button class="nav-btn" onclick="changeMonth(1)">ï¼</button>
            </div>
            <div id="action-btns">
                <button onclick="openSleepModal()" class="nav-btn" style="background:var(--sleep);">ç¡çœ </button>
                <button onclick="openShiftModal()" class="nav-btn" style="background:#e8f5e9; color:#2e7d32;">ã‚·ãƒ•ãƒˆ</button>
                <button onclick="openJobMenuModal()" class="nav-btn" style="background:#fff3e0; color:#e65100;">æ¡ˆä»¶ãƒ¡ãƒ‹ãƒ¥ãƒ¼</button>
            </div>
        </div>
        <div class="mode-switch" id="mode-selector">
            <button class="mode-btn active" id="mode-normal-btn" onclick="setAppMode('normal')">é–²è¦§</button>
            <button class="mode-btn" id="mode-shift-btn" onclick="setAppMode('shift')">ã‚·ãƒ•ãƒˆä¸€æ‹¬</button>
        </div>
    </div>

    <div id="calendar-screen">
        <div class="calendar-grid" id="calendar-grid"></div>
    </div>

    <div id="day-screen" class="hidden">
        <div style="display:flex; justify-content:space-between; align-items:center; background:#f0f2ff; padding:10px; border-radius:8px; margin-bottom:10px;">
            <button class="nav-btn" onclick="slideDay(-1)">ï¼œ</button>
            <div style="text-align:center;">
                <h2 id="current-day-label" style="margin:0; font-size:16px;"></h2>
                <div id="freeTime" style="font-size:11px; font-weight:bold;"></div>
            </div>
            <button class="nav-btn" onclick="slideDay(1)">ï¼</button>
        </div>
        <div id="day-jobs-area"></div>
        <div id="timeline-container">
            <div id="timeline"></div>
            <div id="drag-guide" class="drag-guide hidden" style="position:absolute; left:0; right:0; background:rgba(92,103,242,0.3); border:2px dashed var(--primary); z-index:1000; pointer-events:none;"></div>
        </div>
    </div>
</div>

<div id="reset-modal-overlay" class="modal-overlay">
    <div class="modal">
        <h3>æœˆé–“ãƒªã‚»ãƒƒãƒˆ</h3>
        <p id="reset-confirm-msg" style="font-size:14px; color:#666;"></p>
        <button onclick="executeMonthlyReset()" class="save-btn" style="background:var(--danger);">æœ¬å½“ã«ã™ã¹ã¦æ¶ˆå»ã™ã‚‹</button>
        <button type="button" onclick="closeModal('reset-modal-overlay')" class="save-btn" style="background:#666;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
    </div>
</div>

<div id="jump-modal-overlay" class="modal-overlay"><div class="modal"><h3>å¹´æœˆã‚¸ãƒ£ãƒ³ãƒ—</h3><div style="display:flex; gap:10px;"><select id="jump-year"></select><select id="jump-month"></select></div><button onclick="jumpToMonth()" class="save-btn">ã‚¸ãƒ£ãƒ³ãƒ—</button><button onclick="closeModal('jump-modal-overlay')" style="width:100%; border:none; background:none; margin-top:10px;">é–‰ã˜ã‚‹</button></div></div>

<div id="sleep-modal-overlay" class="modal-overlay">
    <div class="modal">
        <h3>ç¡çœ è¨­å®š</h3>
        <div style="display:flex; gap:10px;">
            <div><label>é–‹å§‹</label><input type="time" id="sleep-start"></div>
            <div><label>çµ‚äº†</label><input type="time" id="sleep-end"></div>
        </div>
        <div id="batch-sleep-area"><button onclick="saveDefSleep()" class="save-btn">åŸºæœ¬è¨­å®šã¨ã—ã¦ä¿å­˜</button></div>
        <button id="save-day-sleep-btn" onclick="saveDaySleep()" class="save-btn hidden">ã“ã®æ—¥ã®ã¿ä¿å­˜</button>
        <button onclick="closeModal('sleep-modal-overlay')" style="width:100%; border:none; background:none; margin-top:10px;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
    </div>
</div>

<div id="job-menu-overlay" class="modal-overlay">
    <div class="modal">
        <h3>æ¡ˆä»¶ãƒ¡ãƒ‹ãƒ¥ãƒ¼</h3>
        <button onclick="closeModal('job-menu-overlay'); openJobModal();" class="save-btn" style="background:#fff3e0; color:#e65100;">ï¼‹ æ–°è¦æ¡ˆä»¶ç™»éŒ²</button>
        <button onclick="closeModal('job-menu-overlay'); openJobList();" class="save-btn" style="background:#eee; color:#333;">ğŸ“‹ æ¡ˆä»¶ä¸€è¦§ï¼ˆå…¨å±¥æ­´ï¼‰</button>
        <button onclick="closeModal('job-menu-overlay')" style="width:100%; border:none; background:none; margin-top:15px;">é–‰ã˜ã‚‹</button>
    </div>
</div>


<div id="job-modal-overlay" class="modal-overlay">
    <div class="modal">
        <h3>æ¡ˆä»¶ç™»éŒ²</h3>
        <input type="hidden" id="edit-job-id">
        <input type="text" id="job-name" placeholder="æ¡ˆä»¶å" autocomplete="off">
        <div style="display:flex; gap:5px;"><input type="date" id="job-start"><input type="date" id="job-end"></div>
        <input type="number" id="job-total-h" placeholder="æƒ³å®šåˆè¨ˆæ™‚é–“(h)">
        <textarea id="job-memo" placeholder="ãƒ¡ãƒ¢ãƒ»å‚™è€ƒï¼ˆè‡ªç”±å…¥åŠ›ï¼‰" style="width:100%; height:80px; margin-top:8px; padding:10px; border-radius:6px; border:1px solid #ddd; font-size:14px; box-sizing:border-box;"></textarea>
        <button onclick="saveJob()" class="save-btn">ä¿å­˜</button>
<button onclick="closeModal('job-modal-overlay'); document.getElementById('job-menu-overlay').style.display='flex';" style="width:100%; border:none; background:none; margin-top:10px;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
    </div>
</div>

<div id="modal-overlay" class="modal-overlay"><div class="modal"><h3>äºˆå®šã®è¿½åŠ </h3><input type="text" id="task-name" placeholder="äºˆå®šã®åå‰" autocomplete="off"><div id="color-picker-area" style="display:grid; grid-template-columns:repeat(4,1fr); gap:8px; margin:10px 0;"></div><button onclick="saveTask()" class="save-btn">ä¿å­˜</button>
<button onclick="closeModal('modal-overlay')" style="width:100%; border:none; background:none; margin-top:10px;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button></div></div>

<div id="edit-modal-overlay" class="modal-overlay"><div class="modal"><h3>äºˆå®šã®å‰Šé™¤</h3><p id="edit-info" style="text-align:center; font-weight:bold;"></p><button id="final-delete-btn" class="save-btn" style="background:var(--danger);">å‰Šé™¤</button><button onclick="closeModal('edit-modal-overlay')" style="width:100%; border:none; background:none; margin-top:10px;">æˆ»ã‚‹</button></div></div>


<div id="job-list-modal-overlay" class="modal-overlay">
    <div class="modal" style="max-height: 80vh; overflow-y: auto;">
        <h3>æ¡ˆä»¶ä¸€è¦§ï¼ˆå…¨å±¥æ­´ï¼‰</h3>
        <div id="all-job-list-container"></div>
        
       <button onclick="closeModal('job-list-modal-overlay'); openJobMenuModal();" class="save-btn" style="background:#666;">é–‰ã˜ã‚‹</button>
    </div>
</div>


<div id="shift-modal-overlay" class="modal-overlay">
    <div class="modal" style="max-height:90vh; overflow-y:auto;">
        <h3>ã‚·ãƒ•ãƒˆãƒ»æ™‚é–“è¨­å®š</h3>
        
        <div style="border-bottom:1px solid #eee; margin-bottom:10px; padding-bottom:10px;">
            <label style="font-weight:bold; font-size:12px;">å‹¤å‹™æ™‚é–“</label>
            <div style="display:flex; gap:5px; align-items:center;">
                <input type="time" id="set-shift-start" style="margin:0;"> ï½ <input type="time" id="set-shift-end" style="margin:0;">
            </div>
        </div>

        <div style="border-bottom:1px solid #eee; margin-bottom:10px; padding-bottom:10px;">
            <label style="font-weight:bold; font-size:12px;">é€šå‹¤æ™‚é–“ï¼ˆç‰‡é“ï¼‰</label>
            <div style="display:flex; gap:5px;">
                <input type="number" id="set-commute-h" placeholder="æ™‚é–“" style="width:50%; margin:0;">
                <input type="number" id="set-commute-m" placeholder="åˆ†" style="width:50%; margin:0;">
            </div>
        </div>

        <div style="border-bottom:1px solid #eee; margin-bottom:10px; padding-bottom:10px;">
            <label style="font-weight:bold; font-size:12px;">æ˜¼ä¼‘ã¿ï¼ˆé–‹å§‹ãƒ»çµ‚äº†ï¼‰</label>
            <div style="display:flex; gap:5px; align-items:center;">
                <input type="time" id="set-break-start" style="margin:0;"> ï½ <input type="time" id="set-break-end" style="margin:0;">
            </div>
        </div>

        <div id="batch-shift-area">
            <label style="font-size:12px; font-weight:bold;">æ›œæ—¥ä¸€æ‹¬åæ˜ </label>
            <div id="weekday-checks" style="display:grid; grid-template-columns:repeat(4,1fr); gap:5px; margin-top:5px;">
                <label><input type="checkbox" value="1">æœˆ</label>
                <label><input type="checkbox" value="2">ç«</label>
                <label><input type="checkbox" value="3">æ°´</label>
                <label><input type="checkbox" value="4">æœ¨</label>
                <label><input type="checkbox" value="5">é‡‘</label>
                <label><input type="checkbox" value="6">åœŸ</label>
                <label><input type="checkbox" value="0">æ—¥</label>
            </div>
            <button onclick="applyBatchShift()" class="save-btn" style="background:var(--shift);">ã“ã®è¨­å®šã‚’ä¸€æ‹¬åæ˜ </button>
            <button onclick="saveDefShift()" class="save-btn" style="background:#eee; color:#333; margin-top:5px;">åŸºæœ¬è¨­å®šã¨ã—ã¦ä¿å­˜</button>
        </div>

        <button id="save-day-shift-btn" onclick="saveDayShift()" class="save-btn hidden">ã“ã®æ—¥ã®ã¿ä¿å­˜</button>
        <button onclick="closeModal('shift-modal-overlay')" style="width:100%; border:none; background:none; margin-top:10px; padding:10px;">é–‰ã˜ã‚‹</button>
    </div>
</div>

<div id="app-notice-bar" style="
    display: none; 
    position: fixed; 
    top: 20px; 
    left: 5%;         /* ç”»é¢ã®å·¦ã‹ã‚‰5%ã®ä½ç½®ï¼ˆä½™ç™½ï¼‰ */
    right: 5%;        /* ç”»é¢ã®å³ã‹ã‚‰5%ã®ä½ç½®ï¼ˆä½™ç™½ï¼‰ */
    width: 90%;       /* ç”»é¢å¹…ã®90%ã‚’ä½¿ã† */
    max-width: 400px; /* PCãªã©å¤§ããªç”»é¢ã§ã¯åºƒãŒã‚Šã™ããªã„ã‚ˆã†ã« */
    margin: 0 auto;   /* ä¸­å¤®å¯„ã›ã®äºˆå‚™ */
    background: rgba(40, 40, 40, 0.95); 
    color: white; 
    padding: 15px; 
    border-radius: 12px; 
    box-shadow: 0 8px 25px rgba(0,0,0,0.5); 
    z-index: 10000;   /* ä»–ã®è¦ç´ ã‚ˆã‚Šçµ¶å¯¾æ‰‹å‰ */
    border: 1px solid #555;
    box-sizing: border-box; /* ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚’å«ã‚ãŸå¹…è¨ˆç®—ã«ã™ã‚‹ */
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px); /* iPhoneç”¨ã®ã¼ã‹ã— */
">
    <div id="notice-title" style="font-weight:bold; font-size:16px; color:#ffdd00; margin-bottom:8px; border-bottom:1px solid #555; padding-bottom:5px;"></div>
    <div id="notice-body" style="font-size:14px; line-height:1.5; white-space:pre-wrap; word-wrap: break-word;"></div>
    <div style="text-align:center; font-size:11px; margin-top:10px; opacity:0.6; font-style:italic;">ã‚¿ãƒƒãƒ—ã—ã¦é–‰ã˜ã‚‹</div>
</div>

<script>
let isEditingFromList = false; // â˜…ã“ã®è¡Œã‚’è¿½åŠ ï¼ˆç›®å°ã«ãªã‚Šã¾ã™ï¼‰
let currentViewDate = new Date(); currentViewDate.setDate(1);
const STORAGE_KEY = 'TimeManager_V22';

let appData = { 
    tasks: {}, 
    longTermJobs: [], 
    singleShifts: {}, 
    singleSleeps: {}, 
    defShift: { start: 36, end: 68, commuteH: 0, commuteM: 0, breakStart: "12:00", breakEnd: "13:00" }, 
    defSleep: { start: 0, end: 26 } 
};

let holidayData = {};
const COLORS = ["#ff99bb", "#98fb98", "#87cefa", "#ffcc99", "#e0bbff", "#ffff99", "#ffcccc", "#d3d3d3"];
let selectedColor = COLORS[0], inputMode = 'normal', selectedDate = "";

let touchTimer = null;
let longPressed = false;
let touchStartX = 0;
let touchStartY = 0;

let isDragging = false, dragMode = null, startIdx = null, activeTaskId = null, moveOffset = 0, tempRange = { start: 0, length: 0 }, scrollInterval = null, lastTouchY = 0;
function saveJob() {
    const id = document.getElementById('edit-job-id').value;
    const name = document.getElementById('job-name').value;
    const start = document.getElementById('job-start').value;
    const end = document.getElementById('job-end').value;
    const totalH = parseFloat(document.getElementById('job-total-h').value) || 0;
    const memo = document.getElementById('job-memo').value;

    if (!name) { alert("æ¡ˆä»¶åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }

    if (id) {
        const idx = appData.longTermJobs.findIndex(j => j.id == id);
        if (idx !== -1) {
            appData.longTermJobs[idx].name = name;
            appData.longTermJobs[idx].start = start;
            appData.longTermJobs[idx].end = end;
            appData.longTermJobs[idx].totalH = totalH;
            appData.longTermJobs[idx].memo = memo;
        }
    } else {
        const newJob = {
            id: Date.now(),
            name: name,
            start: start,
            end: end,
            totalH: totalH,
            memo: memo,
            progress: 0,
            isCompleted: false
        };
        appData.longTermJobs.push(newJob);
    }

    saveData(); 
    
    // 1. å…¥åŠ›ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
    closeModal('job-modal-overlay');

    // 2. ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç”»é¢ï¼ˆæ–°è¦ãƒ»ä¸€è¦§ãƒœã‚¿ãƒ³ãŒã‚ã‚‹ç”»é¢ï¼‰ã‚’ç¢ºå®Ÿã«è¡¨ç¤ºã™ã‚‹
    // ä½™è¨ˆãªé–¢æ•°ï¼ˆopenJobListãªã©ï¼‰ã‚’å‘¼ã°ãšã€è¡¨ç¤ºã ã‘ã‚’å¤‰ãˆã‚‹ã®ãŒã‚³ãƒ„ã§ã™
    const menuModal = document.getElementById('job-menu-overlay');
    if (menuModal) {
        menuModal.style.display = 'flex';
    }

    // 3. èƒŒæ™¯ã®ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼è¡¨ç¤ºã‚’æ›´æ–°ã™ã‚‹
    renderCalendar();
    if (typeof updateJobArea === 'function') updateJobArea();
}

function dtToStr(d) { return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`; }
function loadData() { const s = localStorage.getItem(STORAGE_KEY); if(s) appData = JSON.parse(s); }
function saveData() { localStorage.setItem(STORAGE_KEY, JSON.stringify(appData)); }
function indexToTime(i) { return `${String(Math.floor(i/4)).padStart(2,'0')}:${String((i%4)*15).padStart(2,'0')}`; }
function timeToIndex(t) { const [h,m]=t.split(':').map(Number); return h*4+Math.floor(m/15); }
function formatDur(l) {
    const h = Math.floor(l / 4);
    const m = (l % 4) * 15;
    if (h > 0 && m > 0) return `${h}æ™‚é–“${m}åˆ†`;
    if (h > 0) return `${h}æ™‚é–“`;
    return `${m}åˆ†`;
}
function isJobVisibleOnDate(job, dateStr) {
    const targetDate = new Date(dateStr);
    const startDate = new Date(job.start);
    const endDate = new Date(job.end);

    // 1. ãã‚‚ãã‚‚æ¡ˆä»¶ã®æœŸé–“å†…ã‹ãƒã‚§ãƒƒã‚¯
    if (targetDate < startDate || targetDate > endDate) return false;

    // 2. ã€Œå®Œäº†ã€ã¾ãŸã¯ã€Œå‰Šé™¤ã€ã•ã‚Œã¦ã„ã‚‹å ´åˆ
    if (job.isCompleted || job.isDeleted) {
        // å®Œäº†/å‰Šé™¤ã—ãŸæ—¥ã®ã€Œç¿Œæ—¥ã€ä»¥é™ãªã‚‰éè¡¨ç¤ºã«ã™ã‚‹
        // â€»job.completedDate ã‚„ job.deletedDate ãŒä¿å­˜ã•ã‚Œã¦ã„ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™
        const actionDateStr = job.completedDate || job.deletedDate;
        if (actionDateStr) {
            const actionDate = new Date(actionDateStr);
            if (targetDate > actionDate) return false;
        }
    }

    return true;
}
// --- ã“ã“ã‚’ä¿®æ­£ã—ã¦ãã ã•ã„ ---

function openJobMenuModal() {
    document.getElementById('job-menu-overlay').style.display = 'flex';
}


function init() {
    loadData();
    renderCalendar(); // ã¾ãšä¸€åº¦æç”»
    fetchHolidays();  // ç¥æ—¥ã‚’å–å¾—ã—ã¦å†æç”»
    
    const dayScreen = document.getElementById('day-screen');
    dayScreen.addEventListener('touchstart', (e) => {
        if (document.getElementById('job-list-modal-overlay').style.display === 'flex') return; 
        touchStartX = e.touches[0].pageX;
    }, {passive: true});

    dayScreen.addEventListener('touchend', (e) => {
        const touchEndX = e.changedTouches[0].pageX;
        const diff = touchStartX - touchEndX;
        if (diff > 100) slideDay(1);
        else if (diff < -100) slideDay(-1);
    }, {passive: true});   
    
    document.getElementById('final-delete-btn').onclick = deleteTask;
    document.getElementById('month-reset-btn').onclick = (e) => {
        e.stopPropagation();
        const y = currentViewDate.getFullYear(), m = currentViewDate.getMonth() + 1;
        document.getElementById('reset-confirm-msg').textContent = `${y}å¹´${m}æœˆã®ã€Œäºˆå®šã€ã¨ã€Œã‚·ãƒ•ãƒˆã€ã‚’ã™ã¹ã¦å‰Šé™¤ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ`;
        document.getElementById('reset-modal-overlay').style.display = 'flex';
    };

    const cp = document.getElementById('color-picker-area');
    if (cp) {
        cp.innerHTML = "";
        COLORS.forEach(c => {
            const b = document.createElement('div'); 
            b.style.height='35px'; b.style.borderRadius='6px'; b.style.background=c; b.style.border='3px solid transparent';
            b.onclick = () => { 
                selectedColor = c; 
                [...cp.children].forEach(x=>x.style.borderColor='transparent'); 
                b.style.borderColor='#333'; 
            };
            cp.appendChild(b);
        });
    }
}



function openJobModal(id = null) { 
    const listModal = document.getElementById('job-list-modal-overlay');
    isEditingFromList = (listModal && listModal.style.display === 'flex');
    closeModal('job-list-modal-overlay');

    if (id) {
        const j = appData.longTermJobs.find(x => x.id == id);
        if(j) {
            document.getElementById('edit-job-id').value = id;
            document.getElementById('job-name').value = j.name;
            document.getElementById('job-start').value = j.start;
            document.getElementById('job-end').value = j.end;
            document.getElementById('job-total-h').value = j.totalH;
            document.getElementById('job-memo').value = j.memo || ""; // ãƒ¡ãƒ¢ã‚’èª­ã¿è¾¼ã¿
        }
    } else {
        // æ–°è¦ç™»éŒ²æ™‚ã¯ã™ã¹ã¦ç©ºã«ã™ã‚‹
        document.getElementById('edit-job-id').value = "";
        document.getElementById('job-name').value = "";
        document.getElementById('job-start').value = selectedDate || dtToStr(new Date());
        document.getElementById('job-end').value = selectedDate || dtToStr(new Date());
        document.getElementById('job-total-h').value = "";
        document.getElementById('job-memo').value = ""; // ãƒ¡ãƒ¢ã‚’ç©ºã«
    } 
    document.getElementById('job-modal-overlay').style.display = 'flex'; 
}

function openShiftModal() {
    // æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ or åŸºæœ¬è¨­å®šã‚’å–å¾—
    const s = (selectedDate && appData.singleShifts[selectedDate]) ? appData.singleShifts[selectedDate] : appData.defShift;
    
    // å„å…¥åŠ›æ¬„ã«å€¤ã‚’ã‚»ãƒƒãƒˆ
    document.getElementById('set-shift-start').value = indexToTime(s.start);
    document.getElementById('set-shift-end').value = indexToTime(s.end);
    document.getElementById('set-commute-h').value = s.commuteH || 0;
    document.getElementById('set-commute-m').value = s.commuteM || 0;
    document.getElementById('set-break-start').value = s.breakStart || "12:00";
    document.getElementById('set-break-end').value = s.breakEnd || "13:00";

    document.getElementById('batch-shift-area').className = selectedDate ? 'hidden' : '';
    document.getElementById('save-day-shift-btn').className = selectedDate ? 'save-btn' : 'hidden';
    document.getElementById('shift-modal-overlay').style.display='flex';
}

function saveDayShift() {
    appData.singleShifts[selectedDate] = {
        start: timeToIndex(document.getElementById('set-shift-start').value),
        end: timeToIndex(document.getElementById('set-shift-end').value),
        commuteH: parseInt(document.getElementById('set-commute-h').value) || 0,
        commuteM: parseInt(document.getElementById('set-commute-m').value) || 0,
        breakStart: document.getElementById('set-break-start').value,
        breakEnd: document.getElementById('set-break-end').value
    };
    saveDataAndRefresh();
    closeModal('shift-modal-overlay');
}

function saveDefShift() {
    appData.defShift = {
        start: timeToIndex(document.getElementById('set-shift-start').value),
        end: timeToIndex(document.getElementById('set-shift-end').value),
        commuteH: parseInt(document.getElementById('set-commute-h').value) || 0,
        commuteM: parseInt(document.getElementById('set-commute-m').value) || 0,
        breakStart: document.getElementById('set-break-start').value,
        breakEnd: document.getElementById('set-break-end').value
    };
    saveData();
    alert("åŸºæœ¬è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ");
}

function openJobMenuModal() {
    document.getElementById('job-menu-overlay').style.display = 'flex';
}

function executeMonthlyReset() {
    const y = currentViewDate.getFullYear(), m = String(currentViewDate.getMonth() + 1).padStart(2, '0');
    const prefix = `${y}-${m}`;
    
    // ãƒ‡ãƒ¼ã‚¿ã‚’æ¶ˆã™
    Object.keys(appData.tasks).forEach(d => { if(d.startsWith(prefix)) delete appData.tasks[d]; });
    Object.keys(appData.singleShifts).forEach(d => { if(d.startsWith(prefix)) delete appData.singleShifts[d]; });
    
    // ä¿å­˜ã™ã‚‹
    saveData(); 

    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
    closeModal('reset-modal-overlay');

    // â˜…ã€ã“ã“ãŒé‡è¦ã€‘åˆ¤å®šã‚’ç„¡è¦–ã—ã¦ã€å…¨éƒ¨å¼·åˆ¶çš„ã«æãç›´ã™ï¼
    renderCalendar();  // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’æ›´æ–°
    renderTimeline();  // ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã‚’æ›´æ–°ï¼ˆã“ã‚Œã§äºˆå®šãŒæ¶ˆãˆã‚‹ï¼ï¼‰
    updateFreeTime();  // ç©ºãæ™‚é–“è¡¨ç¤ºã‚‚æ›´æ–°
}

function renderCalendar() {
Â  Â  const grid = document.getElementById('calendar-grid'); grid.innerHTML = "";
Â  Â  const y = currentViewDate.getFullYear(), m = currentViewDate.getMonth();
Â  Â  const holidays = holidayData;
Â  Â  document.getElementById('view-title').textContent = `${y}å¹´ ${m + 1}æœˆ`;
Â  Â  const firstDay = new Date(y, m, 1).getDay(), lastDate = new Date(y, m + 1, 0).getDate();
Â  Â  for(let i=0; i<firstDay; i++) grid.appendChild(document.createElement('div'));
Â  Â  for (let i = 1; i <= lastDate; i++) {
Â  Â  Â  Â  const dStr = `${y}-${String(m+1).padStart(2,'0')}-${String(i).padStart(2,'0')}`;
Â  Â  Â  Â  const day = document.createElement('div'); day.className = 'calendar-day';
Â  Â  Â  Â  if(inputMode === 'shift') day.classList.add('shift-mode-active');
Â  Â  Â  Â  if(dStr === dtToStr(new Date())) day.classList.add('is-today');
Â  Â  Â  Â  let html = "";
Â  Â  Â  Â  if(holidays[dStr]) { day.classList.add('is-holiday'); html += `<div class="holiday-name">${holidays[dStr]}</div>`; }
Â  Â  Â  Â  html += `<div class="day-num">${i}</div>`;
Â  Â  Â  Â  let displayItems = [];
Â  Â  Â  Â  if (appData.singleShifts[dStr]) displayItems.push(`<div class="job-band shift-band">å‹¤:${indexToTime(appData.singleShifts[dStr].start)}</div>`);
Â  Â  Â  Â  (appData.longTermJobs || []).filter(j => isJobVisibleOnDate(j, dStr)).forEach(j => displayItems.push(`<div class="job-band ${j.isDeleted?'deleted':''}">${j.name}</div>`));
Â  Â  Â  Â  displayItems.slice(0, 2).forEach(item => html += item);
Â  Â  Â  Â  if(displayItems.length > 2) html += `<div style="font-size:8px;color:#888;text-align:right">ä»–${displayItems.length-2}ä»¶</div>`;
Â  Â  Â  Â  day.innerHTML = html;
Â  Â  Â  Â  day.onclick = () => { if(inputMode==='shift'){ if(appData.singleShifts[dStr]) delete appData.singleShifts[dStr]; else appData.singleShifts[dStr]={...appData.defShift}; saveData(); renderCalendar(); } else showDay(dStr); };
Â  Â  Â  Â  grid.appendChild(day);
Â  Â  }
}

// --- 1. äºˆå®šã‚’å‹•ã‹ã—å§‹ã‚ã‚‹é–¢æ•° (clientYç‰ˆ) ---
function startDrag(t, e) {
    isDragging = true;
    activeTaskId = t.id;
    const event = e.touches ? e.touches[0] : e;
    const tlRect = document.getElementById('timeline').getBoundingClientRect();
    const relY = event.clientY - tlRect.top;

    const taskBottomY = (t.start + t.length) * 20;
    // ãƒ–ãƒ­ãƒƒã‚¯ã®ä¸‹ç«¯10pxä»¥å†…ã‚’æ´ã‚“ã ã‚‰ã€Œãƒªã‚µã‚¤ã‚ºãƒ¢ãƒ¼ãƒ‰ã€
    if (Math.abs(taskBottomY - relY) <= 10) {
        dragMode = 'resize';
    } else {
        dragMode = 'move';
        // ç§»å‹•ã®æ™‚ã¯ã€Œã©ã®ä½ç½®ã‚’æ´ã‚“ã ã‹ã€ã®ã‚ªãƒ•ã‚»ãƒƒãƒˆã‚’è¨˜éŒ²
        moveOffset = Math.floor((relY - (t.start * 20)) / 20);
    }
}

// --- 2. ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã‚’æç”»ã™ã‚‹é–¢æ•° (æ•´ç†æ¸ˆã¿æ±ºå®šç‰ˆ) ---
function renderTimeline() {
    const tl = document.getElementById("timeline");
    if (!tl) return;
    
    tl.innerHTML = ""; // ä¸€æ—¦ãƒªã‚»ãƒƒãƒˆ
    const tasks = appData.tasks[selectedDate] || [];
    const shift = appData.singleShifts[selectedDate] || appData.defShift;
    const sleep = appData.singleSleeps[selectedDate] || appData.defSleep;

    const commuteIdx = (shift.commuteH || 0) * 4 + Math.floor((shift.commuteM || 0) / 15);
    const breakS = timeToIndex(shift.breakStart || "12:00");
    const breakE = timeToIndex(shift.breakEnd || "13:00");

    // 96å€‹ï¼ˆ24æ™‚é–“åˆ†ï¼‰ã®ãƒã‚¹ã‚’ç”Ÿæˆ
    for (let i = 0; i < 96; i++) {
        const slot = document.createElement("div");
        slot.className = "time-slot";
        slot.dataset.idx = i;
        
        // CSSã§ã¯ãªãJSã§ç¢ºå®Ÿã«é«˜ã•ã‚’æŒ‡å®š
        slot.style.position = "absolute";
        slot.style.top = (i * 20) + "px";
        slot.style.height = "20px";
        slot.style.width = "100%";
        slot.style.borderBottom = "1px solid #eee";
        slot.style.boxSizing = "border-box";

        // æ™‚åˆ»ãƒ©ãƒ™ãƒ«
        // 1æ™‚é–“ã”ã¨ã«æ™‚åˆ»ãƒ©ãƒ™ãƒ«ã‚’è¡¨ç¤º
        if (i % 4 === 0) {
            const label = document.createElement("div");
            label.className = "time-label";
            label.style.position = "absolute";
            label.style.left = "-50px"; // â˜…æ ã®å·¦å´ã«50pxã¯ã¿å‡ºã•ã›ã‚‹
            label.style.width = "45px";
            label.style.textAlign = "right";
            label.style.fontSize = "12px";
            label.style.color = "#888";
            label.style.fontWeight = "bold";
            label.textContent = Math.floor(i / 4) + ":00";
            slot.appendChild(label); // slotã®ä¸­ã«å…¥ã‚Œã¦ã‚‚ position:absolute ãªã®ã§å·¦ã«é£›ã³å‡ºã—ã¾ã™
        }

        // --- èƒŒæ™¯è‰²åˆ¤å®š ---
        
        // ç¡çœ ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šï¼ˆdefSleepï¼‰ãŒã‚ã£ã¦ã‚‚è‰¯ã„ã®ã§ãã®ã¾ã¾
        const isSleep = (sleep.start < sleep.end) ? (i >= sleep.start && i < sleep.end) : (i >= sleep.start || i < sleep.end);
        
        // â˜… ã“ã“ã‚’ä¿®æ­£ï¼šãã®æ—¥å°‚ç”¨ã®ã‚·ãƒ•ãƒˆãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
        const hasTodayShift = appData.singleShifts[selectedDate]; 
        
        // hasTodayShift ãŒå­˜åœ¨ã™ã‚‹ã¨ãã ã‘åˆ¤å®šã‚’æœ‰åŠ¹ã«ã™ã‚‹
        const isWork = (hasTodayShift && i >= shift.start && i < shift.end);
        const isCommute = (hasTodayShift && ((i >= shift.start - commuteIdx && i < shift.start) || (i >= shift.end && i < shift.end + commuteIdx)));
        const isBreak = (hasTodayShift && i >= breakS && i < breakE && isWork);

        if (isSleep) slot.classList.add("fixed-busy");
        else if (isBreak) slot.classList.add("break-busy");
        else if (isWork) slot.classList.add("shift-busy");
        else if (isCommute) slot.classList.add("commute-busy");

        // --- äºˆå®šãƒ–ãƒ­ãƒƒã‚¯ã®æç”» ---
        const t = tasks.find(x => i === x.start);
        if (t) {
            const el = document.createElement("div"); 
            el.className = "custom-task"; 
            el.style.backgroundColor = t.color; 
            el.style.height = (t.length * 20 - 1) + "px";
            el.style.position = "absolute";
            el.style.top = "0"; el.style.left = "0"; el.style.right = "0";
            el.style.zIndex = "10";
            el.style.display = "flex"; el.style.alignItems = "center"; el.style.justifyContent = "space-between";
            el.style.padding = "0 4px"; el.style.boxSizing = "border-box"; el.style.borderRadius = "4px";

            // ãƒ†ã‚­ã‚¹ãƒˆï¼ˆåå‰ãƒ»æ™‚é–“ï¼‰
            const txt = document.createElement("span");
            txt.style.cssText = "flex:1; overflow:hidden; white-space:nowrap; pointer-events:none; display:flex; flex-direction:column; line-height:1.1;";
            const totalMin = t.length * 15;
            const timeStr = totalMin >= 60 ? `${Math.floor(totalMin/60)}h${totalMin%60}m` : `${totalMin}m`;
            txt.innerHTML = `<b style="font-size:10px;">${t.name}</b><span style="font-size:8px; opacity:0.9;">${timeStr}</span>`;
            el.appendChild(txt);

            // ãƒœã‚¿ãƒ³
            const btnGroup = document.createElement('div');
            btnGroup.style.display = "flex"; btnGroup.style.gap = "2px";

            // âœï¸ãƒœã‚¿ãƒ³
            const eb = document.createElement('button');
            eb.className = 'del-btn-mini'; eb.innerHTML = 'âœï¸';
            eb.onclick = (e) => {
                e.preventDefault(); e.stopPropagation();
                activeTaskId = t.id;
                document.getElementById('task-name').value = t.name;
                selectedColor = t.color;
                tempRange = { start: t.start, length: t.length }; 
                document.getElementById('modal-overlay').style.display = 'flex';
            };

            // Ã—ãƒœã‚¿ãƒ³
            const db = document.createElement('button');
            db.className = 'del-btn-mini'; db.innerHTML = 'Ã—';
            db.onclick = (e) => {
                e.preventDefault(); e.stopPropagation();
                activeTaskId = t.id;
                document.getElementById('edit-info').textContent = t.name;
                document.getElementById('edit-modal-overlay').style.display = 'flex';
            };

            btnGroup.appendChild(eb);
            btnGroup.appendChild(db);
            el.appendChild(btnGroup);

            // ãƒ‰ãƒ©ãƒƒã‚°é–‹å§‹
            const startDragCheck = (e) => {
                if (e.target.closest('button')) return;
                e.stopPropagation();
                startDrag(t, e);
            };
            el.onmousedown = startDragCheck;
            el.ontouchstart = (e) => { if(!e.target.closest('button')) startDragCheck(e); };

            slot.appendChild(el);
        }

       // æ–°è¦ä½œæˆç”¨ã®ã‚¤ãƒ™ãƒ³ãƒˆ
        slot.addEventListener('mousedown', (e) => {
            if(e.target.closest('.custom-task')) return;
            isDragging = true; 
            dragMode = 'create'; 
            // datasetã‹ã‚‰ç¢ºå®Ÿã«ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’å–å¾—
            startIdx = parseInt(slot.dataset.idx); 
            lastTouchY = e.clientY;
            updateDragDisplay();
        });

        slot.addEventListener('touchstart', (e) => {
    if(e.target.closest('.custom-task')) return;

    // é–‹å§‹ä½ç½®ã‚’è¨˜éŒ²ï¼ˆã‚ã¨ã§ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«åˆ¤å®šã«ä½¿ã†ï¼‰
    const touch = e.touches[0];
    touchStartX = touch.clientX;
    touchStartY = touch.clientY;
    longPressed = false;

    // 0.5ç§’ã®ã‚¿ã‚¤ãƒãƒ¼ã‚’é–‹å§‹
    touchTimer = setTimeout(() => {
        longPressed = true;
        isDragging = true; 
        dragMode = 'create'; 
        startIdx = parseInt(slot.dataset.idx); 
        lastTouchY = touch.clientY;
        
        // æˆåŠŸã—ãŸã‚‰å°‘ã—ãƒã‚¤ãƒ–ï¼ˆã‚¹ãƒãƒ›ã ã¨åˆ†ã‹ã‚Šã‚„ã™ã„ï¼ï¼‰
        if (navigator.vibrate) navigator.vibrate(50);
        
        updateDragDisplay();
    }, 500); 
}, {passive: false});

        tl.appendChild(slot);
    }
    updateFreeTime();
}
// --- 3. ãƒ‰ãƒ©ãƒƒã‚°ä¸­ã®ç§»å‹•ã‚’å‡¦ç†ã™ã‚‹é–¢æ•° ---
function handleMove(e) {
    const event = e.touches ? e.touches[0] : e;
    
    // ã¾ã é•·æŠ¼ã—ãŒç¢ºå®šã—ã¦ã„ãªã„å ´åˆ
    if (!longPressed && e.touches) {
        // æŒ‡ãŒ10pxä»¥ä¸Šå‹•ã„ãŸã‚‰ã€Œã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã—ãŸã„ã‚“ã ãªã€ã¨åˆ¤æ–­ã—ã¦ã‚¿ã‚¤ãƒãƒ¼è§£é™¤
        const moveX = Math.abs(event.clientX - touchStartX);
        const moveY = Math.abs(event.clientY - touchStartY);
        if (moveX > 10 || moveY > 10) {
            clearTimeout(touchTimer);
        }
        return; // ä½œæˆå‡¦ç†ã«ã¯é€²ã¾ãªã„
    }

    // é•·æŠ¼ã—ç¢ºå®šå¾Œï¼ˆisDraggingä¸­ï¼‰ã®å‡¦ç†
    if (!isDragging) return;
    if (e.cancelable) e.preventDefault(); // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’å®Œå…¨ã«æ­¢ã‚ã‚‹

    lastTouchY = event.clientY;
    
    // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«åˆ¤å®šï¼ˆç”»é¢ç«¯ã§ã®è‡ªå‹•ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ï¼‰
    if (lastTouchY < 50) startAutoScroll(-10);
    else if (lastTouchY > window.innerHeight - 50) startAutoScroll(10);
    else stopAutoScroll();

    updateDragDisplay();
}

function updateDragDisplay() {
    if (!isDragging) return;
    
    const tl = document.getElementById('timeline');
    const tlRect = tl.getBoundingClientRect();
    const relativeY = lastTouchY - tlRect.top;
    let i = Math.floor(relativeY / 20);
    i = Math.max(0, Math.min(95, i));

    // â˜… ã“ã“ã‚’ä¿®æ­£ï¼šmove ã‹ resize ã®æ™‚ã ã‘ã‚¿ã‚¹ã‚¯ã‚’æ¢ã™
    let t = null;
    if (dragMode === 'move' || dragMode === 'resize') {
        t = (appData.tasks[selectedDate] || []).find(x => x.id === activeTaskId);
    }

    if (dragMode === 'create') {
        const [min, max] = [startIdx, i].sort((a, b) => a - b);
        updateGuide(min, max);
    } 
    else if (dragMode === 'move') {
        if (!t) return; // ã‚¿ã‚¹ã‚¯ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯ä½•ã‚‚ã—ãªã„
        let ns = Math.max(0, Math.min(96 - t.length, i - moveOffset));
        showPreview(ns, t.length, t.color);
    } 
    else if (dragMode === 'resize') {
        if (!t) return; // ã‚¿ã‚¹ã‚¯ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯ä½•ã‚‚ã—ãªã„
        let newLen = Math.max(1, i - t.start + 1); 
        newLen = Math.min(96 - t.start, newLen); 
        showPreview(t.start, newLen, t.color);
    }
}

// ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤ºç”¨ã®å…±é€šãƒ‘ãƒ¼ãƒ„ï¼ˆé‡è¤‡ã‚’æ¸›ã‚‰ã™ãŸã‚ï¼‰
function showPreview(start, len, color) {
    document.querySelectorAll('.move-preview').forEach(x => x.remove());
    const pre = document.createElement('div');
    pre.className = "custom-task move-preview";
    pre.style.backgroundColor = color;
    pre.style.top = `${start * 20}px`;
    pre.style.height = `${len * 20 - 1}px`;
    pre.dataset.ns = start;
    pre.dataset.nl = len; // æ–°ã—ã„é•·ã•ã‚‚ä¿æŒ
    document.getElementById('timeline').appendChild(pre);
}


// --- ã‚ªãƒ¼ãƒˆã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«é–¢é€£ ---
function startAutoScroll(speed) { 
    if (scrollInterval) return; 
    scrollInterval = setInterval(() => { 
        window.scrollBy(0, speed); 
        // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä¸­ã‚‚ãƒã‚¦ã‚¹ä½ç½®ã¨æ ã®é–¢ä¿‚ã‚’å†è¨ˆç®—ã—ã¦ã‚ºãƒ¬ã‚’é˜²ã
        updateDragDisplay(); 
    }, 20); 
}

function stopAutoScroll() { 
    if (scrollInterval) { 
        clearInterval(scrollInterval); 
        scrollInterval = null; 
    } 
}

// --- ãƒ‰ãƒ©ãƒƒã‚°çµ‚äº†æ™‚ã®å‡¦ç†ï¼ˆã“ã“ã‚’ä¸¸ã”ã¨å·®ã—æ›¿ãˆï¼‰ ---
const stopDrag = () => {
    stopAutoScroll();
    if (!isDragging) return;

    const pre = document.querySelector('.move-preview');
    const t = appData.tasks[selectedDate]?.find(x => x.id === activeTaskId);

    if (pre && t) {
        if (dragMode === 'move') {
            t.start = parseInt(pre.dataset.ns);
        } else if (dragMode === 'resize') {
            t.length = parseInt(pre.dataset.nl);
        }
        saveData();
    } else if (dragMode === 'create') {
        const g = document.getElementById('drag-guide');
        if (!g.classList.contains('hidden')) {
            const top = parseInt(g.style.top);
            const height = parseInt(g.style.height);
            tempRange = { start: Math.round(top / 20), length: Math.round(height / 20) };
            document.getElementById('task-name').value = "";
            document.getElementById('modal-overlay').style.display = 'flex';
        }
    }

    isDragging = false;
    dragMode = null;
    document.querySelectorAll('.move-preview').forEach(x => x.remove());
    document.getElementById('drag-guide').classList.add('hidden');
    renderTimeline(); // å¤‰æ›´ã‚’åæ˜ 
};

function updateGuide(min, max) {
    const guide = document.getElementById('drag-guide');
    guide.classList.remove('hidden');
    // é–‹å§‹ä½ç½®(min) Ã— 20px
    guide.style.top = `${min * 20}px`;
    // (çµ‚äº†-é–‹å§‹+1) Ã— 20px
    guide.style.height = `${(max - min + 1) * 20}px`;
    
    const totalMinutes = (max - min + 1) * 15;
    const h = Math.floor(totalMinutes / 60);
    const m = totalMinutes % 60;
    guide.textContent = h > 0 ? `${h}æ™‚${m}åˆ†` : `${m}åˆ†`;
}

function updateJobArea() { const area = document.getElementById('day-jobs-area'); area.innerHTML = ""; (appData.longTermJobs || []).filter(j => isJobVisibleOnDate(j, selectedDate)).forEach(j => { const div = document.createElement('div'); div.className = `job-card ${j.isCompleted ? 'completed' : ''} ${j.isDeleted ? 'deleted' : ''}`; div.innerHTML = `<div style="display:flex; justify-content:space-between;"><b>${j.name}</b> <small>è¨ˆ:${j.totalH}h</small></div><div class="job-card-row">é€²æ—: <input type="number" class="progress-input" value="${j.progress}" onchange="updateProgress(${j.id}, this.value)" ${j.isDeleted || j.isCompleted ? 'disabled' : ''}> %<div><button class="mini-btn" onclick="openJobModal(${j.id})">ç·¨é›†</button><button class="mini-btn" onclick="deleteJob(${j.id})">${j.isDeleted?'å¾©å…ƒ':'å‰Šé™¤'}</button><button class="mini-btn" onclick="completeJob(${j.id})">${j.isCompleted?'æˆ»ã™':'å®Œäº†'}</button></div></div>`; area.appendChild(div); }); }

function updateProgress(id, v) { let val = Math.max(0, Math.min(100, parseInt(v)||0)); appData.longTermJobs.find(x=>x.id===id).progress = val; saveDataAndRefresh(); }
function completeJob(id) {
    const job = appData.longTermJobs.find(j => j.id === id);
    if (!job) return;

    job.isCompleted = !job.isCompleted;

    // å®Œäº†ã—ãŸæ—¥ã®æ—¥ä»˜ã‚’è¨˜éŒ²ã™ã‚‹
    if (job.isCompleted) {
        job.completedDate = selectedDate;
    } else {
        delete job.completedDate;
    }

    saveData();
    updateJobArea();
    updateFreeTime();
    renderCalendar();
}


function deleteJob(id) {
    const job = appData.longTermJobs.find(j => j.id === id);
    if (!job) return;

    job.isDeleted = !job.isDeleted;
    
    // å‰Šé™¤ã—ãŸæ—¥ã®æ—¥ä»˜ã‚’è¨˜éŒ²ã™ã‚‹ï¼ˆå¾©æ´»ã•ã›ãŸã¨ãã¯æ¶ˆã™ï¼‰
    if (job.isDeleted) {
        job.deletedDate = selectedDate; 
    } else {
        delete job.deletedDate;
    }

    saveData();
    updateJobArea();
    updateFreeTime();
    renderCalendar(); // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®è¡¨ç¤ºã‚‚æ›´æ–°
}

function openSleepModal() { const s = (selectedDate && appData.singleSleeps[selectedDate]) ? appData.singleSleeps[selectedDate] : appData.defSleep; document.getElementById('sleep-start').value = indexToTime(s.start); document.getElementById('sleep-end').value = indexToTime(s.end); document.getElementById('batch-sleep-area').className = selectedDate ? 'hidden' : ''; document.getElementById('save-day-sleep-btn').className = selectedDate ? 'save-btn' : 'hidden'; document.getElementById('sleep-modal-overlay').style.display='flex'; }
function openShiftModal() { const s = (selectedDate && appData.singleShifts[selectedDate]) ? appData.singleShifts[selectedDate] : appData.defShift; document.getElementById('set-shift-start').value = indexToTime(s.start); document.getElementById('set-shift-end').value = indexToTime(s.end); document.getElementById('batch-shift-area').className = selectedDate ? 'hidden' : ''; document.getElementById('save-day-shift-btn').className = selectedDate ? 'save-btn' : 'hidden'; document.getElementById('shift-modal-overlay').style.display='flex'; }

function openJumpModal() { const ys = document.getElementById('jump-year'), ms = document.getElementById('jump-month'); ys.innerHTML = ""; ms.innerHTML = ""; const curY = new Date().getFullYear(); for(let y=curY-1; y<=curY+3; y++) ys.innerHTML += `<option value="${y}" ${y==currentViewDate.getFullYear()?'selected':''}>${y}å¹´</option>`; for(let m=0; m<12; m++) ms.innerHTML += `<option value="${m}" ${m==currentViewDate.getMonth()?'selected':''}>${m+1}æœˆ</option>`; document.getElementById('jump-modal-overlay').style.display='flex'; }
function jumpToMonth() { currentViewDate.setFullYear(document.getElementById('jump-year').value); currentViewDate.setMonth(document.getElementById('jump-month').value); renderCalendar(); closeModal('jump-modal-overlay'); }
function closeModal(id) {
    // æŒ‡å®šã•ã‚ŒãŸã‚‚ã®ï¼ˆæ–°è¦ç™»éŒ²ç”»é¢ãªã©ï¼‰ã ã‘ã‚’ãƒ”ãƒ³ãƒã‚¤ãƒ³ãƒˆã§æ¶ˆã™
    const target = document.getElementById(id);
    if (target) {
        target.style.display = 'none';
    }
    // ã“ã“ã§å…¨éƒ¨ã‚’æ¶ˆã•ãªã„ï¼ˆæ¡ˆä»¶ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãŒè£ã«ã‚ã‚Œã°ã€ãã®ã¾ã¾æ®‹ã‚‹ï¼‰
}

function checkConflict(s, l, id, shift, sleep) {
    if (!sleep) sleep = appData.defSleep;
    if (!shift) shift = appData.defShift;

    // ç¡çœ ã¨ã®é‡ãªã‚Šãƒã‚§ãƒƒã‚¯
    const isSleep = (sleep.start < sleep.end) 
        ? (s < sleep.end && s + l > sleep.start) 
        : (s + l > sleep.start || s < sleep.end);
    if (isSleep) return true;

    // ã‚·ãƒ•ãƒˆï¼ˆä»•äº‹ï¼‰ã¨ã®é‡ãªã‚Šãƒã‚§ãƒƒã‚¯
    const breakS = timeToIndex(shift.breakStart || "12:00");
    const breakE = timeToIndex(shift.breakEnd || "13:00");
    
    for (let i = s; i < s + l; i++) {
        const isWorkHour = (i >= shift.start && i < shift.end);
        const isBreakHour = (i >= breakS && i < breakE);
        // ä»•äº‹ä¸­ã‹ã¤ä¼‘æ†©ã˜ã‚ƒãªã„æ™‚é–“ã¯ãƒ€ãƒ¡
        if (isWorkHour && !isBreakHour) return true; 
    }

    // ä»–ã®äºˆå®šã¨ã®é‡ãªã‚Šãƒã‚§ãƒƒã‚¯
    return (appData.tasks[selectedDate] || []).some(t => {
        if (t.id === id) return false;
        // å®Œå…¨ã«é‡ãªã£ã¦ã„ã‚‹å ´åˆã®ã¿NGã¨ã™ã‚‹ï¼ˆs+lãŒt.startã¨åŒã˜ãªã‚‰OKï¼‰
        return s < t.start + t.length && s + l > t.start;
    });


// ãƒã‚¦ã‚¹ã‚’é›¢ã—ãŸæ™‚ï¼ˆPCï¼‰
document.addEventListener('mouseup', handleEnd);

// æŒ‡ãŒé›¢ã‚ŒãŸæ™‚ï¼ˆã‚¹ãƒãƒ›ï¼‰
// touchcancelã¯ã€æ“ä½œä¸­ã«ã‚¢ãƒ©ãƒ¼ãƒ ãŒé³´ã£ãŸã‚Šç”»é¢ãŒåˆ‡ã‚Šæ›¿ã‚ã£ãŸã‚Šã—ãŸæ™‚ã®ãŸã‚ã®ã€Œä¸­æ–­ã€å‡¦ç†ã§ã™
document.addEventListener('touchend', handleEnd, { passive: false });
document.addEventListener('touchcancel', handleEnd, { passive: false });



}


// æŒ‡ã‚’é›¢ã—ãŸã¨ãï¼ˆmouseup / touchendï¼‰ã«å‘¼ã¶å…±é€šå‡¦ç†
function handleEnd() {
    clearTimeout(touchTimer); // ã“ã‚ŒãŒå¤§äº‹
    if (!isDragging) return;

    if (dragMode === 'create') {
        const guide = document.getElementById('drag-guide');
        if (!guide.classList.contains('hidden')) {
            // ã‚¬ã‚¤ãƒ‰ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ç¯„å›²ã‚’ãã®ã¾ã¾äºˆå®šã«ã™ã‚‹
            // ã‚¬ã‚¤ãƒ‰ã® top / height ã‹ã‚‰é€†ç®—ã™ã‚‹ã®ãŒæœ€ã‚‚ç¢ºå®Ÿã§ã™
            const top = parseInt(guide.style.top);
            const height = parseInt(guide.style.height);
            
            tempRange = {
                start: Math.round(top / 20),
                length: Math.round(height / 20)
            };
            
            // å…¥åŠ›ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’è¡¨ç¤º
            document.getElementById('task-name').value = "";
            document.getElementById('modal-overlay').style.display = 'flex';
        }
    } else if (dragMode === 'move') {
        const pre = document.querySelector('.move-preview');
        if (pre) {
            const ns = parseInt(pre.dataset.ns);
            const t = appData.tasks[selectedDate].find(x => x.id === activeTaskId);
            if (t) {
                t.start = ns;
                saveData();
                renderTimeline();
            }
        }
    }

    // 4. å¾Œç‰‡ä»˜ã‘
    isDragging = false;
    longPressed = false;
    dragMode = null;
    stopAutoScroll();


    document.getElementById('drag-guide').classList.add('hidden');
    document.querySelectorAll('.move-preview').forEach(x => x.remove());
}



function updateFreeTime() {
    const shift = appData.singleShifts[selectedDate],
          sleep = appData.singleSleeps[selectedDate] || appData.defSleep;
    
    let busyIdx = 0;
    let busySlots = new Array(96).fill(false);

    for(let i=0; i<96; i++) {
        // 1. ç¡çœ åˆ¤å®š
        const isSleep = (sleep.start < sleep.end) 
            ? (i >= sleep.start && i < sleep.end) 
            : (i >= sleep.start || i < sleep.end);
        
        let isWorkRelated = false;
        if (shift) {
            // ã‚·ãƒ•ãƒˆè¨­å®šã‹ã‚‰å„å€¤ã‚’å–å¾—ï¼ˆä¿å­˜ã•ã‚Œã¦ã„ã‚‹ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£åã«åˆã‚ã›ã¦èª¿æ•´ã—ã¦ãã ã•ã„ï¼‰
            // 1ã‚³ãƒ15åˆ†ãªã®ã§ã€åˆ†ã‚’15ã§å‰²ã£ã¦ã‚³ãƒæ•°ã«å¤‰æ›
            const commuteSlots = Math.ceil((shift.commuteM || 0) / 15) + ((shift.commuteH || 0) * 4);
            
            // å‹¤å‹™æœ¬ä½“
            const isShiftBody = (i >= shift.start && i < shift.end);
            // é€šå‹¤ï¼ˆå¾€è·¯ï¼šé–‹å§‹å‰ã€å¾©è·¯ï¼šçµ‚äº†å¾Œï¼‰
            const isCommute = (i >= shift.start - commuteSlots && i < shift.start) || 
                              (i >= shift.end && i < shift.end + commuteSlots);
            // æ˜¼ä¼‘ã¿ï¼ˆè¨­å®šã•ã‚ŒãŸé–‹å§‹ãƒ»çµ‚äº†ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ä½¿ç”¨ï¼‰
            const isBreak = (shift.breakStart !== undefined && i >= shift.breakStart && i < shift.breakEnd);

            if (isShiftBody || isCommute || isBreak) {
                isWorkRelated = true;
            }
        }

        if(isSleep || isWorkRelated) {
            busyIdx++;
            busySlots[i] = true; 
        }
    }

    // 2. äºˆå®šãƒ–ãƒ­ãƒƒã‚¯ï¼ˆtasksï¼‰ã®é‡ãªã‚Šãƒã‚§ãƒƒã‚¯
    (appData.tasks[selectedDate] || []).forEach(t => {
        for(let i = t.start; i < t.start + t.length; i++) {
            if (!busySlots[i]) {
                busyIdx++;
                busySlots[i] = true; 
            }
        }
    });
let jobH = 0;
    (appData.longTermJobs || [])
        .filter(j => isJobVisibleOnDate(j, selectedDate))
        .filter(j => !j.isDeleted && !j.isCompleted) // â˜…ã“ã“ã‚’è¿½åŠ ï¼å‰Šé™¤æ¸ˆã¨å®Œäº†æ¸ˆã‚’é™¤å¤–
        .forEach(j => {
            const totalDays = Math.max(1, (new Date(j.end) - new Date(j.start)) / 86400000 + 1);
            jobH += (j.totalH * (1 - j.progress/100)) / Math.max(1, totalDays);
        }); 

const freeMin = (96 - busyIdx) * 15 - (jobH * 60); document.getElementById('freeTime').innerHTML = `è‡ªç”±æ™‚é–“: ${Math.floor(Math.max(0, freeMin)/60)}h ${Math.floor(Math.max(0, freeMin)%60)}m<br><small>æ¡ˆä»¶ãƒãƒ«ãƒ: ç´„ ${jobH.toFixed(1)}h/æ—¥</small>`; }



function saveDataAndRefresh() { saveData(); if(selectedDate) { updateJobArea(); renderTimeline(); } else renderCalendar(); }




function showDay(d) { selectedDate = d; document.getElementById('current-day-label').textContent = d; document.getElementById('calendar-screen').classList.add('hidden'); document.getElementById('day-screen').classList.remove('hidden'); document.getElementById('back-to-cal-btn').classList.remove('hidden'); document.getElementById('mode-selector').classList.add('hidden'); renderTimeline(); updateJobArea(); }
function showCalendar() { selectedDate = ""; document.getElementById('calendar-screen').classList.remove('hidden'); document.getElementById('day-screen').classList.add('hidden'); document.getElementById('back-to-cal-btn').classList.add('hidden'); document.getElementById('mode-selector').classList.remove('hidden'); renderCalendar(); }
function setAppMode(m) { inputMode = m; document.getElementById('mode-normal-btn').className = 'mode-btn' + (m==='normal'?' active':''); document.getElementById('mode-shift-btn').className = 'mode-btn' + (m==='shift'?' shift-active':''); renderCalendar(); }
function changeMonth(diff) {
Â  Â  currentViewDate.setMonth(currentViewDate.getMonth() + diff);
Â  Â  fetchHolidays(); // ã“ã“ã‚‚ renderCalendar ã‹ã‚‰ fetchHolidays ã«å¤‰æ›´
}

function saveTask() {
    const name = document.getElementById('task-name').value.trim() || "äºˆå®š";  
    if (activeTaskId) {
        // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰
        const task = appData.tasks[selectedDate].find(x => x.id === activeTaskId);
        if (task) {
            task.name = name;
            task.color = selectedColor; // é¸æŠä¸­ã®è‰²ã‚’åæ˜ 
        }

    } else {

        // æ–°è¦ä½œæˆãƒ¢ãƒ¼ãƒ‰
        if (!appData.tasks[selectedDate]) appData.tasks[selectedDate] = [];
        appData.tasks[selectedDate].push({
            id: Date.now(),
            name,
            start: tempRange.start,
            length: tempRange.length,
            color: selectedColor

        });

    }
    activeTaskId = null; // IDã‚’ãƒªã‚»ãƒƒãƒˆ
    document.getElementById('task-name').value = "";
    saveDataAndRefresh();
    document.getElementById('modal-overlay').style.display = 'none';

}


function deleteTask() {
    if (!appData.tasks[selectedDate]) return;
    appData.tasks[selectedDate] = appData.tasks[selectedDate].filter(x => x.id !== activeTaskId);
    saveDataAndRefresh();
    closeModal('edit-modal-overlay');
}

function saveDaySleep() { appData.singleSleeps[selectedDate] = { start: timeToIndex(document.getElementById('sleep-start').value), end: timeToIndex(document.getElementById('sleep-end').value) }; saveDataAndRefresh(); closeModal('sleep-modal-overlay'); }
function saveDefSleep() { appData.defSleep = { start: timeToIndex(document.getElementById('sleep-start').value), end: timeToIndex(document.getElementById('sleep-end').value) }; saveData(); alert("åŸºæœ¬è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ"); }


function saveDayShift() {
    appData.singleShifts[selectedDate] = {
        start: timeToIndex(document.getElementById('set-shift-start').value),
        end: timeToIndex(document.getElementById('set-shift-end').value),
        commuteH: parseInt(document.getElementById('set-commute-h').value) || 0,
        commuteM: parseInt(document.getElementById('set-commute-m').value) || 0,
        breakStart: document.getElementById('set-break-start').value,
        breakEnd: document.getElementById('set-break-end').value
    };
    saveDataAndRefresh();
    closeModal('shift-modal-overlay');
}

function saveDefShift() {
    appData.defShift = {
        start: timeToIndex(document.getElementById('set-shift-start').value),
        end: timeToIndex(document.getElementById('set-shift-end').value),
        commuteH: parseInt(document.getElementById('set-commute-h').value) || 0,
        commuteM: parseInt(document.getElementById('set-commute-m').value) || 0,
        breakStart: document.getElementById('set-break-start').value,
        breakEnd: document.getElementById('set-break-end').value
    };
    saveData();
    alert("åŸºæœ¬è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ");
}


// æ—¥ä»˜ã‚’å‰å¾Œã•ã›ã‚‹é–¢æ•°
function slideDay(diff) {
    const d = new Date(selectedDate);
    d.setDate(d.getDate() + diff);
    showDay(dtToStr(d));
}

// ã‚·ãƒ•ãƒˆã®ä¸€æ‹¬åæ˜ 
function applyBatchShift() {
    const checked = Array.from(document.querySelectorAll('#weekday-checks input:checked')).map(c => parseInt(c.value));
    const y = currentViewDate.getFullYear(), m = currentViewDate.getMonth(), last = new Date(y, m + 1, 0).getDate();
    checked.forEach(w => {
        for (let i = 1; i <= last; i++) {
            const d = new Date(y, m, i);
            if (d.getDay() === w) {
                appData.singleShifts[dtToStr(d)] = JSON.parse(JSON.stringify(appData.defShift));
            }
        }
    });
    saveData();
    renderCalendar();
    closeModal('shift-modal-overlay');
}

// ç¥æ—¥ãƒ‡ãƒ¼ã‚¿ã®å–å¾—
async function fetchHolidays() {
    const year = currentViewDate.getFullYear();
    try {
        const response = await fetch(`https://holidays-jp.github.io/api/v1/${year}/date.json`);
        if (!response.ok) throw new Error('Network response was not ok');
        holidayData = await response.json();
    } catch (e) {
        console.error("ç¥æ—¥ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ", e);
        holidayData = {};
    } finally {
        renderCalendar();
    }
}

// æ¡ˆä»¶ä¸€è¦§ã‚’é–‹ã
function openJobList() {
    const container = document.getElementById('all-job-list-container');
    container.innerHTML = "";
    const sortedJobs = [...appData.longTermJobs].sort((a, b) => (a.isDeleted === b.isDeleted) ? 0 : a.isDeleted ? 1 : -1);

    sortedJobs.forEach(job => {
        const div = document.createElement('div');
        div.className = `job-card ${job.isCompleted ? 'completed' : ''} ${job.isDeleted ? 'deleted' : ''}`;
        div.style.marginBottom = "10px";
        div.style.padding = "10px";
        div.style.border = "1px solid #ddd";
        div.style.borderRadius = "8px";

        div.innerHTML = `
            <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                <div style="font-weight:bold; font-size:14px;">${job.name}</div>
                <div>
                    <button class="mini-btn" onclick="openJobModal(${job.id})" style="padding:8px 12px; margin-right:5px;">âœï¸ ç·¨é›†</button>
                    <button class="mini-btn" onclick="hardDeleteJob(${job.id})" style="padding:8px 12px; background:#ffebee; color:#c62828; border-color:#ef9a9a;">Ã—</button>
                </div>
            </div>
            <div style="font-size:11px; color:#666; margin-top:5px;">æœŸé–“: ${job.start} ï½ ${job.end}</div>
            <div style="font-size:11px; color:#666;">æƒ³å®š: ${job.totalH}h / é€²æ—: ${job.progress}%</div>
        `;
        container.appendChild(div);
    });
    document.getElementById('job-list-modal-overlay').style.display = 'flex';
}

// å±¥æ­´ã‹ã‚‰å®Œå…¨ã«å‰Šé™¤
function hardDeleteJob(id) {
    if(confirm("ã“ã®æ¡ˆä»¶ã‚’å±¥æ­´ã‹ã‚‰å®Œå…¨ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) {
        appData.longTermJobs = appData.longTermJobs.filter(j => j.id !== id);
        saveData();
        openJobList();
ã€€ã€€ã€€ã€€renderCalendar();

    }
}


function getUpcomingJobs() {
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    
    // 3æ—¥å¾Œã®æ—¥ä»˜
    const threeDaysLater = new Date(today);
    threeDaysLater.setDate(today.getDate() + 3);

    // æ¡ä»¶ã«åˆã†æ¡ˆä»¶ã‚’æŠ½å‡º
    return (appData.longTermJobs || []).filter(j => {
        const dueDate = new Date(j.end);
        // å‰Šé™¤ãƒ»å®Œäº†ã•ã‚Œã¦ãŠã‚‰ãšã€ã‹ã¤ã€Œä»Šæ—¥ã€œ3æ—¥å¾Œã€ãŒç· åˆ‡ã®ã‚‚ã®
        return !j.isDeleted && !j.isCompleted && dueDate >= today && dueDate <= threeDaysLater;
    });
}
function sendJobNotification() {
    const now = new Date();
    // æ—¥æœ¬æ™‚é–“ã® YYYY-MM-DD ã‚’ç¢ºå®Ÿã«å–å¾—
    const y = now.getFullYear();
    const m = String(now.getMonth() + 1).padStart(2, '0');
    const d = String(now.getDate()).padStart(2, '0');
    const todayStr = `${y}-${m}-${d}`; // "2026-02-25" å½¢å¼

    const todayTime = new Date(y, now.getMonth(), now.getDate()).getTime();
    const threeDaysLaterTime = todayTime + (3 * 24 * 60 * 60 * 1000);

    let upcomingJobs = (appData.longTermJobs || []).filter(j => {
        // ã‚¹ãƒ©ãƒƒã‚·ãƒ¥ã‚’ãƒã‚¤ãƒ•ãƒ³ã«ç½®æ›ã—ã¦çµ±ä¸€
        const formattedEnd = j.end.replace(/\//g, '-');
        const dueDate = new Date(formattedEnd);
        const dueTime = dueDate.getTime();
        
        return !j.isDeleted && !j.isCompleted && dueTime >= todayTime && dueTime <= threeDaysLaterTime;
    });

    if (upcomingJobs.length === 0) return;

    upcomingJobs.sort((a, b) => new Date(a.end.replace(/\//g, '-')) - new Date(b.end.replace(/\//g, '-')));

    // 1. ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä½œæˆ
    let title = upcomingJobs.length === 1 ? "ğŸ“¢ ç· åˆ‡é–“è¿‘ã®æ¡ˆä»¶" : `ğŸ“¢ ç· åˆ‡é–“è¿‘ãŒ ${upcomingJobs.length} ä»¶ã‚ã‚Šã¾ã™`;
    
    // 2. å„æ¡ˆä»¶ã®è¡¨ç¤ºã‚¹ã‚¿ã‚¤ãƒ«ã‚’è¨­å®š
    let bodyHtml = upcomingJobs.map(j => {
        // å½¢å¼ã‚’çµ±ä¸€ã—ã¦æ¯”è¼ƒ
        const jobEnd = j.end.replace(/\//g, '-');
        const isToday = (jobEnd === todayStr);

        if (isToday) {
            // â˜… ã“ã“ã§è‰²ã¨å¤ªã•ã‚’æŒ‡å®š
            return `<div style="color: #ff4d4d !important; font-weight: 900 !important; margin-bottom: 6px;">ãƒ»${j.name} (æœ¬æ—¥ç· åˆ‡ï¼)</div>`;
        } else {
            return `<div style="margin-bottom: 4px; color: #ffffff;">ãƒ»${j.name} (${j.end})</div>`;
        }
    }).join('');

    // 3. ç”»é¢ã«è¡¨ç¤º
    const bar = document.getElementById('app-notice-bar');
    const titleEl = document.getElementById('notice-title');
    const bodyEl = document.getElementById('notice-body');

    titleEl.innerText = title;
    bodyEl.innerHTML = bodyHtml; // innerHTMLã‚’ä½¿ã†
    
    bar.style.display = 'block';
    bar.onclick = () => { bar.style.display = 'none'; };
    setTimeout(() => { bar.style.display = 'none'; }, 10000);
}

// ã‚¢ãƒ—ãƒªã®åˆæœŸåŒ–
function init() {
    loadData();
    renderCalendar();
    fetchHolidays();
    
// â˜… ã“ã“ã‹ã‚‰è¿½è¨˜ï¼šé€šçŸ¥ã®åˆæœŸè¨­å®šã¨å®Ÿè¡Œ
    if (window.Notification) {
        if (Notification.permission === "default") {
            Notification.requestPermission();
        }
        // ã‚¢ãƒ—ãƒªèµ·å‹•æ™‚ã«ç· åˆ‡ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦é€šçŸ¥ã‚’å‡ºã™
        sendJobNotification();
    }
    // â˜… ã“ã“ã¾ã§è¿½è¨˜

    const dayScreen = document.getElementById('day-screen');
    dayScreen.addEventListener('touchstart', (e) => {
        if (document.getElementById('job-list-modal-overlay').style.display === 'flex') return; 
        touchStartX = e.touches[0].pageX;
    }, {passive: true});

    dayScreen.addEventListener('touchend', (e) => {
        const touchEndX = e.changedTouches[0].pageX;
        const diff = touchStartX - touchEndX;
        if (diff > 100) slideDay(1);
        else if (diff < -100) slideDay(-1);
    }, {passive: true});   
    
    document.getElementById('final-delete-btn').onclick = deleteTask;
    document.getElementById('month-reset-btn').onclick = (e) => {
        e.stopPropagation();
        const y = currentViewDate.getFullYear(), m = currentViewDate.getMonth() + 1;
        document.getElementById('reset-confirm-msg').textContent = `${y}å¹´${m}æœˆã®ã€Œäºˆå®šã€ã¨ã€Œã‚·ãƒ•ãƒˆã€ã‚’ã™ã¹ã¦å‰Šé™¤ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ`;
        document.getElementById('reset-modal-overlay').style.display = 'flex';
    };

// inité–¢æ•°ã®ä¸­ã«ã“ã‚Œã‚’è¿½åŠ 
document.body.addEventListener('click', () => {
    sendJobNotification();
}, { once: true }); // æœ€åˆã®ä¸€å›ã ã‘å®Ÿè¡Œ

    const cp = document.getElementById('color-picker-area');
    if (cp) {
        cp.innerHTML = "";
        COLORS.forEach(c => {
            const b = document.createElement('div'); 
            b.style.height='35px'; b.style.borderRadius='6px'; b.style.background=c; b.style.border='3px solid transparent';
            b.onclick = () => { 
                selectedColor = c; 
                [...cp.children].forEach(x=>x.style.borderColor='transparent'); 
                b.style.borderColor='#333'; 
            };
            cp.appendChild(b);
        });
    }
}

// èµ·å‹•
init();

// --- ãƒã‚¦ã‚¹ãƒ»ã‚¿ãƒƒãƒã®å‹•ãã‚’ç›£è¦–ã™ã‚‹è¨­å®š ---

// PCç”¨
window.addEventListener('mousemove', handleMove);
window.addEventListener('mouseup', stopDrag);

// ã‚¹ãƒãƒ›ç”¨
window.addEventListener('touchmove', (e) => { 
    if(isDragging) { 
        // ãƒ‰ãƒ©ãƒƒã‚°ä¸­ã¯ç”»é¢ãŒã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã—ãªã„ã‚ˆã†ã«å›ºå®š
        if(e.cancelable) e.preventDefault(); 
        handleMove(e); 
    } 
}, {passive:false});

window.addEventListener('touchend', stopDrag);

</script>
</body>
</html>
