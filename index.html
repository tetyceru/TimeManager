<!DOCTYPE html>
<html lang="ja">
<head>
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="TimeManager">
<link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/3652/3652191.png">

<link rel="manifest" href="data:application/manifest+json,{%22name%22:%22TimeManager%20Pro%22,%22short_name%22:%22TimeManager%22,%22start_url%22:%22.%22,%22display%22:%22standalone%22,%22background_color%22:%22%23f4f5f7%22,%22theme_color%22:%22%235c67f2%22}">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Time Manager Pro</title>
    <style>
        :root { --primary: #5c67f2; --shift: #4caf50; --job: #ffa500; --danger: #ff4d4d; --bg: #f4f5f7; --holiday: #ff5252; --sleep: #d8d6f0; }
        body { font-family: sans-serif; background: var(--bg); margin: 0; padding: 10px; display: flex; justify-content: center; -webkit-tap-highlight-color: transparent; overscroll-behavior-y: contain;}
        .container { width: 100%; max-width: 550px; background: white; padding: 15px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .hidden { display: none !important; }
        
        /* Header */
        .header { margin-bottom: 15px; }
        .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; flex-wrap: wrap; gap: 8px; }
        .month-nav { display: flex; align-items: center; gap: 5px; }
        .title-group { display: flex; flex-direction: column; align-items: center; }
        #view-title { cursor: pointer; font-size: 17px; margin: 0; padding: 5px 8px; border-radius: 6px; background: #f0f0f0; }
        .nav-btn { background: #eee; border: none; padding: 10px 12px; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 14px; }
        .reset-btn { background: #fff1f1; color: var(--danger); border: 1px solid #ffcccc; padding: 4px 10px; border-radius: 4px; font-size: 11px; cursor: pointer; margin-top: 4px; touch-action: manipulation; }

        .mode-switch { background: #f0f0f0; padding: 4px; border-radius: 20px; display: inline-flex; margin-bottom: 10px; }
        .mode-btn { border: none; padding: 8px 15px; border-radius: 15px; cursor: pointer; font-size: 11px; }
        .mode-btn.active { background: var(--primary); color: white; }
        .mode-btn.shift-active { background: var(--shift) !important; color: white; }

        /* Calendar */
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; }
        .calendar-day { border: 1px solid #eee; min-height: 95px; padding: 4px; cursor: pointer; font-size: 11px; border-radius: 6px; background: white; display: flex; flex-direction: column; overflow: hidden; position: relative; }
        .calendar-day.shift-mode-active { border: 1.5px dashed var(--shift); background-color: #fafffa; }
        .is-today { border: 2px solid var(--primary) !important; background: #f0f2ff; }
        .is-holiday .day-num { color: var(--holiday); }
        .day-num { font-weight: bold; }
        .holiday-name { font-size: 8px; color: var(--holiday); overflow: hidden; white-space: nowrap; margin-bottom: 2px; }
        
        .job-band { height: 15px; background: var(--job); color: white; font-size: 9px; margin-bottom: 2px; border-radius: 3px; padding: 0 4px; line-height: 15px; overflow: hidden; white-space: nowrap; }
        .job-band.deleted { background: repeating-linear-gradient(45deg, #ff4d4d, #ff4d4d 5px, #ff6666 5px, #ff6666 10px); }
        .shift-band { background: #e8f5e9 !important; color: #2e7d32 !important; border: 1px solid var(--shift); font-weight: bold; }

        /* Timeline */
        #timeline-container { position: relative; margin-left: 50px; }
        #timeline { width: 100%; border: 1px solid #ccc; position: relative; background: #fff; touch-action: none; }
        .time-slot { height: 20px; border-bottom: 1px solid #eee; position: relative; }
        .time-label { position: absolute; left: -45px; width: 40px; text-align: right; font-size: 10px; color: #888; line-height: 20px; }
        .fixed-busy { background-color: var(--sleep); }
        .shift-busy { background-color: #e8f5e9; border-left: 5px solid var(--shift); }
        
        .custom-task { position: absolute; left: 0; right: 0; z-index: 10; color: white; font-size: 10px; font-weight: bold; padding: 2px 6px; border-radius: 4px; display: flex; align-items: center; justify-content: space-between; cursor: grab; box-sizing: border-box; }
        .del-btn-mini { position: absolute; top: -5px; right: -5px; background: #ff4d4d; color: white; border: 2px solid white; border-radius: 50%; width: 24px; height: 24px; font-size: 14px; cursor: pointer; font-weight: bold; display: flex; align-items: center; justify-content: center; z-index: 100; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }

        .move-preview { opacity: 0.6; pointer-events: none; z-index: 50; position: absolute; left: 0; right: 0; border: 1px solid white; }
        .drag-guide { display: flex; align-items: center; justify-content: center; color: var(--primary); font-weight: bold; font-size: 12px; }
        
        /* Job Cards */
        .job-card { background: #fffaf0; border: 1px solid #ffe0b2; padding: 12px; border-radius: 8px; margin-bottom: 8px; }
        .job-card.completed { background: #f0f0f0; border-color: #ccc; opacity: 0.8; }
        .job-card.deleted { background: repeating-linear-gradient(45deg, #fff5f5, #fff5f5 10px, #ffebeb 10px, #ffebeb 20px); border-color: var(--danger); }
        .job-card-row { display: flex; align-items: center; justify-content: space-between; gap: 10px; margin-top: 10px; }
        .progress-input { width: 60px !important; margin: 0 !important; padding: 4px !important; text-align: center; }
        .mini-btn { padding: 6px 10px; font-size: 11px; border-radius: 4px; border: 1px solid #ccc; background: white; cursor: pointer; }

        /* Modals */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 2000; padding: 20px; }
        .modal { background: white; padding: 20px; border-radius: 12px; width: 100%; max-width: 360px; }
        input, select { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ddd; border-radius: 6px; font-size: 16px; box-sizing: border-box; }
        .save-btn { width: 100%; padding: 14px; background: var(--primary); color: white; border: none; border-radius: 8px; font-weight: bold; margin-top: 10px; }
/* 案件一覧内の削除ボタンをスマホで押しやすくする */
#all-job-list-container button {
    cursor: pointer;
    touch-action: manipulation; /* 連打や誤判定を防止 */
    padding: 10px; /* タップ範囲を広げる */
    z-index: 10;
    position: relative;
}
/* モーダル全体の重なり順を最強にする */
.modal-overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.5);
    align-items: center;
    justify-content: center;
    z-index: 9999 !important; /* 他の要素に邪魔されない数字 */
}

/* モーダルの中身も確実にタップを通す */
.modal {
    background: white;
    padding: 20px;
    border-radius: 12px;
    width: 100%;
    max-width: 360px;
    z-index: 10000 !important;
    position: relative;
}

/* 削除ボタンのタップ領域をさらに強調 */
#all-job-list-container button {
    touch-action: auto !important; /* ブラウザの標準的なタップを許可 */
    -webkit-tap-highlight-color: rgba(0,0,0,0); /* タップ時の色を消す */
}

    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <div class="top-bar">
            <button id="back-to-cal-btn" class="nav-btn hidden" onclick="showCalendar()">← 戻る</button>
            <div class="month-nav">
                <button class="nav-btn" onclick="changeMonth(-1)">く</button>
                <div class="title-group">
                    <h2 id="view-title" onclick="openJumpModal()"></h2>
                    <button class="reset-btn" id="month-reset-btn">月間リセット</button>
                </div>
                <button class="nav-btn" onclick="changeMonth(1)">＞</button>
            </div>
            <div id="action-btns">
                <button onclick="openSleepModal()" class="nav-btn" style="background:var(--sleep);">睡眠</button>
                <button onclick="openShiftModal()" class="nav-btn" style="background:#e8f5e9; color:#2e7d32;">シフト</button>
<button class="job-list-btn" onclick="openJobList()">案件一覧</button>
                <button onclick="openJobModal()" class="nav-btn" style="background:#fff3e0; color:#e65100;">+ 案件</button>
            </div>
        </div>
        <div class="mode-switch" id="mode-selector">
            <button class="mode-btn active" id="mode-normal-btn" onclick="setAppMode('normal')">閲覧</button>
            <button class="mode-btn" id="mode-shift-btn" onclick="setAppMode('shift')">シフト一括</button>
        </div>
    </div>
    <div id="calendar-screen"><div class="calendar-grid" id="calendar-grid"></div></div>
    <div id="calendar-screen">
        <div class="calendar-grid" id="calendar-grid"></div>
    </div>

    <div id="day-screen" class="hidden">
        <div style="display:flex; justify-content:space-between; align-items:center; background:#f0f2ff; padding:10px; border-radius:8px; margin-bottom:10px;">
            <button class="nav-btn" onclick="slideDay(-1)">＜</button>
            <div style="text-align:center;">
                <h2 id="current-day-label" style="margin:0; font-size:16px;"></h2>
                <div id="freeTime" style="font-size:11px; font-weight:bold;"></div>
            </div>
            <button class="nav-btn" onclick="slideDay(1)">＞</button>
        </div>

        <div id="day-jobs-area"></div>

        <div id="timeline-container">
            <div id="timeline"></div>
            <div id="drag-guide" class="drag-guide hidden" style="position:absolute; left:0; right:0; background:rgba(92,103,242,0.3); border:2px dashed var(--primary); z-index:1000; pointer-events:none;"></div>
        </div>
    </div>
</div>

<div id="reset-modal-overlay" class="modal-overlay">
    <div class="modal">
        <h3>月間リセット</h3>
        <p id="reset-confirm-msg" style="font-size:14px; color:#666;"></p>
        <button onclick="executeMonthlyReset()" class="save-btn" style="background:var(--danger);">本当にすべて消去する</button>
        <button type="button" onclick="closeModal('job-modal-overlay'); if(isEditingFromList) openJobList();" class="save-btn" style="background:#666;">キャンセル</button>
    </div>
</div>

<div id="jump-modal-overlay" class="modal-overlay"><div class="modal"><h3>年月ジャンプ</h3><div style="display:flex; gap:10px;"><select id="jump-year"></select><select id="jump-month"></select></div><button onclick="jumpToMonth()" class="save-btn">ジャンプ</button><button onclick="closeModal('jump-modal-overlay')" style="width:100%; border:none; background:none; margin-top:10px;">閉じる</button></div></div>
<div id="sleep-modal-overlay" class="modal-overlay"><div class="modal"><h3>睡眠設定</h3><div style="display:flex; gap:10px;"><div><label>開始</label><input type="time" id="sleep-start"></div><div><label>終了</label><input type="time" id="sleep-end"></div></div><div id="batch-sleep-area"><button onclick="saveDefSleep()" class="save-btn">基本設定として保存</button></div><button id="save-day-sleep-btn" onclick="saveDaySleep()" class="save-btn hidden">この日のみ保存</button><button onclick="closeModal('sleep-modal-overlay')" style="width:100%; border:none; background:none; margin-top:10px;">キャンセル</button></div></div>
<div id="job-modal-overlay" class="modal-overlay"><div class="modal"><h3>案件登録</h3><input type="hidden" id="edit-job-id"><input type="text" id="job-name" placeholder="案件名" autocomplete="off"><div style="display:flex; gap:5px;"><input type="date" id="job-start"><input type="date" id="job-end"></div><input type="number" id="job-total-h" placeholder="想定合計時間(h)"><button onclick="saveJob()" class="save-btn">保存</button><button onclick="closeModal('job-modal-overlay')" style="width:100%; border:none; background:none; margin-top:10px;">キャンセル</button></div></div>
<div id="modal-overlay" class="modal-overlay"><div class="modal"><h3>予定の追加</h3><input type="text" id="task-name" placeholder="予定の名前" autocomplete="off"><div id="color-picker-area" style="display:grid; grid-template-columns:repeat(4,1fr); gap:8px; margin:10px 0;"></div><button onclick="saveTask()" class="save-btn">保存</button><button onclick="closeModal('modal-overlay')" style="width:100%; border:none; background:none; margin-top:10px;">キャンセル</button></div></div>
<div id="edit-modal-overlay" class="modal-overlay"><div class="modal"><h3>予定の削除</h3><p id="edit-info" style="text-align:center; font-weight:bold;"></p><button id="final-delete-btn" class="save-btn" style="background:var(--danger);">削除</button><button onclick="closeModal('edit-modal-overlay')" style="width:100%; border:none; background:none; margin-top:10px;">戻る</button></div></div>
<div id="shift-modal-overlay" class="modal-overlay"><div class="modal"><h3>シフト設定</h3><div style="display:flex; gap:5px;"><div><label>開始</label><input type="time" id="set-shift-start"></div><div><label>終了</label><input type="time" id="set-shift-end"></div></div><div id="batch-shift-area"><div style="margin-top:10px; padding-top:10px; border-top:1px solid #eee;"><label style="font-size:12px; font-weight:bold;">曜日一括反映</label><div id="weekday-checks" style="display:grid; grid-template-columns:repeat(4,1fr); gap:5px; margin-top:5px;"><label><input type="checkbox" value="1">月</label><label><input type="checkbox" value="2">火</label><label><input type="checkbox" value="3">水</label><label><input type="checkbox" value="4">木</label><label><input type="checkbox" value="5">金</label><label><input type="checkbox" value="6">土</label><label><input type="checkbox" value="0">日</label></div><button onclick="applyBatchShift()" class="save-btn" style="background:var(--shift);">一括反映</button></div><button onclick="saveDefShift()" class="save-btn">基本設定保存</button></div><button id="save-day-shift-btn" onclick="saveDayShift()" class="save-btn hidden">この日のみ保存</button><button onclick="closeModal('shift-modal-overlay')" style="width:100%; border:none; background:none; margin-top:10px;">閉じる</button></div></div>
<div id="job-list-modal-overlay" class="modal-overlay" style="display:none;">
    <div class="modal" style="max-height: 80vh; overflow-y: auto;">
        <h3>案件一覧（全履歴）</h3>
        <div id="all-job-list-container"></div>
        <button onclick="closeModal('job-list-modal-overlay')" class="save-btn" style="background:#666;">閉じる</button>
    </div>
</div>


<script>
let isEditingFromList = false; // 案件一覧から開いたかどうかを覚える変数
let currentViewDate = new Date(); currentViewDate.setDate(1);
const STORAGE_KEY = 'TimeManager_V22';
let appData = { tasks: {}, longTermJobs: [], singleShifts: {}, singleSleeps: {}, defShift: { start: 36, end: 68 }, defSleep: { start: 0, end: 26 } };
let holidayData = {};
const COLORS = ["#ff99bb", "#98fb98", "#87cefa", "#ffcc99", "#e0bbff", "#ffff99", "#ffcccc", "#d3d3d3"];
let selectedColor = COLORS[0], inputMode = 'normal', selectedDate = "";
let isDragging = false, dragMode = null, startIdx = null, activeTaskId = null, moveOffset = 0, tempRange = { start: 0, length: 0 }, scrollInterval = null, lastTouchY = 0;

function dtToStr(d) { return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`; }
function loadData() { const s = localStorage.getItem(STORAGE_KEY); if(s) appData = JSON.parse(s); }
function saveData() { localStorage.setItem(STORAGE_KEY, JSON.stringify(appData)); }
function indexToTime(i) { return `${String(Math.floor(i/4)).padStart(2,'0')}:${String((i%4)*15).padStart(2,'0')}`; }
function timeToIndex(t) { const [h,m]=t.split(':').map(Number); return h*4+Math.floor(m/15); }
function formatDur(l) { const h = Math.floor(l/4), m = (l%4)*15; return h > 0 ? `${h}h ${m}m` : `${m}m`; }

function isJobVisibleOnDate(job, dateStr) {
    if (!dateStr || dateStr < job.start || dateStr > job.end) return false;
    if (job.isDeleted && job.deletedAt && dateStr > job.deletedAt) return false;
    if (job.isCompleted && job.completedAt && dateStr > job.completedAt) return false;
    return true;
}
// --- ここを修正してください ---

let touchStartX = 0; // ← これが init() の外にあるか確認

function init() {
    loadData();

    const dayScreen = document.getElementById('day-screen');
    dayScreen.addEventListener('touchstart', (e) => {
// 案件一覧が開いているときは、スワイプ処理を完全に止める
    if (document.getElementById('job-list-modal-overlay').style.display === 'flex') {
        return; 
    }
    touchStartX = e.touches[0].pageX;
}, {passive: true});

    dayScreen.addEventListener('touchend', (e) => {
        const touchEndX = e.changedTouches[0].pageX;
        const diff = touchStartX - touchEndX;
        if (diff > 100) {
            slideDay(1);
        } else if (diff < -100) {
            slideDay(-1);
        }
    }, {passive: true});

    // × fetechHolidays(); 
    fetchHolidays();  // ← 正しくはこちら（eを一個消します）
    
    document.getElementById('final-delete-btn').onclick = deleteTask;
    document.getElementById('month-reset-btn').onclick = (e) => {
        e.stopPropagation();
        const y = currentViewDate.getFullYear(), m = currentViewDate.getMonth() + 1;
        document.getElementById('reset-confirm-msg').textContent = `${y}年${m}月の「予定」と「シフト」をすべて削除します。よろしいですか？`;
        document.getElementById('reset-modal-overlay').style.display = 'flex';
    };
    const cp = document.getElementById('color-picker-area');
    COLORS.forEach(c => {
        const b = document.createElement('div'); b.style.height='35px'; b.style.borderRadius='6px'; b.style.background=c; b.style.border='3px solid transparent';
        b.onclick = () => { selectedColor = c; [...cp.children].forEach(x=>x.style.borderColor='transparent'); b.style.borderColor='#333'; };
        cp.appendChild(b);
    });
    renderCalendar();
}

function executeMonthlyReset() {
    const y = currentViewDate.getFullYear(), m = String(currentViewDate.getMonth() + 1).padStart(2, '0');
    const prefix = `${y}-${m}`;
    Object.keys(appData.tasks).forEach(d => { if(d.startsWith(prefix)) delete appData.tasks[d]; });
    Object.keys(appData.singleShifts).forEach(d => { if(d.startsWith(prefix)) delete appData.singleShifts[d]; });
    saveData(); closeModal('reset-modal-overlay'); renderCalendar();
}

function renderCalendar() {
    const grid = document.getElementById('calendar-grid'); grid.innerHTML = "";
    const y = currentViewDate.getFullYear(), m = currentViewDate.getMonth();
    const holidays = holidayData;
    document.getElementById('view-title').textContent = `${y}年 ${m + 1}月`;
    const firstDay = new Date(y, m, 1).getDay(), lastDate = new Date(y, m + 1, 0).getDate();
    for(let i=0; i<firstDay; i++) grid.appendChild(document.createElement('div'));
    for (let i = 1; i <= lastDate; i++) {
        const dStr = `${y}-${String(m+1).padStart(2,'0')}-${String(i).padStart(2,'0')}`;
        const day = document.createElement('div'); day.className = 'calendar-day';
        if(inputMode === 'shift') day.classList.add('shift-mode-active');
        if(dStr === dtToStr(new Date())) day.classList.add('is-today');
        let html = "";
        if(holidays[dStr]) { day.classList.add('is-holiday'); html += `<div class="holiday-name">${holidays[dStr]}</div>`; }
        html += `<div class="day-num">${i}</div>`;
        let displayItems = [];
        if (appData.singleShifts[dStr]) displayItems.push(`<div class="job-band shift-band">勤:${indexToTime(appData.singleShifts[dStr].start)}</div>`);
        (appData.longTermJobs || []).filter(j => isJobVisibleOnDate(j, dStr)).forEach(j => displayItems.push(`<div class="job-band ${j.isDeleted?'deleted':''}">${j.name}</div>`));
        displayItems.slice(0, 2).forEach(item => html += item);
        if(displayItems.length > 2) html += `<div style="font-size:8px;color:#888;text-align:right">他${displayItems.length-2}件</div>`;
        day.innerHTML = html;
        day.onclick = () => { if(inputMode==='shift'){ if(appData.singleShifts[dStr]) delete appData.singleShifts[dStr]; else appData.singleShifts[dStr]={...appData.defShift}; saveData(); renderCalendar(); } else showDay(dStr); };
        grid.appendChild(day);
    }
}

function renderTimeline() {
    const tl = document.getElementById("timeline"); tl.innerHTML = "";
    const tasks = appData.tasks[selectedDate] || [], shift = appData.singleShifts[selectedDate], sleep = appData.singleSleeps[selectedDate] || appData.defSleep;
    for (let i = 0; i < 96; i++) {
        const slot = document.createElement("div"); slot.className = "time-slot"; slot.dataset.idx = i;
        if (i % 4 === 0) slot.innerHTML = `<div class="time-label">${Math.floor(i/4)}:00</div>`;
        const isSleep = (sleep.start < sleep.end) ? (i >= sleep.start && i < sleep.end) : (i >= sleep.start || i < sleep.end);
        if (isSleep) slot.classList.add("fixed-busy");
        if (shift && i >= shift.start && i < shift.end) slot.classList.add("shift-busy");
        const t = tasks.find(x => i === x.start);
        if (t) {
            const el = document.createElement("div"); el.className = "custom-task"; el.style.backgroundColor = t.color; el.style.height = `${t.length * 20 - 1}px`;
            el.innerHTML = `<span style="flex:1;overflow:hidden;pointer-events:none;padding-right:20px;">${t.name} (${formatDur(t.length)})</span>`;
            const startHandler = (e) => { if(e.target.classList.contains('del-btn-mini')) return; e.stopPropagation(); startDrag(t, e.touches ? e.touches[0] : e); };
            el.addEventListener('mousedown', startHandler); el.addEventListener('touchstart', startHandler, {passive:false});
            const d = document.createElement('button'); d.className = 'del-btn-mini'; d.innerHTML = '×';
            d.onclick = (e) => { e.preventDefault(); e.stopPropagation(); activeTaskId = t.id; document.getElementById('edit-info').textContent = t.name; document.getElementById('edit-modal-overlay').style.display = 'flex'; };
            el.appendChild(d); slot.appendChild(el);
        }
        const createH = (e) => { if(!e.target.closest('.custom-task')) { isDragging=true; dragMode='create'; startIdx=i; updateGuide(i,i); } };
        slot.addEventListener('mousedown', createH);
        slot.addEventListener('touchstart', (e) => { if(!e.target.closest('.custom-task')) { e.preventDefault(); createH(e.touches[0]); } }, {passive:false});
        tl.appendChild(slot);
    }
    updateFreeTime();
}

function startDrag(t, e) { isDragging = true; dragMode = 'move'; activeTaskId = t.id; const tlRect = document.getElementById('timeline').getBoundingClientRect(); moveOffset = Math.floor(((e.pageY - window.scrollY) - (tlRect.top + t.start * 20)) / 20); }
function handleMove(e) { if(!isDragging) return; const touch = e.touches ? e.touches[0] : e; lastTouchY = touch.clientY; const threshold = window.innerHeight * 0.15; if (lastTouchY < threshold) startAutoScroll(-10); else if (lastTouchY > window.innerHeight - threshold) startAutoScroll(10); else stopAutoScroll(); updateDragDisplay(); }
function updateDragDisplay() { if(!isDragging) return; const tlRect = document.getElementById('timeline').getBoundingClientRect(); const i = Math.floor((lastTouchY + window.scrollY - (tlRect.top + window.scrollY)) / 20); const shift = appData.singleShifts[selectedDate], sleep = appData.singleSleeps[selectedDate] || appData.defSleep; if(dragMode === 'create') { const [min, max] = [startIdx, i].sort((a,b)=>a-b); if(min >= 0 && max < 96 && !checkConflict(min, max-min+1, null, shift, sleep)) updateGuide(min, max); } else if(dragMode === 'move') { const t = appData.tasks[selectedDate].find(x=>x.id===activeTaskId); const ns = i - moveOffset; if(ns >= 0 && ns+t.length <= 96 && !checkConflict(ns, t.length, activeTaskId, shift, sleep)) { document.querySelectorAll('.move-preview').forEach(x=>x.remove()); const pre = document.createElement('div'); pre.className = "custom-task move-preview"; pre.style.backgroundColor = t.color; pre.style.top = `${ns * 20}px`; pre.style.height = `${t.length * 20 - 1}px`; pre.dataset.ns = ns; document.getElementById('timeline').appendChild(pre); } } }
function startAutoScroll(speed) { if (scrollInterval) return; scrollInterval = setInterval(() => { window.scrollBy(0, speed); updateDragDisplay(); }, 20); }
function stopAutoScroll() { if (scrollInterval) { clearInterval(scrollInterval); scrollInterval = null; } }
const stopDrag = () => { stopAutoScroll(); if(!isDragging) return; if(dragMode === 'move') { const pre = document.querySelector('.move-preview'); if(pre) { appData.tasks[selectedDate].find(x=>x.id===activeTaskId).start = parseInt(pre.dataset.ns); saveData(); } renderTimeline(); } else if(dragMode === 'create') { document.getElementById('modal-overlay').style.display='flex'; } isDragging = false; document.querySelectorAll('.move-preview').forEach(x=>x.remove()); document.getElementById('drag-guide').classList.add('hidden'); };
window.addEventListener('mouseup', stopDrag); window.addEventListener('touchend', stopDrag); window.addEventListener('mousemove', handleMove); window.addEventListener('touchmove', (e)=>{ if(isDragging) { e.preventDefault(); handleMove(e); } }, {passive:false});

function updateGuide(min, max) { const g = document.getElementById('drag-guide'); g.classList.remove('hidden'); g.style.top = `${min * 20}px`; g.style.height = `${(max-min+1) * 20}px`; tempRange = {start:min, length:max-min+1}; g.textContent = formatDur(tempRange.length); }
function updateJobArea() { const area = document.getElementById('day-jobs-area'); area.innerHTML = ""; (appData.longTermJobs || []).filter(j => isJobVisibleOnDate(j, selectedDate)).forEach(j => { const div = document.createElement('div'); div.className = `job-card ${j.isCompleted ? 'completed' : ''} ${j.isDeleted ? 'deleted' : ''}`; div.innerHTML = `<div style="display:flex; justify-content:space-between;"><b>${j.name}</b> <small>計:${j.totalH}h</small></div><div class="job-card-row">進捗: <input type="number" class="progress-input" value="${j.progress}" onchange="updateProgress(${j.id}, this.value)" ${j.isDeleted || j.isCompleted ? 'disabled' : ''}> %<div><button class="mini-btn" onclick="openJobModal(${j.id})">編集</button><button class="mini-btn" onclick="deleteJob(${j.id})">${j.isDeleted?'復元':'削除'}</button><button class="mini-btn" onclick="completeJob(${j.id})">${j.isCompleted?'戻す':'完了'}</button></div></div>`; area.appendChild(div); }); }
function updateProgress(id, v) { let val = Math.max(0, Math.min(100, parseInt(v)||0)); appData.longTermJobs.find(x=>x.id===id).progress = val; saveDataAndRefresh(); }
function completeJob(id) { const j = appData.longTermJobs.find(x=>x.id===id); j.isCompleted = !j.isCompleted; j.completedAt = j.isCompleted ? selectedDate : null; j.progress = j.isCompleted ? 100 : (j.oldProgress || 0); saveDataAndRefresh(); }
function deleteJob(id) { const j = appData.longTermJobs.find(x=>x.id===id); j.isDeleted = !j.isDeleted; j.deletedAt = j.isDeleted ? selectedDate : null; saveDataAndRefresh(); }
function openSleepModal() { const s = (selectedDate && appData.singleSleeps[selectedDate]) ? appData.singleSleeps[selectedDate] : appData.defSleep; document.getElementById('sleep-start').value = indexToTime(s.start); document.getElementById('sleep-end').value = indexToTime(s.end); document.getElementById('batch-sleep-area').className = selectedDate ? 'hidden' : ''; document.getElementById('save-day-sleep-btn').className = selectedDate ? 'save-btn' : 'hidden'; document.getElementById('sleep-modal-overlay').style.display='flex'; }
function openShiftModal() { const s = (selectedDate && appData.singleShifts[selectedDate]) ? appData.singleShifts[selectedDate] : appData.defShift; document.getElementById('set-shift-start').value = indexToTime(s.start); document.getElementById('set-shift-end').value = indexToTime(s.end); document.getElementById('batch-shift-area').className = selectedDate ? 'hidden' : ''; document.getElementById('save-day-shift-btn').className = selectedDate ? 'save-btn' : 'hidden'; document.getElementById('shift-modal-overlay').style.display='flex'; }
function openJobModal(id = null) {
    // もし案件一覧モーダルが表示されていたら、フラグを立てる
    const listModal = document.getElementById('job-list-modal-overlay');
    isEditingFromList = (listModal.style.display === 'flex');

    closeModal('job-list-modal-overlay'); // 一覧を閉じる

    if (id) {
        const j = appData.longTermJobs.find(x => x.id == id);
        if(j) {
            document.getElementById('edit-job-id').value = id;
            document.getElementById('job-name').value = j.name;
            document.getElementById('job-start').value = j.start;
            document.getElementById('job-end').value = j.end;
            document.getElementById('job-total-h').value = j.totalH;
        }
    } else {
        document.getElementById('edit-job-id').value = "";
        document.getElementById('job-name').value = "";
        document.getElementById('job-start').value = selectedDate || dtToStr(new Date());
        document.getElementById('job-end').value = selectedDate || dtToStr(new Date());
        document.getElementById('job-total-h').value = "";
    }
    document.getElementById('job-modal-overlay').style.display = 'flex';
}
function openJumpModal() { const ys = document.getElementById('jump-year'), ms = document.getElementById('jump-month'); ys.innerHTML = ""; ms.innerHTML = ""; const curY = new Date().getFullYear(); for(let y=curY-1; y<=curY+3; y++) ys.innerHTML += `<option value="${y}" ${y==currentViewDate.getFullYear()?'selected':''}>${y}年</option>`; for(let m=0; m<12; m++) ms.innerHTML += `<option value="${m}" ${m==currentViewDate.getMonth()?'selected':''}>${m+1}月</option>`; document.getElementById('jump-modal-overlay').style.display='flex'; }
function jumpToMonth() { currentViewDate.setFullYear(document.getElementById('jump-year').value); currentViewDate.setMonth(document.getElementById('jump-month').value); renderCalendar(); closeModal('jump-modal-overlay'); }
function closeModal(id) { document.getElementById(id).style.display='none'; }
function checkConflict(s, l, id, shift, sleep) { const isSleep = (sleep.start < sleep.end) ? (s < sleep.end && s + l > sleep.start) : (s + l > sleep.start || s < sleep.end); if(isSleep || (shift && s < shift.end && s + l > shift.start)) return true; return (appData.tasks[selectedDate] || []).some(t => t.id !== id && s < t.start + t.length && s + l > t.start); }
function updateFreeTime() { const shift = appData.singleShifts[selectedDate], sleep = appData.singleSleeps[selectedDate] || appData.defSleep; let busyIdx = 0; for(let i=0; i<96; i++) { const isSleep = (sleep.start < sleep.end) ? (i >= sleep.start && i < sleep.end) : (i >= sleep.start || i < sleep.end); if(isSleep || (shift && i >= shift.start && i < shift.end)) busyIdx++; } (appData.tasks[selectedDate] || []).forEach(t => busyIdx += t.length); let jobH = 0; (appData.longTermJobs || []).filter(j => isJobVisibleOnDate(j, selectedDate)).forEach(j => { const totalDays = (new Date(j.end) - new Date(j.start)) / 86400000 + 1; jobH += (j.totalH * (1 - j.progress/100)) / Math.max(1, totalDays); }); const freeMin = (96 - busyIdx) * 15 - (jobH * 60); document.getElementById('freeTime').innerHTML = `自由時間: ${Math.floor(Math.max(0, freeMin)/60)}h ${Math.floor(Math.max(0, freeMin)%60)}m<br><small>案件ノルマ: 約 ${jobH.toFixed(1)}h/日</small>`; }
function saveDataAndRefresh() { saveData(); if(selectedDate) { updateJobArea(); renderTimeline(); } else renderCalendar(); }
function showDay(d) { selectedDate = d; document.getElementById('current-day-label').textContent = d; document.getElementById('calendar-screen').classList.add('hidden'); document.getElementById('day-screen').classList.remove('hidden'); document.getElementById('back-to-cal-btn').classList.remove('hidden'); document.getElementById('mode-selector').classList.add('hidden'); renderTimeline(); updateJobArea(); }
function showCalendar() { selectedDate = ""; document.getElementById('calendar-screen').classList.remove('hidden'); document.getElementById('day-screen').classList.add('hidden'); document.getElementById('back-to-cal-btn').classList.add('hidden'); document.getElementById('mode-selector').classList.remove('hidden'); renderCalendar(); }
function setAppMode(m) { inputMode = m; document.getElementById('mode-normal-btn').className = 'mode-btn' + (m==='normal'?' active':''); document.getElementById('mode-shift-btn').className = 'mode-btn' + (m==='shift'?' shift-active':''); renderCalendar(); }
function changeMonth(diff) {
    currentViewDate.setMonth(currentViewDate.getMonth() + diff);
    fetchHolidays(); // ここも renderCalendar から fetchHolidays に変更
}
function saveTask() { const name = document.getElementById('task-name').value.trim() || "予定"; if(!appData.tasks[selectedDate]) appData.tasks[selectedDate] = []; appData.tasks[selectedDate].push({ id: Date.now(), name, start: tempRange.start, length: tempRange.length, color: selectedColor }); document.getElementById('task-name').value = ""; saveDataAndRefresh(); closeModal('modal-overlay'); }
function deleteTask() { appData.tasks[selectedDate] = appData.tasks[selectedDate].filter(x => x.id !== activeTaskId); saveDataAndRefresh(); closeModal('edit-modal-overlay'); }
function saveJob() {
    const id = document.getElementById('edit-job-id').value;
    const name = document.getElementById('job-name').value;
    const start = document.getElementById('job-start').value;
    const end = document.getElementById('job-end').value;
    const totalH = parseFloat(document.getElementById('job-total-h').value) || 0;

    if (!name) { alert("案件名を入力してください"); return; }

    if (id) {
        // 編集
        const idx = appData.longTermJobs.findIndex(j => j.id == id);
        if (idx !== -1) {
            appData.longTermJobs[idx].name = name;
            appData.longTermJobs[idx].start = start;
            appData.longTermJobs[idx].end = end;
            appData.longTermJobs[idx].totalH = totalH;
        }
    } else {
        // 新規登録
        const newJob = {
            id: Date.now(),
            name: name,
            start: start,
            end: end,
            totalH: totalH,
            progress: 0,
            isCompleted: false
        };
        appData.longTermJobs.push(newJob);
    }

    saveData(); // データを保存
    closeModal('job-modal-overlay'); // 編集画面を閉じる

    // ★★★ ここからが修正ポイント ★★★
    if (isEditingFromList) {
        // 一覧から開いていた場合は、一覧画面を再表示する
        openJobList();
    } else {
        // カレンダーから直接開いていた場合は、通常通りカレンダーを更新
        renderCalendar();
        updateJobArea();
    }
    // ★★★ ここまで ★★★
}
function saveDaySleep() { appData.singleSleeps[selectedDate] = { start: timeToIndex(document.getElementById('sleep-start').value), end: timeToIndex(document.getElementById('sleep-end').value) }; saveDataAndRefresh(); closeModal('sleep-modal-overlay'); }
function saveDefSleep() { appData.defSleep = { start: timeToIndex(document.getElementById('sleep-start').value), end: timeToIndex(document.getElementById('sleep-end').value) }; saveData(); alert("基本設定を保存しました"); }
function saveDayShift() { appData.singleShifts[selectedDate] = { start: timeToIndex(document.getElementById('set-shift-start').value), end: timeToIndex(document.getElementById('set-shift-end').value) }; saveDataAndRefresh(); closeModal('shift-modal-overlay'); }
function saveDefShift() { appData.defShift = { start: timeToIndex(document.getElementById('set-shift-start').value), end: timeToIndex(document.getElementById('set-shift-end').value) }; saveData(); alert("基本設定を保存しました"); }
// 日付を前後させる関数
function slideDay(diff) {
    const d = new Date(selectedDate);
    d.setDate(d.getDate() + diff);
    showDay(dtToStr(d)); // showDayを再呼び出しして画面を更新
}
function applyBatchShift() { const checked = Array.from(document.querySelectorAll('#weekday-checks input:checked')).map(c => parseInt(c.value)); const y=currentViewDate.getFullYear(), m=currentViewDate.getMonth(), last=new Date(y,m+1,0).getDate(); checked.forEach(w => { for(let i=1; i<=last; i++) { const d = new Date(y,m,i); if(d.getDay()===w) appData.singleShifts[dtToStr(d)] = {start:timeToIndex(document.getElementById('set-shift-start').value), end:timeToIndex(document.getElementById('set-shift-end').value)}; }}); saveData(); renderCalendar(); closeModal('shift-modal-overlay'); }
async function fetchHolidays() {
    const year = currentViewDate.getFullYear();
    try {
        // 公開されている祝日JSONを取得
        const response = await fetch(`https://holidays-jp.github.io/api/v1/${year}/date.json`);
        holidayData = await response.json();
    } catch (e) {
        console.error("祝日の取得に失敗しました", e);
        holidayData = {}; // 失敗した場合は空にする
    }
    renderCalendar(); // 取得が終わったらカレンダーを再描画
}
function getNthMonday(y, m, n) { const first = new Date(y, m-1, 1).getDay(); return (first <= 1 ? 1 - first : 8 - first) + (n - 1) * 7 + 1; }
// 案件一覧を開く（究極のスマホ対応版）
function openJobList() {
    const container = document.getElementById('all-job-list-container');
    container.innerHTML = "";
    
    appData.longTermJobs.forEach(job => {
        const div = document.createElement('div');
        div.className = 'job-card';
        div.style.marginBottom = "10px";
        
        // HTML構造を作成
        div.innerHTML = `
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <strong>${job.name} ${job.isCompleted ? '✅' : ''}</strong>
                <div style="display:flex; align-items:center;">
                    <button class="edit-btn-trigger" style="border:none; background:none; cursor:pointer; font-size:20px; padding:10px;">✏️</button>
                    <button class="delete-btn-trigger" style="border:none; background:none; color:red; font-size:26px; cursor:pointer; min-width:48px; min-height:48px; display:inline-flex; align-items:center; justify-content:center; -webkit-appearance:none;">×</button>
                </div>
            </div>
            <div style="font-size:11px; color:#666;">期間: ${job.start} ～ ${job.end}</div>
            <div style="font-size:11px; color:#666;">想定: ${job.totalH}時間 / 進捗: ${job.progress}%</div>
        `;

        // 【ここが重要！】ボタンに対して、直接イベントを「強制注入」します
        const editBtn = div.querySelector('.edit-btn-trigger');
        const delBtn = div.querySelector('.delete-btn-trigger');

        // 編集ボタンへの注入
        editBtn.addEventListener('touchstart', (e) => {
            e.preventDefault();
            e.stopPropagation();
            openJobModal(job.id);
        }, {passive: false});

        // 削除ボタンへの注入（触れた瞬間に実行）
        delBtn.addEventListener('touchstart', (e) => {
            e.preventDefault(); // 他の動きをすべて封じる
            e.stopPropagation(); // 親要素（カレンダーなど）への伝達を止める
            hardDeleteJob(job.id);
        }, {passive: false});

        container.appendChild(div);
    });
    document.getElementById('job-list-modal-overlay').style.display = 'flex';
}
// 案件を履歴からも完全に消去する
function hardDeleteJob(id) {
    if(confirm("この案件をデータから完全に削除しますか？（履歴からも消えます）")) {
        appData.longTermJobs = appData.longTermJobs.filter(j => j.id !== id);
        saveData();
        openJobList(); // 一覧を更新
        renderCalendar(); // カレンダーを更新
        updateJobArea(); // 1日画面の表示を更新
    }
}

init();
</script>
</body>
</html>
