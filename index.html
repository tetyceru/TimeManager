<!DOCTYPE html>
<html lang="ja">

<head>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="TimeManager">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/3652/3652191.png">

    <link rel="manifest"
        href="data:application/manifest+json,{%22name%22:%22TimeManager%20Pro%22,%22short_name%22:%22TimeManager%22,%22start_url%22:%22.%22,%22display%22:%22standalone%22,%22background_color%22:%22%23f4f5f7%22,%22theme_color%22:%22%235c67f2%22}">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Time Manager Pro</title>
    <style>
        :root {
            --primary: #5c67f2;
            --shift: #4caf50;
            --job: #ffa500;
            --danger: #ff4d4d;
            --bg: #f4f5f7;
            --holiday: #ff5252;
            --sleep: #d8d6f0;
        }

        body {
            font-family: sans-serif;
            background: var(--bg);
            margin: 0;
            padding: 10px;
            display: flex;
            justify-content: center;
            -webkit-tap-highlight-color: transparent;
            overscroll-behavior-y: none;
            /* containã‚ˆã‚Šå¼·åŠ›ã«ãƒ–ãƒ©ã‚¦ã‚¶ã®ãƒã‚¦ãƒ³ã‚¹ã‚’æŠ‘åˆ¶ */
            user-select: none;
            /* æ–‡å­—é¸æŠãŒèµ°ã£ã¦ãƒ‰ãƒ©ãƒƒã‚°ãŒé€”åˆ‡ã‚Œã‚‹ã®ã‚’é˜²ã */
            -webkit-user-select: none;
        }

        .container {
            width: 100%;
            max-width: 550px;
            background: white;
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .hidden {
            display: none !important;
        }

        /* Header */
        .header {
            margin-bottom: 15px;
        }

        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            flex-wrap: wrap;
            gap: 8px;
        }

        .month-nav {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .title-group {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        #view-title {
            cursor: pointer;
            font-size: 17px;
            margin: 0;
            padding: 5px 8px;
            border-radius: 6px;
            background: #f0f0f0;
        }

        .nav-btn {
            background: #eee;
            border: none;
            padding: 10px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            font-size: 14px;
        }

        .reset-btn {
            background: #fff1f1;
            color: var(--danger);
            border: 1px solid #ffcccc;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 11px;
            cursor: pointer;
            margin-top: 4px;
            touch-action: manipulation;
        }

        .mode-switch {
            background: #f0f0f0;
            padding: 3px;
            /* 4pxã‹ã‚‰3pxã¸ï¼ˆå°‘ã—ã‚¹ãƒªãƒ ã«ï¼‰ */
            border-radius: 20px;
            display: flex;
            width: 80%;
            /* 100%ã‹ã‚‰80%ã«ï¼ˆå·¦å³ã«ä½™è£•ã‚’æŒãŸã›ã‚‹ï¼‰ */
            margin: 0 auto 15px;
            /* autoã§ä¸­å¤®å¯„ã›ã€ä¸‹ã«15pxã®ä½™ç™½ */
            box-sizing: border-box;
        }

        .mode-btn {
            flex: 1;
            border: none;
            padding: 6px 0;
            /* 10pxã‹ã‚‰6pxã¸ï¼ˆé«˜ã•ã‚’æŠ‘ãˆã‚‹ï¼‰ */
            border-radius: 18px;
            cursor: pointer;
            font-size: 12px;
            /* 13pxã‹ã‚‰12pxã¸ï¼ˆå°‘ã—å°ã•ãï¼‰ */
            font-weight: bold;
            transition: all 0.2s;
            background: transparent;
            color: #666;
        }

        /* ã‚¢ã‚¯ãƒ†ã‚£ãƒ–æ™‚ã®ã‚¹ã‚¿ã‚¤ãƒ«ã¯ãã®ã¾ã¾ */
        .mode-btn.active {
            background: var(--primary);
            color: white;
        }

        .mode-btn.shift-active {
            background: var(--shift) !important;
            color: white;
        }

        /* Calendar */
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
        }

        .calendar-day {
            border: 1px solid #eee;
            min-height: 95px;
            padding: 4px;
            cursor: pointer;
            font-size: 11px;
            border-radius: 6px;
            background: white;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }

        .calendar-day.shift-mode-active {
            border: 1.5px dashed var(--shift);
            background-color: #fafffa;
        }

        .is-today {
            border: 2px solid var(--primary) !important;
            background: #f0f2ff;
        }

        .is-holiday .day-num {
            color: var(--holiday);
        }

        .day-num {
            font-weight: bold;
        }

        .holiday-name {
            font-size: 8px;
            color: var(--holiday);
            overflow: hidden;
            white-space: nowrap;
            margin-bottom: 2px;
        }

        .job-band {
            height: 15px;
            background: var(--job);
            color: white;
            font-size: 9px;
            margin-bottom: 2px;
            border-radius: 3px;
            padding: 0 4px;
            line-height: 15px;
            overflow: hidden;
            white-space: nowrap;
        }

        .job-band.deleted {
            background: repeating-linear-gradient(45deg, #ff4d4d, #ff4d4d 5px, #ff6666 5px, #ff6666 10px);
        }

        .shift-band {
            background: #e8f5e9 !important;
            color: #2e7d32 !important;
            border: 1px solid var(--shift);
            font-weight: bold;
        }

        /* ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã‚’å›²ã‚€è¦ªç‰ï¼ˆã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã™ã‚‹æ ï¼‰ */
        #timeline-container {
            position: relative;
            margin-left: 50px;
            /* â˜…å…ƒã®è¨­å®šï¼šå·¦å´ã«ã‚¹ãƒšãƒ¼ã‚¹ã‚’ç©ºã‘ã‚‹ */
            margin-right: 10px;
            /* â˜…å…ƒã®è¨­å®šï¼šå³å´ã®ä½™ç™½ */
            /* è¦ªè¦ç´ ã®å¹…ã«åˆã‚ã›ã¦ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ãŒä¼¸ç¸®ã™ã‚‹ã‚ˆã†ã«è¨­å®š */
            touch-action: pan-x;
        }

        #timeline {
            width: 100%;
            height: 1920px;
            border: 1px solid #ccc;
            position: relative;
            background: #fff;
            touch-action: none;
            box-sizing: border-box;
            overflow: visible;
            /* ãƒ©ãƒ™ãƒ«ã‚’å¤–ã«å‡ºã™ãŸã‚ã«å¿…é ˆ */
        }

        .time-slot {
            height: 20px;
            box-sizing: border-box;
            border-bottom: 1px solid #eee;
            position: relative;
        }

        /* æ™‚åˆ»ãƒ©ãƒ™ãƒ«ã®åŸºæœ¬ã‚¹ã‚¿ã‚¤ãƒ« */
        .time-label {
            position: absolute;
            left: -50px;
            /* margin-leftã®50pxã®ä¸­ã«ãƒ”ãƒƒã‚¿ãƒªåã¾ã‚‹ */
            width: 45px;
            text-align: right;
            font-size: 11px;
            color: #888;
            font-weight: bold;
            /* topã¨line-heightã¯JSå´ã§ç²¾å¯†ã«åˆ¶å¾¡ã—ã¾ã™ */
        }

        .fixed-busy {
            background-color: var(--sleep);
        }

        .shift-busy {
            background-color: #e8f5e9;
            border-left: 5px solid var(--shift);
        }

        /* äºˆå®šãƒ–ãƒ­ãƒƒã‚¯ã¨ãƒœã‚¿ãƒ³ã®è¨­å®š */
        .custom-task {
            position: absolute;
            left: 0;
            right: 0;
            z-index: 10;
            color: white;
            font-size: 10px;
            font-weight: bold;
            padding: 2px 6px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: grab;
            box-sizing: border-box;
            overflow: visible;
            touch-action: none !important;
            transition: box-shadow 0.2s;
        }

        /* æ´ã‚“ã§ã„ã‚‹é–“ã®ã‚«ãƒ¼ã‚½ãƒ«ã‚’ã€Œæ¡ã£ãŸæ‰‹ã€ã«ã™ã‚‹ */
        .custom-task:active {
            cursor: grabbing;
        }


        .custom-task:hover {
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .btn-group-mini {
            display: flex;
            gap: 2px;
            z-index: 20;
        }

        .del-btn-mini {
            background: rgba(255, 255, 255, 0.9);
            color: #333;
            border: 1px solid #ccc;
            border-radius: 4px;
            width: 24px;
            height: 18px;
            font-size: 11px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .del-btn-mini {
            position: relative;
            /* z-indexã‚’æœ‰åŠ¹ã«ã™ã‚‹ãŸã‚ */
            z-index: 1000 !important;
            /* ãƒ–ãƒ­ãƒƒã‚¯(10)ã‚ˆã‚Šç¢ºå®Ÿã«ä¸Šã« */
            cursor: pointer;
            pointer-events: auto !important;
            /* ç¢ºå®Ÿã«åå¿œã•ã›ã‚‹ */
            touch-action: manipulation;
            /* ã‚ºãƒ¼ãƒ ãªã©ã®ä½™è¨ˆãªæŒ™å‹•ã‚’æŠ‘æ­¢ */
        }

        .move-preview {
            opacity: 0.6;
            pointer-events: none;
            z-index: 50;
            position: absolute;
            left: 0;
            right: 0;
            border: 1px solid white;
        }

        .drag-guide {
            position: absolute;
            left: 0;
            right: 0;
            width: 100%;
            background: rgba(92, 103, 242, 0.3);
            border: 2px dashed var(--primary);
            z-index: 1000;
            pointer-events: none;
            box-sizing: border-box;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary);
            font-weight: bold;
            font-size: 12px;
        }

        .time-slot::after {
            content: attr(data-label);
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 10px;
            color: rgba(0, 0, 0, 0.1);
            font-weight: bold;
            pointer-events: none;
        }

        .commute-busy,
        .break-busy {
            background-color: #f0f0f0 !important;
        }

        /* Job Cards & Modals */
        .job-card {
            background: #fffaf0;
            border: 1px solid #ffe0b2;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 8px;
        }

        .job-card.completed {
            background: #f0f0f0;
            border-color: #ccc;
            opacity: 0.8;
        }

        .job-card.deleted {
            background: repeating-linear-gradient(45deg, #fff5f5, #fff5f5 10px, #ffebeb 10px, #ffebeb 20px);
            border-color: var(--danger);
        }

        .job-card-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
            margin-top: 10px;
        }

        .progress-input {
            width: 60px !important;
            margin: 0 !important;
            padding: 4px !important;
            text-align: center;
        }

        .mini-btn {
            padding: 6px 10px;
            font-size: 11px;
            border-radius: 4px;
            border: 1px solid #ccc;
            background: white;
            cursor: pointer;
        }

        .modal-overlay {
            position: fixed;
            /* ç”»é¢ã®æ±ºã¾ã£ãŸä½ç½®ã«å›ºå®š */
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            /* èƒŒæ™¯ã‚’æš—ãã™ã‚‹ */
            display: none;
            /* â˜… ã“ã“ï¼æœ€åˆã¯éè¡¨ç¤ºã«ã™ã‚‹ */
            justify-content: center;
            align-items: center;
            z-index: 1000;
            /* ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚ˆã‚Šæ‰‹å‰ã«è¡¨ç¤º */
        }

        .modal {
            background: white;
            padding: 20px;
            border-radius: 12px;
            width: 100%;
            max-width: 360px;
            position: relative;
        }

        input,
        select {
            width: 100%;
            padding: 12px;
            margin: 8px 0;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
            box-sizing: border-box;
        }

        .save-btn {
            width: 100%;
            padding: 14px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            margin-top: 10px;
        }


        .side-nav {
            display: none;
            /* â˜…ã“ã‚Œã‚’è¿½åŠ ï¼šåˆæœŸçŠ¶æ…‹ã¯éš ã™ */
            position: fixed;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(0, 0, 0, 0.4);
            color: white;
            padding: 15px 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 5000;
            cursor: pointer;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        .prev-day {
            left: 0;
            border-radius: 0 10px 10px 0;
            /* å³å´ã ã‘ä¸¸ã */
        }

        .next-day {
            right: 0;
            border-radius: 10px 0 0 10px;
            /* å·¦å´ã ã‘ä¸¸ã */
        }

        .nav-arrow {
            font-size: 18px;
            font-weight: bold;
        }

        .nav-text {
            font-size: 10px;
            margin-top: 2px;
        }

        .side-nav:active {
            background: rgba(0, 0, 0, 0.7);
        }


        /* æ›œæ—¥ã®ãƒ˜ãƒƒãƒ€ãƒ¼éƒ¨åˆ† */
        .calendar-weekday-header {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            /* 7åˆ—ã«åˆ†ã‘ã‚‹ */
            gap: 4px;
            margin-bottom: 4px;
            text-align: center;
            font-weight: bold;
            font-size: 12px;
            color: #666;
        }

        /* åœŸæ—¥ã®è‰²ã‚’å¤‰ãˆã‚‹ã¨ãŠã—ã‚ƒã‚Œã§ã™ï¼ˆä»»æ„ï¼‰ */
        .calendar-weekday-header div:nth-child(1) {
            color: var(--holiday);
        }

        /* æ—¥æ›œæ—¥ */
        .calendar-weekday-header div:nth-child(7) {
            color: #5c67f2;
        }

        /* åœŸæ›œæ—¥ */

        /* ä»–ã®æœˆã®æ—¥ä»˜ã‚’è–„ãã™ã‚‹ */
        .other-month {
            background: #fafafa !important;
            /* èƒŒæ™¯ã‚’å°‘ã—ã‚°ãƒ¬ãƒ¼ã« */
            color: #ccc !important;
            /* æ–‡å­—ã‚’è–„ã */
            cursor: default !important;
            /* ã‚¯ãƒªãƒƒã‚¯ã§ããªã„æ„Ÿã‚’å‡ºã™ã™ */
            pointer-events: none;
            /* å®Ÿéš›ã«ã‚¯ãƒªãƒƒã‚¯ã‚’ç„¡åŠ¹åŒ– */
        }

        /* ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®1åˆ—ç›®ï¼ˆæ—¥æ›œæ—¥ï¼‰ã®æ•°å­—ã‚’èµ¤ã */
        .calendar-grid div:nth-child(7n+1) .day-num {
            color: var(--holiday);
        }

        /* ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®7åˆ—ç›®ï¼ˆåœŸæ›œæ—¥ï¼‰ã®æ•°å­—ã‚’é’ã */
        .calendar-grid div:nth-child(7n) .day-num {
            color: #5c67f2;
        }

        /* ä»–ã®æœˆã®æ—¥ä»˜ã¯ã€åœŸæ—¥ã§ã‚‚è–„ã„è‰²ã®ã¾ã¾ã«ã™ã‚‹ */
        .other-month .day-num {
            color: #ccc !important;
        }

        /* äºˆå®šãƒ–ãƒ­ãƒƒã‚¯å†…ã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
        .custom-task {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .custom-task {
            touch-action: none;
            /* ãƒ–ãƒ­ãƒƒã‚¯ä¸Šã§ã‚‚ä¸Šä¸‹ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’è¨±å¯ */
        }

        /* äºˆå®šãƒ–ãƒ­ãƒƒã‚¯è‡ªä½“ã®é‡ãªã‚Šé †ã‚’èª¿æ•´ */
        .task-block {
            touch-action: none;
            /* ãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã¨ç«¶åˆã—ãªã„ã‚ˆã†ã«ã™ã‚‹ */
        }


        /* ã‚¹ã‚¿ã‚¤ãƒ«ã®æœ€åˆã®æ–¹ã«æ›¸ã */
        #scroll-remote-control {
            display: none;
        }

        /* ã‚¹ãƒãƒ›ï¼ˆç”»é¢å¹… 768px ä»¥ä¸‹ï¼‰ã®æ™‚ã®è¨­å®š */
        @media (max-width: 768px) {




            /* ç”»é¢å³ç«¯ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ç”¨ãƒãƒ³ãƒ‰ãƒ«ï¼ˆãƒªãƒ¢ã‚³ãƒ³ï¼‰ */
            #scroll-remote-control {
                position: fixed;
                right: 5px;
                top: auto;
                width: 35px;
                height: 150px;
                background: rgba(0, 0, 0, 0.4);
                color: white;
                z-index: 9999;
                bottom: 100px;
                background: rgba(0, 0, 0, 0.6);

                flex-direction: column;
                align-items: center;
                justify-content: center;
                border-radius: 10px;
                touch-action: none;
                box-shadow: -2px 0 10px rgba(0, 0, 0, 0.2);
                pointer-events: auto;
            }

            .remote-icon {
                font-size: 24px;
                margin: 5px 0;
                ;
            }

            .remote-label {
                font-size: 11px;
                writing-mode: vertical-rl;
                letter-spacing: 2px;
                opacity: 0.8;
            }

            /* äºˆå®šãƒ–ãƒ­ãƒƒã‚¯å†…ã®ä¸‰æœ¬ç·šã¯ä¸è¦ãªã®ã§éè¡¨ç¤ºã«ã™ã‚‹ã‹ã€ãƒ‡ã‚¶ã‚¤ãƒ³ã‚’ã‚·ãƒ³ãƒ—ãƒ«ã« */
            .drag-handle {
                display: none !important;
                /* ãƒ–ãƒ­ãƒƒã‚¯å†…ã®ä¸‰æœ¬ç·šã¯æ¶ˆã™ */
            }


        }

        .remote-icon {
            font-size: 20px;
            margin: 10px 0;
            opacity: 0.8;
        }

        .remote-text {
            writing-mode: vertical-rl;
            font-size: 11px;
            letter-spacing: 3px;
            opacity: 0.7;
        }

        .move-preview.collision {
            background-color: rgba(255, 77, 77, 0.6) !important;
            /* é€æ˜æ„Ÿã®ã‚ã‚‹èµ¤ */
            border: 2px solid #ff0000 !important;
        }

        /* ã¤ã„ã§ã«æ–°è¦ä½œæˆã‚¬ã‚¤ãƒ‰ï¼ˆé•·æŠ¼ã—æ™‚ï¼‰ç”¨ã‚‚ */
        .drag-guide.collision {
            background: rgba(255, 77, 77, 0.3) !important;
            border: 2px dashed #ff0000 !important;
            color: #ff0000 !important;
        }

        .custom-task::before,
        .custom-task::after {
            content: "";
            position: absolute;
            left: 20%;
            right: 20%;
            height: 4px;
            background: rgba(255, 255, 255, 0.5);
            border-radius: 2px;
        }

        .custom-task::before {
            top: 4px;
        }

        /* ä¸Šã®ãƒãƒ³ãƒ‰ãƒ« */
        .custom-task::after {
            bottom: 4px;
        }

        /* ä¸‹ã®ãƒãƒ³ãƒ‰ãƒ« */

        .custom-task::before,
        .custom-task::after {
            content: "";
            position: absolute;
            left: 30%;
            right: 30%;
            height: 3px;
            background: rgba(255, 255, 255, 0.4);
            border-radius: 2px;
        }

        .custom-task::before {
            top: 4px;
        }

        .custom-task::after {
            bottom: 4px;
        }

        .custom-task {
            /* ãƒ–ãƒ©ã‚¦ã‚¶ç‹¬è‡ªã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚„ã‚ºãƒ¼ãƒ ã‚’ç„¡åŠ¹åŒ–ã—ã¦ã€JSã®ãƒ‰ãƒ©ãƒƒã‚°ã‚’å„ªå…ˆã•ã›ã‚‹ */
            touch-action: none;
        }
    </style>
</head>

<body>

    </div>
    <div id="app-notification"
        style="display:none; position:fixed; top:20px; left:50%; transform:translateX(-50%); width:90%; max-width:400px; background:#333; color:#fff; padding:15px; border-radius:10px; box-shadow:0 4px 15px rgba(0,0,0,0.3); z-index:10000; cursor:pointer;">
        <div id="notification-title" style="font-weight:bold; font-size:16px; margin-bottom:5px;"></div>
        <div id="notification-body" style="font-size:14px; white-space:pre-wrap;"></div>
    </div>

    <div class="container">
        <div class="header">
            <div class="top-bar">
                <button id="back-to-cal-btn" class="nav-btn hidden" onclick="showCalendar()">â† æˆ»ã‚‹</button>
                <div class="month-nav">
                    <button class="nav-btn" onclick="changeMonth(-1)">ã</button>
                    <div class="title-group">
                        <h2 id="view-title" onclick="openJumpModal()"></h2>
                        <button class="reset-btn" id="month-reset-btn">æœˆé–“ãƒªã‚»ãƒƒãƒˆ</button>
                    </div>
                    <button class="nav-btn" onclick="changeMonth(1)">ï¼</button>
                </div>
                <div id="action-btns">
                    <button onclick="openSleepModal()" class="nav-btn" style="background:var(--sleep);">ç¡çœ </button>
                    <button onclick="openShiftModal()" class="nav-btn"
                        style="background:#e8f5e9; color:#2e7d32;">ã‚·ãƒ•ãƒˆ</button>
                    <button onclick="openJobMenuModal()" class="nav-btn"
                        style="background:#fff3e0; color:#e65100;">æ¡ˆä»¶ãƒ¡ãƒ‹ãƒ¥ãƒ¼</button>
                </div>
            </div>
            <div class="mode-switch" id="mode-selector">
                <button class="mode-btn active" id="mode-normal-btn" onclick="setAppMode('normal')">é–²è¦§</button>
                <button class="mode-btn" id="mode-shift-btn" onclick="setAppMode('shift')">ã‚·ãƒ•ãƒˆä¸€æ‹¬</button>
            </div>
        </div>

        <div id="calendar-screen">
            <div class="calendar-weekday-header">
                <div>æ—¥</div>
                <div>æœˆ</div>
                <div>ç«</div>
                <div>æ°´</div>
                <div>æœ¨</div>
                <div>é‡‘</div>
                <div>åœŸ</div>
            </div>

            <div class="calendar-grid" id="calendar-grid"></div>
        </div>
        <div id="day-screen" class="hidden">
            <div
                style="display:flex; justify-content:center; align-items:center; background:#f0f2ff; padding:10px; border-radius:8px; margin-bottom:10px;">
                <div style="text-align:center;">
                    <h2 id="current-day-label" style="margin:0; font-size:16px;"></h2>
                    <div id="freeTime" style="font-size:11px; font-weight:bold;"></div>
                </div>
            </div>

            <div class="side-nav prev-day" id="side-prev" onclick="slideDay(-1)">
                <span class="nav-arrow">ï¼œ</span><span class="nav-text">å‰æ—¥</span>
            </div>
            <div class="side-nav next-day" id="side-next" onclick="slideDay(1)">
                <span class="nav-arrow">ï¼</span><span class="nav-text">ç¿Œæ—¥</span>
            </div>

            <div id="day-jobs-area"></div>
            <div id="timeline-container">
                <div id="timeline"></div>
                <div id="drag-guide" class="drag-guide hidden"
                    style="position:absolute; left:0; right:0; background:rgba(92,103,242,0.3); border:2px dashed var(--primary); z-index:1000; pointer-events:none;">
                </div>
            </div>
        </div>

        <div id="reset-modal-overlay" class="modal-overlay">
            <div class="modal">
                <h3>æœˆé–“ãƒªã‚»ãƒƒãƒˆ</h3>
                <p id="reset-confirm-msg" style="font-size:14px; color:#666;"></p>
                <button onclick="executeMonthlyReset()" class="save-btn"
                    style="background:var(--danger);">æœ¬å½“ã«ã™ã¹ã¦æ¶ˆå»ã™ã‚‹</button>
                <button type="button" onclick="closeModal('reset-modal-overlay')" class="save-btn"
                    style="background:#666;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            </div>
        </div>

        <div id="jump-modal-overlay" class="modal-overlay">
            <div class="modal">
                <h3>å¹´æœˆã‚¸ãƒ£ãƒ³ãƒ—</h3>
                <div style="display:flex; gap:10px;"><select id="jump-year"></select><select id="jump-month"></select>
                </div><button onclick="jumpToMonth()" class="save-btn">ã‚¸ãƒ£ãƒ³ãƒ—</button><button
                    onclick="closeModal('jump-modal-overlay')"
                    style="width:100%; border:none; background:none; margin-top:10px;">é–‰ã˜ã‚‹</button>
            </div>
        </div>

        <div id="sleep-modal-overlay" class="modal-overlay">
            <div class="modal">
                <h3>ç¡çœ è¨­å®š</h3>
                <div style="display:flex; gap:10px;">
                    <div><label>é–‹å§‹</label><input type="time" id="sleep-start"></div>
                    <div><label>çµ‚äº†</label><input type="time" id="sleep-end"></div>
                </div>
                <div id="batch-sleep-area"><button onclick="saveDefSleep()" class="save-btn">åŸºæœ¬è¨­å®šã¨ã—ã¦ä¿å­˜</button></div>
                <button id="save-day-sleep-btn" onclick="saveDaySleep()" class="save-btn hidden">ã“ã®æ—¥ã®ã¿ä¿å­˜</button>
                <button onclick="closeModal('sleep-modal-overlay')"
                    style="width:100%; border:none; background:none; margin-top:10px;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            </div>
        </div>

        <div id="job-menu-overlay" class="modal-overlay">
            <div class="modal">
                <h3>æ¡ˆä»¶ãƒ¡ãƒ‹ãƒ¥ãƒ¼</h3>
                <button onclick="closeModal('job-menu-overlay'); openJobModal();" class="save-btn"
                    style="background:#fff3e0; color:#e65100;">ï¼‹ æ–°è¦æ¡ˆä»¶ç™»éŒ²</button>
                <button onclick="closeModal('job-menu-overlay'); openJobList();" class="save-btn"
                    style="background:#eee; color:#333;">ğŸ“‹ æ¡ˆä»¶ä¸€è¦§ï¼ˆå…¨å±¥æ­´ï¼‰</button>
                <button onclick="closeModal('job-menu-overlay')"
                    style="width:100%; border:none; background:none; margin-top:15px;">é–‰ã˜ã‚‹</button>
            </div>
        </div>


        <div id="job-modal-overlay" class="modal-overlay">
            <div class="modal">
                <h3>æ¡ˆä»¶ç™»éŒ²</h3>
                <input type="hidden" id="edit-job-id">
                <input type="text" id="job-name" placeholder="æ¡ˆä»¶å" autocomplete="off">
                <div style="display:flex; gap:5px;"><input type="date" id="job-start"><input type="date" id="job-end">
                </div>
                <input type="number" id="job-total-h" placeholder="æƒ³å®šåˆè¨ˆæ™‚é–“(h)">
                <textarea id="job-memo" placeholder="ãƒ¡ãƒ¢ãƒ»å‚™è€ƒï¼ˆè‡ªç”±å…¥åŠ›ï¼‰"
                    style="width:100%; height:80px; margin-top:8px; padding:10px; border-radius:6px; border:1px solid #ddd; font-size:14px; box-sizing:border-box;"></textarea>
                <button onclick="saveJob()" class="save-btn">ä¿å­˜</button>
                <button
                    onclick="closeModal('job-modal-overlay'); document.getElementById('job-menu-overlay').style.display='flex';"
                    style="width:100%; border:none; background:none; margin-top:10px;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            </div>
        </div>

        <div id="modal-overlay" class="modal-overlay">
            <div class="modal">
                <h3>äºˆå®šã®è¿½åŠ </h3><input type="text" id="task-name" placeholder="äºˆå®šã®åå‰" autocomplete="off">
                <div id="color-picker-area"
                    style="display:grid; grid-template-columns:repeat(4,1fr); gap:8px; margin:10px 0;"></div><button
                    onclick="saveTask()" class="save-btn">ä¿å­˜</button>
                <button onclick="closeModal('modal-overlay')"
                    style="width:100%; border:none; background:none; margin-top:10px;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            </div>
        </div>

        <div id="edit-modal-overlay" class="modal-overlay">
            <div class="modal">
                <h3>äºˆå®šã®å‰Šé™¤</h3>
                <p id="edit-info" style="text-align:center; font-weight:bold;"></p><button id="final-delete-btn"
                    class="save-btn" style="background:var(--danger);">å‰Šé™¤</button><button
                    onclick="closeModal('edit-modal-overlay')"
                    style="width:100%; border:none; background:none; margin-top:10px;">æˆ»ã‚‹</button>
            </div>
        </div>


        <div id="job-list-modal-overlay" class="modal-overlay">
            <div class="modal" style="max-height: 80vh; overflow-y: auto;">
                <h3>æ¡ˆä»¶ä¸€è¦§ï¼ˆå…¨å±¥æ­´ï¼‰</h3>
                <div id="all-job-list-container"></div>

                <button onclick="closeModal('job-list-modal-overlay'); openJobMenuModal();" class="save-btn"
                    style="background:#666;">é–‰ã˜ã‚‹</button>
            </div>
        </div>


        <div id="shift-modal-overlay" class="modal-overlay">
            <div class="modal" style="max-height:90vh; overflow-y:auto;">
                <h3>ã‚·ãƒ•ãƒˆãƒ»æ™‚é–“è¨­å®š</h3>

                <div style="border-bottom:1px solid #eee; margin-bottom:10px; padding-bottom:10px;">
                    <label style="font-weight:bold; font-size:12px;">å‹¤å‹™æ™‚é–“</label>
                    <div style="display:flex; gap:5px; align-items:center;">
                        <input type="time" id="set-shift-start" style="margin:0;"> ï½ <input type="time"
                            id="set-shift-end" style="margin:0;">
                    </div>
                </div>

                <div style="border-bottom:1px solid #eee; margin-bottom:10px; padding-bottom:10px;">
                    <label style="font-weight:bold; font-size:12px;">é€šå‹¤æ™‚é–“ï¼ˆç‰‡é“ï¼‰</label>
                    <div style="display:flex; gap:5px;">
                        <input type="number" id="set-commute-h" placeholder="æ™‚é–“" style="width:50%; margin:0;">
                        <input type="number" id="set-commute-m" placeholder="åˆ†" style="width:50%; margin:0;">
                    </div>
                </div>

                <div style="border-bottom:1px solid #eee; margin-bottom:10px; padding-bottom:10px;">
                    <label style="font-weight:bold; font-size:12px;">æ˜¼ä¼‘ã¿ï¼ˆé–‹å§‹ãƒ»çµ‚äº†ï¼‰</label>
                    <div style="display:flex; gap:5px; align-items:center;">
                        <input type="time" id="set-break-start" style="margin:0;"> ï½ <input type="time"
                            id="set-break-end" style="margin:0;">
                    </div>
                </div>

                <div id="batch-shift-area">
                    <label style="font-size:12px; font-weight:bold;">æ›œæ—¥ä¸€æ‹¬åæ˜ </label>
                    <div id="weekday-checks"
                        style="display:grid; grid-template-columns:repeat(4,1fr); gap:5px; margin-top:5px;">
                        <label><input type="checkbox" value="1">æœˆ</label>
                        <label><input type="checkbox" value="2">ç«</label>
                        <label><input type="checkbox" value="3">æ°´</label>
                        <label><input type="checkbox" value="4">æœ¨</label>
                        <label><input type="checkbox" value="5">é‡‘</label>
                        <label><input type="checkbox" value="6">åœŸ</label>
                        <label><input type="checkbox" value="0">æ—¥</label>
                    </div>
                    <button onclick="applyBatchShift()" class="save-btn"
                        style="background:var(--shift);">ã“ã®è¨­å®šã‚’ä¸€æ‹¬åæ˜ </button>
                    <button onclick="saveDefShift()" class="save-btn"
                        style="background:#eee; color:#333; margin-top:5px;">åŸºæœ¬è¨­å®šã¨ã—ã¦ä¿å­˜</button>
                </div>

                <button id="save-day-shift-btn" onclick="saveDayShift()" class="save-btn hidden">ã“ã®æ—¥ã®ã¿ä¿å­˜</button>
                <button onclick="closeModal('shift-modal-overlay')"
                    style="width:100%; border:none; background:none; margin-top:10px; padding:10px;">é–‰ã˜ã‚‹</button>
            </div>
        </div>

        <div id="app-notice-bar" style="
    display: none; 
    position: fixed; 
    top: 20px; 
    left: 5%;         /* ç”»é¢ã®å·¦ã‹ã‚‰5%ã®ä½ç½®ï¼ˆä½™ç™½ï¼‰ */
    right: 5%;        /* ç”»é¢ã®å³ã‹ã‚‰5%ã®ä½ç½®ï¼ˆä½™ç™½ï¼‰ */
    width: 90%;       /* ç”»é¢å¹…ã®90%ã‚’ä½¿ã† */
    max-width: 400px; /* PCãªã©å¤§ããªç”»é¢ã§ã¯åºƒãŒã‚Šã™ããªã„ã‚ˆã†ã« */
    margin: 0 auto;   /* ä¸­å¤®å¯„ã›ã®äºˆå‚™ */
    background: rgba(40, 40, 40, 0.95); 
    color: white; 
    padding: 15px; 
    border-radius: 12px; 
    box-shadow: 0 8px 25px rgba(0,0,0,0.5); 
    z-index: 10000;   /* ä»–ã®è¦ç´ ã‚ˆã‚Šçµ¶å¯¾æ‰‹å‰ */
    border: 1px solid #555;
    box-sizing: border-box; /* ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚’å«ã‚ãŸå¹…è¨ˆç®—ã«ã™ã‚‹ */
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px); /* iPhoneç”¨ã®ã¼ã‹ã— */
">
            <div id="notice-title"
                style="font-weight:bold; font-size:16px; color:#ffdd00; margin-bottom:8px; border-bottom:1px solid #555; padding-bottom:5px;">
            </div>
            <div id="notice-body" style="font-size:14px; line-height:1.5; white-space:pre-wrap; word-wrap: break-word;">
            </div>
            <div style="text-align:center; font-size:11px; margin-top:10px; opacity:0.6; font-style:italic;">ã‚¿ãƒƒãƒ—ã—ã¦é–‰ã˜ã‚‹
            </div>
        </div>

        <script>
            let scrollInterval = null;
            let currentScrollSpeed = 0;
            let isEditingFromList = false; // â˜…ã“ã®è¡Œã‚’è¿½åŠ ï¼ˆç›®å°ã«ãªã‚Šã¾ã™ï¼‰
            let currentViewDate = new Date(); currentViewDate.setDate(1);
            const STORAGE_KEY = 'TimeManager_V22';
            let appData = {
                tasks: {},
                longTermJobs: [],
                singleShifts: {},
                singleSleeps: {},
                defShift: { start: 36, end: 68, commuteH: 0, commuteM: 0, breakStart: "12:00", breakEnd: "13:00" },
                defSleep: { start: 0, end: 26 },
                settings: { handleSide: 'right' } // â˜…ã“ã“ã§æœ€åˆã‹ã‚‰å®šç¾©ã—ã¦ãŠãã¨å®‰å¿ƒï¼
            };

            let holidayData = {};
            const COLORS = ["#ff99bb", "#98fb98", "#87cefa", "#ffcc99", "#e0bbff", "#ffff99", "#ffcccc", "#d3d3d3"];
            let selectedColor = COLORS[0], inputMode = 'normal', selectedDate = "";

            let touchTimer = null;
            let longPressed = false;
            let touchStartX = 0;
            let touchStartY = 0;
            let isDraggingTask = false; // ã‚¿ã‚¹ã‚¯æ“ä½œä¸­ãƒ•ãƒ©ã‚°

            let isDragging = false, dragMode = null, startIdx = null, activeTaskId = null, moveOffset = 0, tempRange = { start: 0, length: 0 }, lastTouchY = 0;

            function toggleTimelineUI(show) {
                const remote = document.getElementById('scroll-remote-control');
                if (!remote) return;

                if (show) {
                    // ã‚¹ãƒãƒ›ç”»é¢ï¼ˆ768pxä»¥ä¸‹ï¼‰ã®æ™‚ã ã‘è¡¨ç¤ºã™ã‚‹
                    if (window.innerWidth <= 768) {
                        remote.style.setProperty('display', 'flex', 'important');
                    }
                } else {
                    remote.style.setProperty('display', 'none', 'important');
                }

                // ã¤ã„ã§ã«æ—¥ä»˜ç§»å‹•ãƒœã‚¿ãƒ³(side-prev, side-next)ã‚‚ã“ã“ã§åŒæ§˜ã«åˆ¶å¾¡
                const sideBtns = [document.getElementById('side-prev'), document.getElementById('side-next')];
                sideBtns.forEach(btn => {
                    if (btn) btn.style.display = show ? 'flex' : 'none';
                });
            }

            function saveJob() {
                const id = document.getElementById('edit-job-id').value;
                const name = document.getElementById('job-name').value;
                const start = document.getElementById('job-start').value;
                const end = document.getElementById('job-end').value;
                const totalH = parseFloat(document.getElementById('job-total-h').value) || 0;
                const memo = document.getElementById('job-memo').value;
                toggleTimelineUI(false);


                if (!name) { alert("æ¡ˆä»¶åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }

                if (id) {
                    const idx = appData.longTermJobs.findIndex(j => j.id == id);
                    if (idx !== -1) {
                        appData.longTermJobs[idx].name = name;
                        appData.longTermJobs[idx].start = start;
                        appData.longTermJobs[idx].end = end;
                        appData.longTermJobs[idx].totalH = totalH;
                        appData.longTermJobs[idx].memo = memo;
                    }
                } else {
                    const newJob = {
                        id: Date.now(),
                        name: name,
                        start: start,
                        end: end,
                        totalH: totalH,
                        memo: memo,
                        progress: 0,
                        isCompleted: false
                    };
                    appData.longTermJobs.push(newJob);
                }

                saveData();

                // 1. å…¥åŠ›ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
                closeModal('job-modal-overlay');

                // 2. ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç”»é¢ï¼ˆæ–°è¦ãƒ»ä¸€è¦§ãƒœã‚¿ãƒ³ãŒã‚ã‚‹ç”»é¢ï¼‰ã‚’ç¢ºå®Ÿã«è¡¨ç¤ºã™ã‚‹
                // ä½™è¨ˆãªé–¢æ•°ï¼ˆopenJobListãªã©ï¼‰ã‚’å‘¼ã°ãšã€è¡¨ç¤ºã ã‘ã‚’å¤‰ãˆã‚‹ã®ãŒã‚³ãƒ„ã§ã™
                const menuModal = document.getElementById('job-menu-overlay');
                if (menuModal) {
                    menuModal.style.display = 'flex';
                }

                // 3. èƒŒæ™¯ã®ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼è¡¨ç¤ºã‚’æ›´æ–°ã™ã‚‹
                renderCalendar();
                if (typeof updateJobArea === 'function') updateJobArea();
            }

            function dtToStr(d) { return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`; }
            function loadData() {
                const saved = localStorage.getItem(STORAGE_KEY);
                if (saved) {
                    appData = JSON.parse(saved);
                    // â˜…ä¿å­˜ãƒ‡ãƒ¼ã‚¿ã« settings ãŒãªã‹ã£ãŸå ´åˆï¼ˆã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆç”¨ï¼‰
                    if (!appData.settings) {
                        appData.settings = { handleSide: 'right' };
                    }
                }
            }
            function saveData() { localStorage.setItem(STORAGE_KEY, JSON.stringify(appData)); }
            function indexToTime(i) { return `${String(Math.floor(i / 4)).padStart(2, '0')}:${String((i % 4) * 15).padStart(2, '0')}`; }
            function timeToIndex(t) { const [h, m] = t.split(':').map(Number); return h * 4 + Math.floor(m / 15); }
            function formatDur(l) {
                const h = Math.floor(l / 4);
                const m = (l % 4) * 15;
                if (h > 0 && m > 0) return `${h}æ™‚é–“${m}åˆ†`;
                if (h > 0) return `${h}æ™‚é–“`;
                return `${m}åˆ†`;
            }
            function isJobVisibleOnDate(job, dateStr) {
                const targetDate = new Date(dateStr);
                const startDate = new Date(job.start);
                const endDate = new Date(job.end);

                // 1. ãã‚‚ãã‚‚æ¡ˆä»¶ã®æœŸé–“å†…ã‹ãƒã‚§ãƒƒã‚¯
                if (targetDate < startDate || targetDate > endDate) return false;

                // 2. ã€Œå®Œäº†ã€ã¾ãŸã¯ã€Œå‰Šé™¤ã€ã•ã‚Œã¦ã„ã‚‹å ´åˆ
                if (job.isCompleted || job.isDeleted) {
                    // å®Œäº†/å‰Šé™¤ã—ãŸæ—¥ã®ã€Œç¿Œæ—¥ã€ä»¥é™ãªã‚‰éè¡¨ç¤ºã«ã™ã‚‹
                    // â€»job.completedDate ã‚„ job.deletedDate ãŒä¿å­˜ã•ã‚Œã¦ã„ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™
                    const actionDateStr = job.completedDate || job.deletedDate;
                    if (actionDateStr) {
                        const actionDate = new Date(actionDateStr);
                        if (targetDate > actionDate) return false;
                    }
                }

                return true;
            }
            // --- ã“ã“ã‚’ä¿®æ­£ã—ã¦ãã ã•ã„ ---

            function openJobMenuModal() {
                document.getElementById('job-menu-overlay').style.display = 'flex';
                // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ãå‡¦ç†ã®ã©ã“ã‹ã«1è¡Œè¿½åŠ 
                document.querySelectorAll('.side-nav').forEach(el => el.style.display = 'none');
                const remote = document.getElementById('scroll-remote-control');
                if (remote) {
                    remote.style.display = 'none';
                }
                toggleTimelineUI(false);
            }


            function renderCalendar() {
                const grid = document.getElementById('calendar-grid');
                grid.innerHTML = "";

                const y = currentViewDate.getFullYear();
                const m = currentViewDate.getMonth();
                const holidays = holidayData;

                // ã‚¿ã‚¤ãƒˆãƒ«æ›´æ–°
                document.getElementById('view-title').textContent = `${y}å¹´ ${m + 1}æœˆ`;

                // 1æ—¥ã®æ›œæ—¥(0:æ—¥ã€œ6:åœŸ)ã¨ã€ãã®æœˆã®æœ€çµ‚æ—¥ã‚’å–å¾—
                const firstDay = new Date(y, m, 1).getDay();
                const lastDate = new Date(y, m + 1, 0).getDate();

                // â˜… å‰æœˆã®æœ€çµ‚æ—¥ã‚’å–å¾—
                const prevMonthLastDate = new Date(y, m, 0).getDate();

                // 1. å‰æœˆã®æœ«å°¾ã‚’åŸ‹ã‚ã‚‹
                for (let i = firstDay - 1; i >= 0; i--) {
                    const date = prevMonthLastDate - i;
                    const emptyDiv = document.createElement('div');
                    emptyDiv.className = 'calendar-day other-month'; // å°‚ç”¨ã®ã‚¯ãƒ©ã‚¹ã‚’ä»˜ä¸
                    emptyDiv.innerHTML = `<div class="day-num">${date}</div>`;
                    grid.appendChild(emptyDiv);
                }

                // 2. æ—¥ä»˜ã‚’1æ—¥ã‹ã‚‰æœ«æ—¥ã¾ã§æç”»
                for (let i = 1; i <= lastDate; i++) {
                    const dStr = `${y}-${String(m + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
                    const day = document.createElement('div');
                    day.className = 'calendar-day';

                    // å„ç¨®çŠ¶æ…‹ã®ã‚¯ãƒ©ã‚¹ä»˜ã‘
                    if (inputMode === 'shift') day.classList.add('shift-mode-active');
                    if (dStr === dtToStr(new Date())) day.classList.add('is-today');

                    let html = "";
                    // ç¥æ—¥åˆ¤å®š
                    if (holidays[dStr]) {
                        day.classList.add('is-holiday');
                        html += `<div class="holiday-name">${holidays[dStr]}</div>`;
                    }
                    html += `<div class="day-num">${i}</div>`;

                    // è¡¨ç¤ºã‚¢ã‚¤ãƒ†ãƒ ï¼ˆã‚·ãƒ•ãƒˆã¨æ¡ˆä»¶ï¼‰ã®ä½œæˆ
                    let displayItems = [];
                    if (appData.singleShifts[dStr]) {
                        displayItems.push(`<div class="job-band shift-band">å‹¤:${indexToTime(appData.singleShifts[dStr].start)}</div>`);
                    }
                    (appData.longTermJobs || []).filter(j => isJobVisibleOnDate(j, dStr)).forEach(j => {
                        displayItems.push(`<div class="job-band ${j.isDeleted ? 'deleted' : ''}">${j.name}</div>`);
                    });

                    // 2ä»¶ã¾ã§è¡¨ç¤ºã€ãã‚Œä»¥ä¸Šã¯ã€Œä»–xä»¶ã€
                    displayItems.slice(0, 2).forEach(item => html += item);
                    if (displayItems.length > 2) {
                        html += `<div style="font-size:8px;color:#888;text-align:right">ä»–${displayItems.length - 2}ä»¶</div>`;
                    }

                    day.innerHTML = html;

                    // ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
                    day.onclick = () => {
                        if (inputMode === 'shift') {
                            if (appData.singleShifts[dStr]) delete appData.singleShifts[dStr];
                            else appData.singleShifts[dStr] = { ...appData.defShift };
                            saveData();
                            renderCalendar();
                        } else {
                            showDay(dStr);
                        }
                    };
                    grid.appendChild(day);
                }
                // 3. ç¿Œæœˆã®å§‹ã¾ã‚Šã‚’åŸ‹ã‚ã‚‹ï¼ˆãã®é€±ã®åœŸæ›œæ—¥ã¾ã§ï¼‰
                const lastDayOfOfMonth = new Date(y, m + 1, 0).getDay(); // ä»Šæœˆæœ«æ—¥ã®æ›œæ—¥ (0:æ—¥ã€œ6:åœŸ)
                const nextCells = 6 - lastDayOfOfMonth; // åœŸæ›œæ—¥(6)ã¾ã§ã®æ®‹ã‚Šã®ãƒã‚¹æ•°

                for (let i = 1; i <= nextCells; i++) {
                    const emptyDiv = document.createElement('div');
                    emptyDiv.className = 'calendar-day other-month';
                    emptyDiv.innerHTML = `<div class="day-num">${i}</div>`;
                    grid.appendChild(emptyDiv);
                }
                const remote = document.getElementById('scroll-remote-control');
                if (remote) {
                    remote.style.display = 'none';
                }
            }




            function init() {
                loadData();
                renderCalendar(); // ã¾ãšä¸€åº¦æç”»
                fetchHolidays();  // ç¥æ—¥ã‚’å–å¾—ã—ã¦å†æç”»

                const dayScreen = document.getElementById('day-screen');


                document.getElementById('final-delete-btn').onclick = deleteTask;
                document.getElementById('month-reset-btn').onclick = (e) => {
                    e.stopPropagation();
                    const y = currentViewDate.getFullYear(), m = currentViewDate.getMonth() + 1;
                    document.getElementById('reset-confirm-msg').textContent = `${y}å¹´${m}æœˆã®ã€Œäºˆå®šã€ã¨ã€Œã‚·ãƒ•ãƒˆã€ã‚’ã™ã¹ã¦å‰Šé™¤ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ`;
                    document.getElementById('reset-modal-overlay').style.display = 'flex';
                };

                const cp = document.getElementById('color-picker-area');
                if (cp) {
                    cp.innerHTML = "";
                    COLORS.forEach(c => {
                        const b = document.createElement('div');
                        b.style.height = '35px'; b.style.borderRadius = '6px'; b.style.background = c; b.style.border = '3px solid transparent';
                        b.onclick = () => {
                            selectedColor = c;
                            [...cp.children].forEach(x => x.style.borderColor = 'transparent');
                            b.style.borderColor = '#333';
                        };
                        cp.appendChild(b);
                    });
                }
            }



            function openJobModal(id = null) {
                const listModal = document.getElementById('job-list-modal-overlay');
                isEditingFromList = (listModal && listModal.style.display === 'flex');
                closeModal('job-list-modal-overlay');
                toggleTimelineUI(false);

                if (id) {
                    const j = appData.longTermJobs.find(x => x.id == id);
                    if (j) {
                        document.getElementById('edit-job-id').value = id;
                        document.getElementById('job-name').value = j.name;
                        document.getElementById('job-start').value = j.start;
                        document.getElementById('job-end').value = j.end;
                        document.getElementById('job-total-h').value = j.totalH;
                        document.getElementById('job-memo').value = j.memo || ""; // ãƒ¡ãƒ¢ã‚’èª­ã¿è¾¼ã¿
                    }
                } else {
                    // æ–°è¦ç™»éŒ²æ™‚ã¯ã™ã¹ã¦ç©ºã«ã™ã‚‹
                    document.getElementById('edit-job-id').value = "";
                    document.getElementById('job-name').value = "";
                    document.getElementById('job-start').value = selectedDate || dtToStr(new Date());
                    document.getElementById('job-end').value = selectedDate || dtToStr(new Date());
                    document.getElementById('job-total-h').value = "";
                    document.getElementById('job-memo').value = ""; // ãƒ¡ãƒ¢ã‚’ç©ºã«
                }
                document.getElementById('job-modal-overlay').style.display = 'flex';
                // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ãå‡¦ç†ã®ã©ã“ã‹ã«1è¡Œè¿½åŠ 
                document.querySelectorAll('.side-nav').forEach(el => el.style.display = 'none');
                const remote = document.getElementById('scroll-remote-control');
                if (remote) {
                    remote.style.display = 'none';
                }
            }

            function openShiftModal() {
                // æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ or åŸºæœ¬è¨­å®šã‚’å–å¾—
                const s = (selectedDate && appData.singleShifts[selectedDate]) ? appData.singleShifts[selectedDate] : appData.defShift;
                toggleTimelineUI(false);
                // å„å…¥åŠ›æ¬„ã«å€¤ã‚’ã‚»ãƒƒãƒˆ
                document.getElementById('set-shift-start').value = indexToTime(s.start);
                document.getElementById('set-shift-end').value = indexToTime(s.end);
                document.getElementById('set-commute-h').value = s.commuteH || 0;
                document.getElementById('set-commute-m').value = s.commuteM || 0;
                document.getElementById('set-break-start').value = s.breakStart || "12:00";
                document.getElementById('set-break-end').value = s.breakEnd || "13:00";

                document.getElementById('batch-shift-area').className = selectedDate ? 'hidden' : '';
                document.getElementById('save-day-shift-btn').className = selectedDate ? 'save-btn' : 'hidden';
                document.getElementById('shift-modal-overlay').style.display = 'flex';
                // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ãå‡¦ç†ã®ã©ã“ã‹ã«1è¡Œè¿½åŠ 
                document.querySelectorAll('.side-nav').forEach(el => el.style.display = 'none');
            }

            function saveDayShift() {
                appData.singleShifts[selectedDate] = {
                    start: timeToIndex(document.getElementById('set-shift-start').value),
                    end: timeToIndex(document.getElementById('set-shift-end').value),
                    commuteH: parseInt(document.getElementById('set-commute-h').value) || 0,
                    commuteM: parseInt(document.getElementById('set-commute-m').value) || 0,
                    breakStart: document.getElementById('set-break-start').value,
                    breakEnd: document.getElementById('set-break-end').value
                };
                saveDataAndRefresh();
                closeModal('shift-modal-overlay');
            }

            function saveDefShift() {
                appData.defShift = {
                    start: timeToIndex(document.getElementById('set-shift-start').value),
                    end: timeToIndex(document.getElementById('set-shift-end').value),
                    commuteH: parseInt(document.getElementById('set-commute-h').value) || 0,
                    commuteM: parseInt(document.getElementById('set-commute-m').value) || 0,
                    breakStart: document.getElementById('set-break-start').value,
                    breakEnd: document.getElementById('set-break-end').value
                };
                saveData();
                alert("åŸºæœ¬è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ");
            }

            function openJobMenuModal() {
                document.getElementById('job-menu-overlay').style.display = 'flex';
                // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ãå‡¦ç†ã®ã©ã“ã‹ã«1è¡Œè¿½åŠ 
                toggleTimelineUI(false);
                document.querySelectorAll('.side-nav').forEach(el => el.style.display = 'none');
            }

            function executeMonthlyReset() {
                const y = currentViewDate.getFullYear(), m = String(currentViewDate.getMonth() + 1).padStart(2, '0');
                const prefix = `${y}-${m}`;

                // ãƒ‡ãƒ¼ã‚¿ã‚’æ¶ˆã™
                Object.keys(appData.tasks).forEach(d => { if (d.startsWith(prefix)) delete appData.tasks[d]; });
                Object.keys(appData.singleShifts).forEach(d => { if (d.startsWith(prefix)) delete appData.singleShifts[d]; });

                // ä¿å­˜ã™ã‚‹
                saveData();

                // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
                closeModal('reset-modal-overlay');

                // â˜…ã€ã“ã“ãŒé‡è¦ã€‘åˆ¤å®šã‚’ç„¡è¦–ã—ã¦ã€å…¨éƒ¨å¼·åˆ¶çš„ã«æãç›´ã™ï¼
                renderCalendar();  // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’æ›´æ–°
                renderTimeline();  // ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã‚’æ›´æ–°
                updateFreeTime();  // ç©ºãæ™‚é–“è¡¨ç¤ºã‚‚æ›´æ–°
            }

            function renderTimeline() {
                const tl = document.getElementById("timeline");
                if (!tl) return;

                tl.innerHTML = ""; // ä¸€æ—¦ãƒªã‚»ãƒƒãƒˆ
                const tasks = appData.tasks[selectedDate] || [];
                const shift = appData.singleShifts[selectedDate] || appData.defShift;
                const sleep = appData.singleSleeps[selectedDate] || appData.defSleep;

                const commuteIdx = (shift.commuteH || 0) * 4 + Math.floor((shift.commuteM || 0) / 15);
                const breakS = timeToIndex(shift.breakStart || "12:00");
                const breakE = timeToIndex(shift.breakEnd || "13:00");
                toggleTimelineUI(true);


                // 96å€‹ï¼ˆ24æ™‚é–“åˆ†ï¼‰ã®ãƒã‚¹ã‚’ç”Ÿæˆ
                for (let i = 0; i < 96; i++) {
                    const slot = document.createElement("div");
                    slot.className = "time-slot";
                    slot.dataset.idx = i;

                    slot.style.position = "absolute";
                    slot.style.top = (i * 20) + "px";
                    slot.style.height = "20px";
                    slot.style.width = "100%";
                    slot.style.borderBottom = "1px solid #eee";
                    slot.style.boxSizing = "border-box";

                    // æ™‚åˆ»ãƒ©ãƒ™ãƒ« (1æ™‚é–“ã”ã¨)
                    if (i % 4 === 0) {
                        const label = document.createElement("div");
                        label.className = "time-label";

                        // â˜…å…ƒã®ä½ç½®è¨­å®š
                        label.style.position = "absolute";
                        label.style.left = "-50px";
                        label.style.width = "45px";
                        label.style.textAlign = "right";

                        // â˜…å¾®èª¿æ•´ï¼šç·šã®çœŸæ¨ªã«æ–‡å­—ãŒæ¥ã‚‹ã‚ˆã†ã«
                        label.style.top = "-10px";
                        label.style.lineHeight = "20px";

                        label.style.fontSize = "11px";
                        label.style.color = "#888";
                        label.style.fontWeight = "bold";
                        label.style.pointerEvents = "none";
                        label.style.zIndex = "20"; // ç¡çœ ãƒ»ä»•äº‹èƒŒæ™¯ã‚ˆã‚Šå‰ã«å‡ºã™

                        label.textContent = Math.floor(i / 4) + ":00";
                        slot.appendChild(label);
                    }

                    tl.appendChild(slot);

                    // --- èƒŒæ™¯è‰²åˆ¤å®š ---
                    const isSleep = (sleep.start < sleep.end) ? (i >= sleep.start && i < sleep.end) : (i >= sleep.start || i < sleep.end);
                    const hasTodayShift = appData.singleShifts[selectedDate];
                    const isWork = (hasTodayShift && i >= shift.start && i < shift.end);
                    const isCommute = (hasTodayShift && ((i >= shift.start - commuteIdx && i < shift.start) || (i >= shift.end && i < shift.end + commuteIdx)));
                    const isBreak = (hasTodayShift && i >= breakS && i < breakE && isWork);

                    if (isSleep) slot.classList.add("fixed-busy");
                    else if (isBreak) slot.classList.add("break-busy");
                    else if (isWork) slot.classList.add("shift-busy");
                    else if (isCommute) slot.classList.add("commute-busy");

                    // --- äºˆå®šãƒ–ãƒ­ãƒƒã‚¯ã®æç”» ---
                    const t = tasks.find(x => i === x.start);
                    if (t) {
                        const el = document.createElement("div");
                        el.className = "custom-task";

                        el.style.backgroundColor = t.color;
                        el.style.height = (t.length * 20 - 1) + "px";
                        el.style.position = "absolute";
                        el.style.top = "0";
                        el.style.left = "2px"; el.style.right = "2px";
                        el.style.zIndex = "10";
                        el.style.display = "flex"; el.style.alignItems = "center";
                        el.style.borderRadius = "4px"; el.style.boxSizing = "border-box";

                        // --- ãƒ†ã‚­ã‚¹ãƒˆ ---
                        const txt = document.createElement("span");
                        txt.style.cssText = "flex:1; overflow:hidden; white-space:nowrap; pointer-events:none; display:flex; flex-direction:column; line-height:1.1; padding:0 40px 0 6px;"; // å³å´ã«40pxã®ä½™ç™½
                        const totalMin = t.length * 15;
                        const timeStr = totalMin >= 60 ? `${Math.floor(totalMin / 60)}æ™‚é–“${totalMin % 60}åˆ†` : `${totalMin}åˆ†`;
                        txt.innerHTML = `<b style="font-size:10px;">${t.name}</b><span style="font-size:8px; opacity:0.8;">${timeStr}</span>`;

                        // --- ãƒœã‚¿ãƒ³ã‚°ãƒ«ãƒ¼ãƒ— ---
                        const btnGroup = document.createElement('div');
                        btnGroup.style.position = "absolute";
                        btnGroup.style.right = "35px"; // å³ç«¯ã®ãƒãƒ³ãƒ‰ãƒ«ã®åˆ†(30px)ï¼‹Î± ç©ºã‘ã‚‹
                        btnGroup.style.top = "50%";
                        btnGroup.style.transform = "translateY(-50%)";
                        btnGroup.style.display = "flex";
                        btnGroup.style.gap = "4px";

                        // ç·¨é›†ãƒœã‚¿ãƒ³
                        const eb = document.createElement('button');
                        eb.className = 'del-btn-mini'; eb.innerHTML = 'âœï¸';
                        eb.onclick = eb.ontouchend = (e) => {
                            e.stopPropagation();
                            e.preventDefault();
                            activeTaskId = t.id;
                            document.getElementById('task-name').value = t.name;
                            document.getElementById('modal-overlay').style.display = 'flex';
                            document.querySelectorAll('.side-nav').forEach(s => s.style.display = 'none');
                        };
                        eb.ontouchstart = (e) => e.stopPropagation();

                        // å‰Šé™¤ãƒœã‚¿ãƒ³
                        const db = document.createElement('button');
                        db.className = 'del-btn-mini'; db.innerHTML = 'Ã—';
                        db.onclick = db.ontouchend = (e) => {
                            e.stopPropagation();
                            e.preventDefault();
                            activeTaskId = t.id;
                            document.getElementById('edit-info').textContent = t.name;
                            document.getElementById('edit-modal-overlay').style.display = 'flex';
                            document.querySelectorAll('.side-nav').forEach(s => s.style.display = 'none');
                        };
                        // ã‚¿ã‚¹ã‚¯ãƒ–ãƒ­ãƒƒã‚¯(el)ã®ä¸­ã«ãƒãƒ³ãƒ‰ãƒ«ã‚’è¿½åŠ 
                        const dragHandle = document.createElement('div');
                        dragHandle.className = 'task-scroll-handle';
                        dragHandle.innerHTML = 'â†•ï¸'; // ã¾ãŸã¯ â˜°
                        // ãƒ‰ãƒ©ãƒƒã‚°ãƒãƒ³ãƒ‰ãƒ«ã®ã‚¹ã‚¿ã‚¤ãƒ«å¾®èª¿æ•´
                        dragHandle.style.cssText = `
                            position: absolute;
                            right: 0;
                            top: 0;
                            bottom: 0;
                            width: 30px;
                            background: rgba(0,0,0,0.05); /* ã»ã‚“ã®å°‘ã—ã ã‘è‰²ã‚’ã¤ã‘ã‚‹ */
                            border-left: 1px solid rgba(0,0,0,0.1);
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            font-size: 16px;
                            cursor: grab; /* PCã§æ´ã‚ã‚‹ã“ã¨ã‚’ç¤ºã™ */
                            touch-action: none;
                            z-index: 5;
           `;
                        dragHandle.innerHTML = 'â‹®â‹®'; // ç¸¦ã®ä¸‰ç‚¹ãƒªãƒ¼ãƒ€ãƒ¼é¢¨ï¼ˆã‚ˆãã‚ã‚‹ãƒ‰ãƒ©ãƒƒã‚°ã‚¢ã‚¤ã‚³ãƒ³ï¼‰

                        // ãƒãƒ³ãƒ‰ãƒ«ã‚’è§¦ã£ãŸæ™‚ã®ã‚¤ãƒ™ãƒ³ãƒˆ
                        dragHandle.ontouchstart = (e) => {
                            e.stopPropagation();
                            e.preventDefault();
                            if (navigator.vibrate) navigator.vibrate(30);

                            // å³åº§ã«ç§»å‹•ãƒ¢ãƒ¼ãƒ‰ã§ãƒ‰ãƒ©ãƒƒã‚°é–‹å§‹
                            startDrag(e, 'move', t.id);

                            // ã“ã®ãƒãƒ³ãƒ‰ãƒ«ã‚’æ´ã‚“ã§ã„ã‚‹é–“ã¯ã€ç«¯ã£ã“ã«è¡Œã£ãŸã‚‰è‡ªå‹•ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’æœ‰åŠ¹ã«ã™ã‚‹
                            isDraggingTaskWithHandle = true;
                        };

                        el.appendChild(dragHandle);
                        db.ontouchstart = (e) => e.stopPropagation();

                        btnGroup.appendChild(eb);
                        btnGroup.appendChild(db);
                        el.appendChild(txt);
                        el.appendChild(btnGroup);

                        // --- äºˆå®šãƒ–ãƒ­ãƒƒã‚¯è‡ªä½“ã®ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆç§»å‹•ã¨ãƒªã‚µã‚¤ã‚ºï¼‰ ---
                        const onTaskAction = (e) => {
                            if (e.target.closest('button')) return;
                            e.stopPropagation();
                            e.preventDefault();

                            const rect = el.getBoundingClientRect();
                            const touchY = e.touches ? e.touches[0].clientY : e.clientY;
                            const offsetY = touchY - rect.top;
                            let edgeSize = 15; // åŸºæœ¬ã¯15px

                            // äºˆå®šãŒçŸ­ã„ï¼ˆä¾‹ãˆã° 60px = 45åˆ†ä»¥ä¸‹ï¼‰å ´åˆã¯ã€ç«¯ã£ã“ã‚’ 10px ã«ç¸®å°
                            if (rect.height < 60) {
                                edgeSize = 10;
                            }
                            // ã•ã‚‰ã«çŸ­ã„ï¼ˆ20px = 15åˆ†ï¼‰å ´åˆã¯ã€ä¸Šä¸‹5pxãšã¤ã«ã™ã‚‹
                            if (rect.height <= 25) {
                                edgeSize = 5;
                            }

                            if (offsetY < edgeSize) {
                                startDrag(e, 'resize-top', t.id);
                            } else if (offsetY > rect.height - edgeSize) {
                                startDrag(e, 'resize-bottom', t.id);
                            } else {
                                moveOffset = Math.floor(offsetY / 20);
                                touchTimer = setTimeout(() => {
                                    if (navigator.vibrate) navigator.vibrate(50);
                                    startDrag(e, 'move', t.id);
                                    updateDragDisplay();
                                }, 500);
                            }
                        };

                        el.onmousedown = onTaskAction;
                        el.ontouchstart = onTaskAction;
                        el.ontouchend = el.onmouseup = () => clearTimeout(touchTimer);
                        el.ontouchmove = (e) => {
                            if (!isDragging) clearTimeout(touchTimer);
                        };

                        slot.appendChild(el);
                    } // ã“ã“ã§ if (t) ã®é–‰ã˜

                    // --- ã‚¹ãƒ­ãƒƒãƒˆå´ã®ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆæ–°è¦ä½œæˆç”¨ï¼‰ ---
                    slot.onmousedown = (e) => {

                        if (e.target.closest('.custom-task')) return; // äºˆå®šã®ä¸Šãªã‚‰ã‚¹ãƒ«ãƒ¼

                        isDragging = true;
                        dragMode = 'create';
                        startIdx = i; // ãƒ«ãƒ¼ãƒ—ã® i ã‚’ä½¿ç”¨
                        lastTouchY = e.clientY; // ãƒã‚¦ã‚¹ã®ç¾åœ¨åœ°ã‚’è¨˜éŒ²

                        updateDragDisplay(); // æç”»ã‚’å³å®Ÿè¡Œ
                    };

                    slot.ontouchstart = (e) => {
                        if (e.target.closest('.custom-task')) return;
                        isDragging = true;
                        dragMode = 'create';
                        startIdx = i;
                        lastTouchY = e.touches[0].clientY;
                        const touch = e.touches[0];
                        touchStartX = touch.clientX;
                        touchStartY = touch.clientY;
                        longPressed = false;
                        isDraggingTask = true;

                        touchTimer = setTimeout(() => {
                            longPressed = true;
                            isDragging = true;
                            isDraggingTask = true;
                            dragMode = 'create';
                            startIdx = i;
                            lastTouchY = touch.clientY;
                            if (navigator.vibrate) navigator.vibrate(50);
                            updateDragDisplay();
                        }, 600);
                    };

                    tl.appendChild(slot);
                } // ã“ã“ã§ for ãƒ«ãƒ¼ãƒ—ã®é–‰ã˜

                if (typeof updateFreeTime === 'function') updateFreeTime();
                const remote = document.getElementById('scroll-remote-control');
                if (remote) {
                    remote.style.display = 'flex';
                }

            } // ã“ã“ã§ renderTimeline é–¢æ•°ã®é–‰ã˜


            // ä»–ã®äºˆå®šã¨é‡ãªã£ã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯ã™ã‚‹é–¢æ•°
            function isColliding(targetTask) {
                const tasks = appData.tasks[selectedDate] || [];
                return tasks.some(t => {
                    if (t.id === targetTask.id) return false;
                    const targetEnd = targetTask.start + targetTask.length;
                    const tEnd = t.start + t.length;
                    return targetTask.start < tEnd && targetEnd > t.start;
                });
            }

            // --- 3. ãƒ‰ãƒ©ãƒƒã‚°ä¸­ã®ç§»å‹•ã‚’å‡¦ç†ã™ã‚‹é–¢æ•° ---
            function handleMove(e) {
                if (!isDragging) return; // ãƒ‰ãƒ©ãƒƒã‚°ä¸­ã§ãªã‘ã‚Œã°ä½•ã‚‚ã—ãªã„

                const event = e.touches ? e.touches[0] : e;

                // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’å®Œå…¨ã«æ­¢ã‚ã‚‹ï¼ˆä½œæˆä¸­ã‚„ç§»å‹•ä¸­ã«ç”»é¢ãŒé€ƒã’ãªã„ã‚ˆã†ã«ï¼‰
                if (e.cancelable) e.preventDefault();

                lastTouchY = event.clientY;

                // è‡ªå‹•ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ï¼ˆæŒ‡ãŒç”»é¢ã®ä¸Šä¸‹ç«¯ã«é”ã—ãŸæ™‚ã ã‘ä¸­èº«ã‚’å‹•ã‹ã™ï¼‰
                // ã“ã‚Œã¯äºˆå®šã‚’ã€Œæœã®æ–¹ã€ã‚„ã€Œå¤œã®æ–¹ã€ã¸é•·ãä¼¸ã°ã—ãŸã„æ™‚ã«ä¾¿åˆ©ãªã®ã§æ®‹ã—ã¾ã™
                if (lastTouchY < 100) startAutoScroll(-10);
                else if (lastTouchY > window.innerHeight - 100) startAutoScroll(10);
                else stopAutoScroll();

                // è¦‹ãŸç›®ã®æ›´æ–°ï¼ˆäºˆå®šã®å½±ã‚’ä¼¸ã°ã—ãŸã‚Šå‹•ã‹ã—ãŸã‚Šã™ã‚‹ï¼‰
                updateDragDisplay();
            }




            function updateDragDisplay() {
                // 1. ãƒ‰ãƒ©ãƒƒã‚°ä¸­ã‹ãƒã‚§ãƒƒã‚¯
                if (!isDragging) return;

                // 2. ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã®åŸºæº–ä½ç½®ã‚’å–å¾—
                const tl = document.getElementById('timeline');
                const tlRect = tl.getBoundingClientRect();
                const touchY = lastTouchY;

                // 3. ãƒã‚¦ã‚¹ã®ç¾åœ¨åœ°(lastTouchY)ã‹ã‚‰ã€ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ä¸Šã®ä½•ãƒã‚¹ç›®ã‹è¨ˆç®—
                const relativeY = lastTouchY - tlRect.top;
                let i = Math.floor(relativeY / 20);
                i = Math.max(0, Math.min(95, i)); // 0ã€œ95ã®ç¯„å›²ã«åã‚ã‚‹

                let t = null;
                if (dragMode === 'move' || dragMode === 'resize-top' || dragMode === 'resize-bottom') {
                    t = (appData.tasks[selectedDate] || []).find(x => x.id === activeTaskId);
                }

                if (dragMode === 'create') {
                    // startIdx ãŒ undefined ã®å ´åˆã€ä»Šã®ä½ç½®ã‚’é–‹å§‹åœ°ç‚¹ã«ã™ã‚‹ï¼ˆä¿é™ºï¼‰
                    if (typeof startIdx === 'undefined') startIdx = i;

                    const [min, max] = [startIdx, i].sort((a, b) => a - b);
                    updateGuide(min, max);

                    const g = document.getElementById('drag-guide');
                    if (g) {
                        // hiddenã‚¯ãƒ©ã‚¹ã‚’å¤–ã—ã¦è¡¨ç¤ºã•ã›ã‚‹
                        g.classList.remove('hidden');

                        const length = max - min + 1;
                        // ã“ã“ã§æ™‚é–“ã‚’è¨ˆç®—ã—ã¦è¡¨ç¤º
                        const totalMin = length * 15;
                        const h = Math.floor(totalMin / 60);
                        const m = totalMin % 60;
                        const timeStr = h > 0 ? `${h}æ™‚é–“${m}åˆ†` : `${m}åˆ†`;

                        if (isColliding({ id: null, start: min, length: length })) {
                            g.classList.add('collision');
                            g.textContent = "é‡ãªã£ã¦ã„ã¾ã™";
                        } else {
                            g.classList.remove('collision');
                            g.textContent = ` ${timeStr}`;
                        }
                    }
                }
                else if (dragMode === 'move') {
                    if (!t) return;
                    let ns = Math.max(0, Math.min(96 - t.length, i - moveOffset));
                    showPreview(ns, t.length, t.color);
                }
                else if (dragMode === 'resize-bottom') {
                    if (!t) return;
                    let newLen = Math.max(1, i - t.start + 1);
                    newLen = Math.min(96 - t.start, newLen);
                    showPreview(t.start, newLen, t.color);
                }
                else if (dragMode === 'resize-top') {
                    if (!t) return;
                    const currentEnd = t.start + t.length;
                    let newStart = Math.max(0, Math.min(currentEnd - 1, i));
                    let newLen = currentEnd - newStart;
                    showPreview(newStart, newLen, t.color);
                }

                // ãƒªã‚µã‚¤ã‚ºæ™‚ã®è¡çªãƒã‚§ãƒƒã‚¯
                const pre = document.querySelector('.move-preview');
                if (pre && t) {
                    // showPreviewã§ã‚»ãƒƒãƒˆã•ã‚ŒãŸdatasetã®å€¤ã‚’ä½¿ã£ã¦åˆ¤å®š
                    const ns = parseInt(pre.dataset.ns);
                    const nl = parseInt(pre.dataset.nl);

                    if (isColliding({ id: t.id, start: ns, length: nl })) {
                        pre.classList.add('collision');
                    } else {
                        pre.classList.remove('collision');
                    }

                }
                // â˜…è‡ªå‹•ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã®ãƒ­ã‚¸ãƒƒã‚¯
                const container = document.getElementById('timeline-container');
                const rect = container.getBoundingClientRect();

                // æŒ‡ã®ä½ç½®ãŒç”»é¢ã®ä¸Šç«¯ã‹ã‚‰50pxä»¥å†…ãªã‚‰ä¸Šã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
                if (lastTouchY < rect.top + 50) {
                    container.scrollTop -= 10;
                }
                // ä¸‹ç«¯ã‹ã‚‰50pxä»¥å†…ãªã‚‰ä¸‹ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
                else if (lastTouchY > rect.bottom - 50) {
                    container.scrollTop += 10;
                }



                handleAutoScroll(lastTouchY);
            }

            function handleAutoScroll(y) {
                if (!isDragging) return;

                const container = document.getElementById('timeline-container');
                const rect = container.getBoundingClientRect();
                const threshold = 50; // ç«¯ã‹ã‚‰ä½•pxã§ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«é–‹å§‹ã™ã‚‹ã‹

                if (y < rect.top + threshold) {
                    // ä¸Šç«¯ã«è¿‘ã„ã¨ã
                    const diff = rect.top + threshold - y;
                    container.scrollTop -= diff * 0.2; // è¿‘ã„ã»ã©é€Ÿã
                } else if (y > rect.bottom - threshold) {
                    // ä¸‹ç«¯ã«è¿‘ã„ã¨ã
                    const diff = y - (rect.bottom - threshold);
                    container.scrollTop += diff * 0.2;
                }
            }


            // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤ºç”¨ã®å…±é€šãƒ‘ãƒ¼ãƒ„ï¼ˆé‡è¤‡ã‚’æ¸›ã‚‰ã™ãŸã‚ï¼‰
            function showPreview(start, length, color) {
                let pre = document.querySelector('.move-preview');
                if (!pre) {
                    pre = document.createElement('div');
                    pre.className = 'move-preview';
                    document.getElementById('timeline').appendChild(pre);
                }

                // dataset ã«å€¤ã‚’ä¿å­˜ï¼ˆè¡çªåˆ¤å®šã§ä½¿ç”¨ï¼‰
                pre.dataset.ns = start;
                pre.dataset.nl = length;

                // ã‚¹ã‚¿ã‚¤ãƒ«è¨­å®š
                pre.style.top = (start * 20) + "px";
                pre.style.height = (length * 20 - 1) + "px";
                pre.style.backgroundColor = color;
                pre.style.opacity = "0.7";
                pre.style.position = "absolute";
                pre.style.left = "2px";
                pre.style.right = "2px";
                pre.style.zIndex = "100";
                pre.style.borderRadius = "4px";
                pre.style.display = "flex";
                pre.style.alignItems = "center";
                pre.style.justifyContent = "center";
                pre.style.color = "white";
                pre.style.fontSize = "12px";
                pre.style.fontWeight = "bold";
                pre.style.pointerEvents = "none";

                // --- ã“ã“ã§æ™‚é–“ã‚’è¨ˆç®—ã—ã¦è¡¨ç¤º ---
                const totalMin = length * 15;
                const hours = Math.floor(totalMin / 60);
                const mins = totalMin % 60;

                let timeText = "";
                if (hours > 0) {
                    timeText = `${hours}æ™‚é–“${mins > 0 ? mins + 'åˆ†' : ''}`;
                } else {
                    timeText = `${mins}åˆ†`;
                }

                pre.textContent = timeText;
            }


            // --- ã‚ªãƒ¼ãƒˆã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«é–¢é€£ ---
            function startAutoScroll(speed) {
                if (scrollInterval && currentScrollSpeed === speed) return;
                stopAutoScroll();
                currentScrollSpeed = speed;

                const container = document.getElementById('timeline-container');

                scrollInterval = setInterval(() => {
                    // ã‚³ãƒ³ãƒ†ãƒŠãŒã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¯èƒ½ãªã‚‰ã‚³ãƒ³ãƒ†ãƒŠã‚’ã€ãã†ã§ãªã‘ã‚Œã°ç”»é¢å…¨ä½“ã‚’å‹•ã‹ã™
                    if (container && container.scrollHeight > container.clientHeight) {
                        container.scrollTop += speed;
                    } else {
                        window.scrollBy(0, speed);
                    }
                    updateDragDisplay();
                }, 20);
            }

            function stopAutoScroll() {
                if (scrollInterval) {
                    clearInterval(scrollInterval);
                    scrollInterval = null;
                    currentScrollSpeed = 0;
                }
            }

            function startDrag(e, mode, taskId = null) {
                stopAutoScroll();
                isDragging = true;
                dragMode = mode;
                activeTaskId = taskId;

                // ãƒã‚¦ã‚¹(e.clientY)ã‹ã‚¿ãƒƒãƒ(e.touches[0].clientY)ã‹
                const clientY = (e.touches && e.touches[0]) ? e.touches[0].clientY : e.clientY;
                lastTouchY = clientY; // ã“ã“ã‚’è¿½åŠ ï¼šç¾åœ¨ã®åº§æ¨™ã‚’è¨˜éŒ²

                const container = document.getElementById('timeline-container');
                const rect = container.getBoundingClientRect();
                startY = clientY - rect.top + container.scrollTop;

                if (mode === 'create') {
                    startIdx = Math.floor(y / 20); // startIdxã‚’æ›´æ–°
                    updateGuide(startIdx, startIdx);
                }
            }


            // --- ãƒ‰ãƒ©ãƒƒã‚°çµ‚äº†æ™‚ã®å‡¦ç†ï¼ˆã“ã“ã‚’ä¸¸ã”ã¨å·®ã—æ›¿ãˆï¼‰ ---
            const stopDrag = () => {
                // 1. ã¾ãšä½•ã‚ˆã‚Šã‚‚å…ˆã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’æ­¢ã‚ã‚‹
                stopAutoScroll();

                // ãƒ‰ãƒ©ãƒƒã‚°ä¸­ã§ãªã‘ã‚Œã°çµ‚äº†
                if (!isDragging) return;

                // 2. è¡çªåˆ¤å®šç”¨ã®é–¢æ•°ã‚’å®šç¾©ï¼ˆå¤–ã«ãªã„å ´åˆã®ä¿é™ºï¼‰
                const tasks = appData.tasks[selectedDate] || [];
                const internalCheckCollision = (start, length, id) => {
                    return tasks.some(other => {
                        if (other.id === id) return false;
                        const otherEnd = other.start + other.length;
                        const currentEnd = start + length;
                        return start < otherEnd && currentEnd > other.start;
                    });
                };

                const currentMode = dragMode;
                const currentTaskId = activeTaskId;
                const pre = document.querySelector('.move-preview');

                try {
                    // --- A. ç§»å‹•ãƒ»ãƒªã‚µã‚¤ã‚ºã®ç¢ºå®š ---
                    if (currentTaskId && (currentMode === 'move' || currentMode.startsWith('resize')) && pre) {
                        let nextStart = parseInt(pre.dataset.ns);
                        let nextLength = parseInt(pre.dataset.nl);

                        if (!internalCheckCollision(nextStart, nextLength, currentTaskId)) {
                            const t = tasks.find(x => x.id === currentTaskId);
                            if (t) {
                                t.start = nextStart;
                                t.length = nextLength;
                                saveData();
                            }
                        }
                    }
                    // --- B. æ–°è¦ä½œæˆã®ç¢ºå®š ---
                    else if (currentMode === 'create') {
                        const g = document.getElementById('drag-guide');
                        if (g && !g.classList.contains('hidden')) {
                            const top = parseInt(g.style.top) || 0;
                            const height = parseInt(g.style.height) || 0;
                            const nStart = Math.round(top / 20);
                            const nLength = Math.round(height / 20);

                            if (nLength > 0 && !internalCheckCollision(nStart, nLength, null)) {
                                tempRange = { start: nStart, length: nLength };
                                document.getElementById('task-name').value = "";
                                document.getElementById('modal-overlay').style.display = 'flex';
                            }
                        }
                    }
                } catch (e) {
                    console.error("ç¢ºå®šå‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:", e);
                }

                // 3. ã€æœ€é‡è¦ã€‘ä½•ãŒã‚ã£ã¦ã‚‚ãƒ‰ãƒ©ãƒƒã‚°çŠ¶æ…‹ã‚’è§£é™¤ã™ã‚‹
                isDragging = false;
                dragMode = null;
                activeTaskId = null;

                // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼é¡ã‚’æ¶ˆã™
                document.querySelectorAll('.move-preview').forEach(x => x.remove());
                const guide = document.getElementById('drag-guide');
                if (guide) guide.classList.add('hidden');

                // å†æç”»
                renderTimeline();
            };

            function updateGuide(min, max) {
                const guide = document.getElementById('drag-guide');
                guide.classList.remove('hidden');
                // é–‹å§‹ä½ç½®(min) Ã— 20px
                guide.style.top = `${min * 20}px`;
                // (çµ‚äº†-é–‹å§‹+1) Ã— 20px
                guide.style.height = `${(max - min + 1) * 20}px`;

                const totalMinutes = (max - min + 1) * 15;
                const h = Math.floor(totalMinutes / 60);
                const m = totalMinutes % 60;
                guide.textContent = h > 0 ? `${h}æ™‚é–“${m}åˆ†` : `${m}åˆ†`;
            }

            function updateJobArea() { const area = document.getElementById('day-jobs-area'); area.innerHTML = ""; (appData.longTermJobs || []).filter(j => isJobVisibleOnDate(j, selectedDate)).forEach(j => { const div = document.createElement('div'); div.className = `job-card ${j.isCompleted ? 'completed' : ''} ${j.isDeleted ? 'deleted' : ''}`; div.innerHTML = `<div style="display:flex; justify-content:space-between;"><b>${j.name}</b> <small>è¨ˆ:${j.totalH}h</small></div><div class="job-card-row">é€²æ—: <input type="number" class="progress-input" value="${j.progress}" onchange="updateProgress(${j.id}, this.value)" ${j.isDeleted || j.isCompleted ? 'disabled' : ''}> %<div><button class="mini-btn" onclick="openJobModal(${j.id})">ç·¨é›†</button><button class="mini-btn" onclick="deleteJob(${j.id})">${j.isDeleted ? 'å¾©å…ƒ' : 'å‰Šé™¤'}</button><button class="mini-btn" onclick="completeJob(${j.id})">${j.isCompleted ? 'æˆ»ã™' : 'å®Œäº†'}</button></div></div>`; area.appendChild(div); }); }

            function updateProgress(id, v) { let val = Math.max(0, Math.min(100, parseInt(v) || 0)); appData.longTermJobs.find(x => x.id === id).progress = val; saveDataAndRefresh(); }
            function completeJob(id) {
                const job = appData.longTermJobs.find(j => j.id === id);
                if (!job) return;

                job.isCompleted = !job.isCompleted;

                // å®Œäº†ã—ãŸæ—¥ã®æ—¥ä»˜ã‚’è¨˜éŒ²ã™ã‚‹
                if (job.isCompleted) {
                    job.completedDate = selectedDate;
                } else {
                    delete job.completedDate;
                }

                saveData();
                updateJobArea();
                updateFreeTime();
                renderCalendar();
            }


            function deleteJob(id) {
                const job = appData.longTermJobs.find(j => j.id === id);
                if (!job) return;

                job.isDeleted = !job.isDeleted;

                // å‰Šé™¤ã—ãŸæ—¥ã®æ—¥ä»˜ã‚’è¨˜éŒ²ã™ã‚‹ï¼ˆå¾©æ´»ã•ã›ãŸã¨ãã¯æ¶ˆã™ï¼‰
                if (job.isDeleted) {
                    job.deletedDate = selectedDate;
                } else {
                    delete job.deletedDate;
                }

                saveData();
                updateJobArea();
                updateFreeTime();
                renderCalendar(); // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®è¡¨ç¤ºã‚‚æ›´æ–°
            }

            function openSleepModal() {
                const s = (selectedDate && appData.singleSleeps[selectedDate]) ? appData.singleSleeps[selectedDate] : appData.defSleep; document.getElementById('sleep-start').value = indexToTime(s.start); // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ãå‡¦ç†ã®ã©ã“ã‹ã«1è¡Œè¿½åŠ 
                document.querySelectorAll('.side-nav').forEach(el => el.style.display = 'none'); document.getElementById('sleep-end').value = indexToTime(s.end); document.getElementById('batch-sleep-area').className = selectedDate ? 'hidden' : ''; document.getElementById('save-day-sleep-btn').className = selectedDate ? 'save-btn' : 'hidden'; document.getElementById('sleep-modal-overlay').style.display = 'flex';
                const remote = document.getElementById('scroll-remote-control');
                if (remote) {
                    remote.style.display = 'none';
                }
                toggleTimelineUI(false);

            }
            function openShiftModal() {
                const s = (selectedDate && appData.singleShifts[selectedDate]) ? appData.singleShifts[selectedDate] : appData.defShift; document.getElementById('set-shift-start').value = indexToTime(s.start); document.getElementById('set-shift-end').value = indexToTime(s.end); document.getElementById('batch-shift-area').className = selectedDate ? 'hidden' : ''; document.getElementById('save-day-shift-btn').className = selectedDate ? 'save-btn' : 'hidden'; // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ãå‡¦ç†ã®ã©ã“ã‹ã«1è¡Œè¿½åŠ 
                document.querySelectorAll('.side-nav').forEach(el => el.style.display = 'none'); document.getElementById('shift-modal-overlay').style.display = 'flex';
                const remote = document.getElementById('scroll-remote-control');
                if (remote) {
                    remote.style.display = 'none';
                }
                toggleTimelineUI(false);
            }

            function openJumpModal() { toggleTimelineUI(false); const ys = document.getElementById('jump-year'), ms = document.getElementById('jump-month'); ys.innerHTML = ""; ms.innerHTML = ""; const curY = new Date().getFullYear(); for (let y = curY - 1; y <= curY + 3; y++) ys.innerHTML += `<option value="${y}" ${y == currentViewDate.getFullYear() ? 'selected' : ''}>${y}å¹´</option>`; for (let m = 0; m < 12; m++) ms.innerHTML += `<option value="${m}" ${m == currentViewDate.getMonth() ? 'selected' : ''}>${m + 1}æœˆ</option>`; document.getElementById('jump-modal-overlay').style.display = 'flex'; }
            function jumpToMonth() {
                currentViewDate.setFullYear(document.getElementById('jump-year').value); currentViewDate.setMonth(document.getElementById('jump-month').value); renderCalendar(); closeModal('jump-modal-overlay');// ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ãå‡¦ç†ã®ã©ã“ã‹ã«1è¡Œè¿½åŠ 
                document.querySelectorAll('.side-nav').forEach(el => el.style.display = 'none');
            }
            function closeModal(id) {
                const target = document.getElementById(id);
                if (target) {
                    target.style.display = 'none';
                }

                // ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ç”»é¢ï¼ˆday-screenï¼‰ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹æ™‚ã ã‘ã€çŸ¢å°ã‚’å†è¡¨ç¤ºã•ã›ã‚‹
                const isDayScreenVisible = !document.getElementById('day-screen').classList.contains('hidden');

                if (isDayScreenVisible) {
                    document.querySelectorAll('.side-nav').forEach(el => el.style.display = 'flex');
                }
            }
            function checkConflict(s, l, id, shift, sleep) {
                if (!sleep) sleep = appData.defSleep;
                if (!shift) shift = appData.defShift;

                // ç¡çœ ã¨ã®é‡ãªã‚Šãƒã‚§ãƒƒã‚¯
                const isSleep = (sleep.start < sleep.end)
                    ? (s < sleep.end && s + l > sleep.start)
                    : (s + l > sleep.start || s < sleep.end);
                if (isSleep) return true;

                // ã‚·ãƒ•ãƒˆï¼ˆä»•äº‹ï¼‰ã¨ã®é‡ãªã‚Šãƒã‚§ãƒƒã‚¯
                const breakS = timeToIndex(shift.breakStart || "12:00");
                const breakE = timeToIndex(shift.breakEnd || "13:00");

                for (let i = s; i < s + l; i++) {
                    const isWorkHour = (i >= shift.start && i < shift.end);
                    const isBreakHour = (i >= breakS && i < breakE);
                    // ä»•äº‹ä¸­ã‹ã¤ä¼‘æ†©ã˜ã‚ƒãªã„æ™‚é–“ã¯ãƒ€ãƒ¡
                    if (isWorkHour && !isBreakHour) return true;
                }

                // ä»–ã®äºˆå®šã¨ã®é‡ãªã‚Šãƒã‚§ãƒƒã‚¯
                return (appData.tasks[selectedDate] || []).some(t => {
                    if (t.id === id) return false;
                    // å®Œå…¨ã«é‡ãªã£ã¦ã„ã‚‹å ´åˆã®ã¿NGã¨ã™ã‚‹ï¼ˆs+lãŒt.startã¨åŒã˜ãªã‚‰OKï¼‰
                    return s < t.start + t.length && s + l > t.start;
                });



                // ãƒã‚¦ã‚¹ã‚’é›¢ã—ãŸæ™‚ï¼ˆPCï¼‰
                document.addEventListener('mouseup', handleEnd);

                // æŒ‡ãŒé›¢ã‚ŒãŸæ™‚ï¼ˆã‚¹ãƒãƒ›ï¼‰
                // touchcancelã¯ã€æ“ä½œä¸­ã«ã‚¢ãƒ©ãƒ¼ãƒ ãŒé³´ã£ãŸã‚Šç”»é¢ãŒåˆ‡ã‚Šæ›¿ã‚ã£ãŸã‚Šã—ãŸæ™‚ã®ãŸã‚ã®ã€Œä¸­æ–­ã€å‡¦ç†ã§ã™
                document.addEventListener('touchend', handleEnd, { passive: false });
                document.addEventListener('touchcancel', handleEnd, { passive: false });

            }

            // æŒ‡ã‚’é›¢ã—ãŸã¨ãï¼ˆmouseup / touchendï¼‰ã«å‘¼ã¶å…±é€šå‡¦ç†
            function handleEnd() {
                clearTimeout(touchTimer); // ã“ã‚ŒãŒå¤§äº‹
                if (!isDragging) return;

                if (dragMode === 'create') {
                    const guide = document.getElementById('drag-guide');
                    if (!guide.classList.contains('hidden')) {
                        // ã‚¬ã‚¤ãƒ‰ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ç¯„å›²ã‚’ãã®ã¾ã¾äºˆå®šã«ã™ã‚‹
                        // ã‚¬ã‚¤ãƒ‰ã® top / height ã‹ã‚‰é€†ç®—ã™ã‚‹ã®ãŒæœ€ã‚‚ç¢ºå®Ÿã§ã™
                        const top = parseInt(guide.style.top);
                        const height = parseInt(guide.style.height);

                        tempRange = {
                            start: Math.round(top / 20),
                            length: Math.round(height / 20)
                        };

                        // å…¥åŠ›ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’è¡¨ç¤º
                        document.getElementById('task-name').value = "";
                        document.getElementById('modal-overlay').style.display = 'flex';
                        document.querySelectorAll('.side-nav').forEach(el => el.style.display = 'none');
                        const remote = document.getElementById('scroll-remote-control');
                        if (remote) {
                            remote.style.display = 'none';
                        }
                    }
                } else if (dragMode === 'move') {
                    const pre = document.querySelector('.move-preview');
                    if (pre) {
                        const ns = parseInt(pre.dataset.ns);
                        const t = appData.tasks[selectedDate].find(x => x.id === activeTaskId);
                        if (t) {
                            t.start = ns;
                            saveData();
                            renderTimeline();
                        }
                    }
                }

                // 4. å¾Œç‰‡ä»˜ã‘
                isDragging = false;
                isDraggingTask = false; // â˜…è¿½è¨˜ï¼šã‚¬ãƒ¼ãƒ‰è§£é™¤
                longPressed = false;
                stopAutoScroll();

                activeTaskId = null;
                document.getElementById('drag-guide').classList.add('hidden');
                document.querySelectorAll('.move-preview').forEach(x => x.remove());
            }



            function updateFreeTime() {
                const shift = appData.singleShifts[selectedDate],
                    sleep = appData.singleSleeps[selectedDate] || appData.defSleep;

                let busyIdx = 0;
                let busySlots = new Array(96).fill(false);

                for (let i = 0; i < 96; i++) {
                    // 1. ç¡çœ åˆ¤å®š
                    const isSleep = (sleep.start < sleep.end)
                        ? (i >= sleep.start && i < sleep.end)
                        : (i >= sleep.start || i < sleep.end);

                    let isWorkRelated = false;
                    if (shift) {
                        // ã‚·ãƒ•ãƒˆè¨­å®šã‹ã‚‰å„å€¤ã‚’å–å¾—ï¼ˆä¿å­˜ã•ã‚Œã¦ã„ã‚‹ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£åã«åˆã‚ã›ã¦èª¿æ•´ã—ã¦ãã ã•ã„ï¼‰
                        // 1ã‚³ãƒ15åˆ†ãªã®ã§ã€åˆ†ã‚’15ã§å‰²ã£ã¦ã‚³ãƒæ•°ã«å¤‰æ›
                        const commuteSlots = Math.ceil((shift.commuteM || 0) / 15) + ((shift.commuteH || 0) * 4);

                        // å‹¤å‹™æœ¬ä½“
                        const isShiftBody = (i >= shift.start && i < shift.end);
                        // é€šå‹¤ï¼ˆå¾€è·¯ï¼šé–‹å§‹å‰ã€å¾©è·¯ï¼šçµ‚äº†å¾Œï¼‰
                        const isCommute = (i >= shift.start - commuteSlots && i < shift.start) ||
                            (i >= shift.end && i < shift.end + commuteSlots);
                        // æ˜¼ä¼‘ã¿ï¼ˆè¨­å®šã•ã‚ŒãŸé–‹å§‹ãƒ»çµ‚äº†ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ä½¿ç”¨ï¼‰
                        const isBreak = (shift.breakStart !== undefined && i >= shift.breakStart && i < shift.breakEnd);

                        if (isShiftBody || isCommute || isBreak) isWorkRelated = true;

                    }

                    if (isSleep || isWorkRelated) {
                        busyIdx++;
                        busySlots[i] = true;
                    }
                }

                // 2. äºˆå®šãƒ–ãƒ­ãƒƒã‚¯ï¼ˆtasksï¼‰ã®é‡ãªã‚Šãƒã‚§ãƒƒã‚¯
                (appData.tasks[selectedDate] || []).forEach(t => {
                    for (let i = t.start; i < t.start + t.length; i++) {
                        if (!busySlots[i]) {
                            busyIdx++;
                            busySlots[i] = true;
                        }
                    }
                });

                let jobH = 0;
                (appData.longTermJobs || [])
                    .filter(j => isJobVisibleOnDate(j, selectedDate))
                    .filter(j => !j.isDeleted && !j.isCompleted) // â˜…ã“ã“ã‚’è¿½åŠ ï¼å‰Šé™¤æ¸ˆã¨å®Œäº†æ¸ˆã‚’é™¤å¤–
                    .forEach(j => {
                        const totalDays = Math.max(1, (new Date(j.end) - new Date(j.start)) / 86400000 + 1);
                        jobH += (j.totalH * (1 - j.progress / 100)) / Math.max(1, totalDays);
                    });

                const freeMin = (96 - busyIdx) * 15 - (jobH * 60);
                const fEl = document.getElementById('freeTime');
                if (fEl) {
                    fEl.innerHTML = `è‡ªç”±æ™‚é–“: ${Math.floor(Math.max(0, freeMin) / 60)}æ™‚é–“ ${Math.floor(Math.max(0, freeMin) % 60)}åˆ†<br><small>æ¡ˆä»¶ãƒãƒ«ãƒ: ç´„ ${jobH.toFixed(1)}æ™‚é–“/æ—¥</small>`;
                }
            }



            function saveDataAndRefresh() { saveData(); if (selectedDate) { updateJobArea(); renderTimeline(); } else renderCalendar(); updateFreeTime(); }




            function showDay(d) {
                selectedDate = d;

                // --- æ—¥ä»˜ã®è¡¨ç¤ºå½¢å¼ã‚’å¤‰æ› ---
                const dateObj = new Date(d);
                const weekDays = ["æ—¥", "æœˆ", "ç«", "æ°´", "æœ¨", "é‡‘", "åœŸ"];
                const dayName = weekDays[dateObj.getDay()]; // æ›œæ—¥ã‚’å–å¾—

                // ã€Œ2026å¹´2æœˆ18æ—¥ (æ°´)ã€ã¨ã„ã†å½¢å¼ã‚’ä½œæˆ
                const formattedDate = `${dateObj.getFullYear()}å¹´${dateObj.getMonth() + 1}æœˆ${dateObj.getDate()}æ—¥ (${dayName})`;

                // ãƒ©ãƒ™ãƒ«ã«åæ˜ 
                document.getElementById('current-day-label').textContent = formattedDate;

                // --- ç”»é¢ã®è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ ---
                document.getElementById('calendar-screen').classList.add('hidden');
                document.getElementById('day-screen').classList.remove('hidden');
                document.getElementById('back-to-cal-btn').classList.remove('hidden');
                document.querySelector('.month-nav').classList.add('hidden');
                document.getElementById('month-reset-btn').classList.add('hidden');
                document.querySelectorAll('.side-nav').forEach(el => el.style.display = 'flex');
                document.getElementById('mode-selector').classList.add('hidden');

                renderTimeline();
                updateJobArea();
            }

            function setAppMode(m) { inputMode = m; document.getElementById('mode-normal-btn').className = 'mode-btn' + (m === 'normal' ? ' active' : ''); document.getElementById('mode-shift-btn').className = 'mode-btn' + (m === 'shift' ? ' shift-active' : ''); renderCalendar(); }

            function showCalendar() {
                selectedDate = ""; document.getElementById('calendar-screen').classList.remove('hidden'); document.getElementById('day-screen').classList.add('hidden'); document.getElementById('back-to-cal-btn').classList.add('hidden'); document.getElementById('mode-selector').classList.remove('hidden'); document.querySelector('.month-nav').classList.remove('hidden');
                document.getElementById('month-reset-btn').classList.remove('hidden'); document.querySelectorAll('.side-nav').forEach(el => el.style.display = 'none'); renderCalendar();
            }


            function changeMonth(diff) {
                currentViewDate.setMonth(currentViewDate.getMonth() + diff);
                fetchHolidays(); // ã“ã“ã‚‚ renderCalendar ã‹ã‚‰ fetchHolidays ã«å¤‰æ›´
            }

            function saveTask() {
                const name = document.getElementById('task-name').value.trim() || "äºˆå®š";
                if (activeTaskId) {
                    // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰
                    const task = appData.tasks[selectedDate].find(x => x.id === activeTaskId);
                    if (task) {
                        task.name = name;
                        task.color = selectedColor; // é¸æŠä¸­ã®è‰²ã‚’åæ˜ 
                    }

                } else {

                    // æ–°è¦ä½œæˆãƒ¢ãƒ¼ãƒ‰
                    if (!appData.tasks[selectedDate]) appData.tasks[selectedDate] = [];
                    appData.tasks[selectedDate].push({
                        id: Date.now(),
                        name,
                        start: tempRange.start,
                        length: tempRange.length,
                        color: selectedColor

                    });

                }
                activeTaskId = null; // IDã‚’ãƒªã‚»ãƒƒãƒˆ
                document.getElementById('task-name').value = "";
                saveDataAndRefresh();
                document.getElementById('modal-overlay').style.display = 'none';

                closeModal('modal-overlay');

            }


            function deleteTask() {
                if (!appData.tasks[selectedDate]) return;
                appData.tasks[selectedDate] = appData.tasks[selectedDate].filter(x => x.id !== activeTaskId);
                saveDataAndRefresh();
                closeModal('edit-modal-overlay');
            }

            function saveDaySleep() { appData.singleSleeps[selectedDate] = { start: timeToIndex(document.getElementById('sleep-start').value), end: timeToIndex(document.getElementById('sleep-end').value) }; saveDataAndRefresh(); closeModal('sleep-modal-overlay'); }
            function saveDefSleep() { appData.defSleep = { start: timeToIndex(document.getElementById('sleep-start').value), end: timeToIndex(document.getElementById('sleep-end').value) }; saveData(); alert("åŸºæœ¬è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ"); }


            function saveDayShift() {
                appData.singleShifts[selectedDate] = {
                    start: timeToIndex(document.getElementById('set-shift-start').value),
                    end: timeToIndex(document.getElementById('set-shift-end').value),
                    commuteH: parseInt(document.getElementById('set-commute-h').value) || 0,
                    commuteM: parseInt(document.getElementById('set-commute-m').value) || 0,
                    breakStart: document.getElementById('set-break-start').value,
                    breakEnd: document.getElementById('set-break-end').value
                };
                saveDataAndRefresh();
                closeModal('shift-modal-overlay');
            }

            function saveDefShift() {
                appData.defShift = {
                    start: timeToIndex(document.getElementById('set-shift-start').value),
                    end: timeToIndex(document.getElementById('set-shift-end').value),
                    commuteH: parseInt(document.getElementById('set-commute-h').value) || 0,
                    commuteM: parseInt(document.getElementById('set-commute-m').value) || 0,
                    breakStart: document.getElementById('set-break-start').value,
                    breakEnd: document.getElementById('set-break-end').value
                };
                saveData();
                alert("åŸºæœ¬è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ");
            }


            // æ—¥ä»˜ã‚’å‰å¾Œã•ã›ã‚‹é–¢æ•°
            function slideDay(diff) {
                const d = new Date(selectedDate);
                d.setDate(d.getDate() + diff);
                showDay(dtToStr(d));
            }

            // ã‚·ãƒ•ãƒˆã®ä¸€æ‹¬åæ˜ 
            function applyBatchShift() {
                const checked = Array.from(document.querySelectorAll('#weekday-checks input:checked')).map(c => parseInt(c.value));
                const y = currentViewDate.getFullYear(), m = currentViewDate.getMonth(), last = new Date(y, m + 1, 0).getDate();
                checked.forEach(w => {
                    for (let i = 1; i <= last; i++) {
                        const d = new Date(y, m, i);
                        if (d.getDay() === w) {
                            appData.singleShifts[dtToStr(d)] = JSON.parse(JSON.stringify(appData.defShift));
                        }
                    }
                });
                saveData();
                renderCalendar();
                closeModal('shift-modal-overlay');
            }

            // ç¥æ—¥ãƒ‡ãƒ¼ã‚¿ã®å–å¾—
            async function fetchHolidays() {
                const year = currentViewDate.getFullYear();
                try {
                    const response = await fetch(`https://holidays-jp.github.io/api/v1/${year}/date.json`);
                    if (!response.ok) throw new Error('Network response was not ok');
                    holidayData = await response.json();
                } catch (e) {
                    console.error("ç¥æ—¥ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ", e);
                    holidayData = {};
                } finally {
                    renderCalendar();
                }
            }

            // æ¡ˆä»¶ä¸€è¦§ã‚’é–‹ã
            function openJobList() {
                const container = document.getElementById('all-job-list-container');
                container.innerHTML = "";
                const sortedJobs = [...appData.longTermJobs].sort((a, b) => (a.isDeleted === b.isDeleted) ? 0 : a.isDeleted ? 1 : -1);
                toggleTimelineUI(false);

                sortedJobs.forEach(job => {
                    const div = document.createElement('div');
                    div.className = `job-card ${job.isCompleted ? 'completed' : ''} ${job.isDeleted ? 'deleted' : ''}`;
                    div.style.marginBottom = "10px";
                    div.style.padding = "10px";
                    div.style.border = "1px solid #ddd";
                    div.style.borderRadius = "8px";

                    div.innerHTML = `
            <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                <div style="font-weight:bold; font-size:14px;">${job.name}</div>
                <div>
                    <button class="mini-btn" onclick="openJobModal(${job.id})" style="padding:8px 12px; margin-right:5px;">âœï¸ ç·¨é›†</button>
                    <button class="mini-btn" onclick="hardDeleteJob(${job.id})" style="padding:8px 12px; background:#ffebee; color:#c62828; border-color:#ef9a9a;">Ã—</button>
                </div>
            </div>
            <div style="font-size:11px; color:#666; margin-top:5px;">æœŸé–“: ${job.start} ï½ ${job.end}</div>
            <div style="font-size:11px; color:#666;">æƒ³å®š: ${job.totalH}h / é€²æ—: ${job.progress}%</div>
        `;
                    container.appendChild(div);
                });
                // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ãå‡¦ç†ã®ã©ã“ã‹ã«1è¡Œè¿½åŠ 
                document.querySelectorAll('.side-nav').forEach(el => el.style.display = 'none');
                document.getElementById('job-list-modal-overlay').style.display = 'flex';
            }

            // å±¥æ­´ã‹ã‚‰å®Œå…¨ã«å‰Šé™¤
            function hardDeleteJob(id) {
                toggleTimelineUI(false);
                if (confirm("ã“ã®æ¡ˆä»¶ã‚’å±¥æ­´ã‹ã‚‰å®Œå…¨ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) {
                    appData.longTermJobs = appData.longTermJobs.filter(j => j.id !== id);
                    saveData();
                    openJobList();
                    renderCalendar();

                }
            }


            function getUpcomingJobs() {
                const today = new Date();
                today.setHours(0, 0, 0, 0);

                // 3æ—¥å¾Œã®æ—¥ä»˜
                const threeDaysLater = new Date(today);
                threeDaysLater.setDate(today.getDate() + 3);

                // æ¡ä»¶ã«åˆã†æ¡ˆä»¶ã‚’æŠ½å‡º
                return (appData.longTermJobs || []).filter(j => {
                    const dueDate = new Date(j.end);
                    // å‰Šé™¤ãƒ»å®Œäº†ã•ã‚Œã¦ãŠã‚‰ãšã€ã‹ã¤ã€Œä»Šæ—¥ã€œ3æ—¥å¾Œã€ãŒç· åˆ‡ã®ã‚‚ã®
                    return !j.isDeleted && !j.isCompleted && dueDate >= today && dueDate <= threeDaysLater;
                });
            }

            function toggleHandedness() {
                appData.settings.handleSide = (appData.settings.handleSide === 'right') ? 'left' : 'right';
                saveData();
                renderTimeline(); // ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã‚’å†æç”»ã—ã¦åæ˜ 
            }

            function sendJobNotification() {
                const now = new Date();
                // æ—¥æœ¬æ™‚é–“ã® YYYY-MM-DD ã‚’ç¢ºå®Ÿã«å–å¾—
                const y = now.getFullYear();
                const m = String(now.getMonth() + 1).padStart(2, '0');
                const d = String(now.getDate()).padStart(2, '0');
                const todayStr = `${y}-${m}-${d}`; // "2026-02-25" å½¢å¼

                const todayTime = new Date(y, now.getMonth(), now.getDate()).getTime();
                const threeDaysLaterTime = todayTime + (3 * 24 * 60 * 60 * 1000);

                let upcomingJobs = (appData.longTermJobs || []).filter(j => {
                    // ã‚¹ãƒ©ãƒƒã‚·ãƒ¥ã‚’ãƒã‚¤ãƒ•ãƒ³ã«ç½®æ›ã—ã¦çµ±ä¸€
                    const formattedEnd = j.end.replace(/\//g, '-');
                    const dueDate = new Date(formattedEnd);
                    const dueTime = dueDate.getTime();

                    return !j.isDeleted && !j.isCompleted && dueTime >= todayTime && dueTime <= threeDaysLaterTime;
                });

                if (upcomingJobs.length === 0) return;

                upcomingJobs.sort((a, b) => new Date(a.end.replace(/\//g, '-')) - new Date(b.end.replace(/\//g, '-')));

                // 1. ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä½œæˆ
                let title = upcomingJobs.length === 1 ? "ğŸ“¢ ç· åˆ‡é–“è¿‘ã®æ¡ˆä»¶" : `ğŸ“¢ ç· åˆ‡é–“è¿‘ãŒ ${upcomingJobs.length} ä»¶ã‚ã‚Šã¾ã™`;

                // 2. å„æ¡ˆä»¶ã®è¡¨ç¤ºã‚¹ã‚¿ã‚¤ãƒ«ã‚’è¨­å®š
                let bodyHtml = upcomingJobs.map(j => {
                    // å½¢å¼ã‚’çµ±ä¸€ã—ã¦æ¯”è¼ƒ
                    const jobEnd = j.end.replace(/\//g, '-');
                    const isToday = (jobEnd === todayStr);

                    if (isToday) {
                        // â˜… ã“ã“ã§è‰²ã¨å¤ªã•ã‚’æŒ‡å®š
                        return `<div style="color: #ff4d4d !important; font-weight: 900 !important; margin-bottom: 6px;">ãƒ»${j.name} (æœ¬æ—¥ç· åˆ‡ï¼)</div>`;
                    } else {
                        return `<div style="margin-bottom: 4px; color: #ffffff;">ãƒ»${j.name} (${j.end})</div>`;
                    }
                }).join('');

                // 3. ç”»é¢ã«è¡¨ç¤º
                const bar = document.getElementById('app-notice-bar');
                const titleEl = document.getElementById('notice-title');
                const bodyEl = document.getElementById('notice-body');

                titleEl.innerText = title;
                bodyEl.innerHTML = bodyHtml; // innerHTMLã‚’ä½¿ã†

                bar.style.display = 'block';
                bar.onclick = () => { bar.style.display = 'none'; };
                setTimeout(() => { bar.style.display = 'none'; }, 10000);
            }

            // ã‚¢ãƒ—ãƒªã®åˆæœŸåŒ–
            function init() {
                loadData();
                renderCalendar();
                fetchHolidays();

                // â˜… ã“ã“ã‹ã‚‰è¿½è¨˜ï¼šé€šçŸ¥ã®åˆæœŸè¨­å®šã¨å®Ÿè¡Œ
                if (window.Notification) {
                    if (Notification.permission === "default") {
                        Notification.requestPermission();
                    }
                    // ã‚¢ãƒ—ãƒªèµ·å‹•æ™‚ã«ç· åˆ‡ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦é€šçŸ¥ã‚’å‡ºã™
                    sendJobNotification();
                }
                // â˜… ã“ã“ã¾ã§è¿½è¨˜

                const dayScreen = document.getElementById('day-screen');
                dayScreen.addEventListener('touchstart', (e) => {
                    if (document.getElementById('job-list-modal-overlay').style.display === 'flex') return;
                    touchStartX = e.touches[0].pageX;
                }, { passive: true });

                dayScreen.addEventListener('touchend', (e) => {
                    // â˜…ã“ã“ã‚’è¿½åŠ ï¼šã‚¿ã‚¹ã‚¯æ“ä½œä¸­ãªã‚‰æ—¥ä»˜ã‚’åˆ‡ã‚Šæ›¿ãˆãªã„ï¼
                    if (isDraggingTask) return;
                    const touchEndX = e.changedTouches[0].pageX;
                    const diff = touchStartX - touchEndX;
                    if (diff > 100) slideDay(1);
                    else if (diff < -100) slideDay(-1);
                }, { passive: true });

                document.getElementById('final-delete-btn').onclick = deleteTask;
                document.getElementById('month-reset-btn').onclick = (e) => {
                    e.stopPropagation();
                    const y = currentViewDate.getFullYear(), m = currentViewDate.getMonth() + 1;
                    document.getElementById('reset-confirm-msg').textContent = `${y}å¹´${m}æœˆã®ã€Œäºˆå®šã€ã¨ã€Œã‚·ãƒ•ãƒˆã€ã‚’ã™ã¹ã¦å‰Šé™¤ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ`;
                    document.getElementById('reset-modal-overlay').style.display = 'flex';
                };

                // inité–¢æ•°ã®ä¸­ã«ã“ã‚Œã‚’è¿½åŠ 
                document.body.addEventListener('click', () => {
                    sendJobNotification();
                }, { once: true }); // æœ€åˆã®ä¸€å›ã ã‘å®Ÿè¡Œ

                const cp = document.getElementById('color-picker-area');
                if (cp) {
                    cp.innerHTML = "";
                    COLORS.forEach(c => {
                        const b = document.createElement('div');
                        b.style.height = '35px';
                        b.style.borderRadius = '6px';
                        b.style.background = c;
                        b.style.border = '3px solid transparent';
                        b.onclick = () => {
                            selectedColor = c;
                            [...cp.children].forEach(x => x.style.borderColor = 'transparent');
                            b.style.borderColor = '#333';
                        };
                        cp.appendChild(b);
                    });
                }
            }

            // ãƒªãƒ¢ã‚³ãƒ³ã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã™ã‚‹é–¢æ•°
            function setupScrollRemote() {
                // äºŒé‡ã«ä½œã‚‰ã‚Œãªã„ã‚ˆã†ã«ãƒã‚§ãƒƒã‚¯
                if (document.getElementById('scroll-remote-control')) return;

                const remote = document.createElement('div');
                remote.id = 'scroll-remote-control';
                remote.innerHTML = `
        <div class="remote-icon">â–²</div>
        <div class="remote-text">SCROLL</div>
        <div class="remote-icon">â–¼</div>
    `;
                document.body.appendChild(remote);

                // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã•ã›ã‚‹å¯¾è±¡ã®ã‚³ãƒ³ãƒ†ãƒŠï¼ˆIDã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼‰
                const container = document.getElementById('timeline-scroll-container');
                let lastY = 0;

                // ã‚¿ãƒƒãƒé–‹å§‹
                remote.ontouchstart = (e) => {
                    lastY = e.touches[0].clientY;
                    remote.style.background = "rgba(0, 0, 0, 0.7)"; // è§¦ã£ã¦ã„ã‚‹é–“ã¯æ¿ƒãã™ã‚‹
                    if (navigator.vibrate) navigator.vibrate(10);  // ã‚ãšã‹ã«æŒ¯å‹•
                };

                // ã‚¹ãƒ©ã‚¤ãƒ‰ä¸­
                remote.ontouchmove = (e) => {
                    const currentY = e.touches[0].clientY;
                    const diff = lastY - currentY;

                    // ç§»å‹•é‡ã‚’3å€ã«ã—ã¦é«˜é€Ÿã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
                    container.scrollTop += diff * 3;
                    lastY = currentY;
                    e.preventDefault(); // ç”»é¢å…¨ä½“ãŒå‹•ãã®ã‚’é˜²æ­¢
                };

                // ã‚¿ãƒƒãƒçµ‚äº†
                remote.ontouchend = () => {
                    remote.style.background = "rgba(0, 0, 0, 0.4)";
                };
            }

            // init() ã®æœ€å¾Œã€ã¾ãŸã¯ä¸€ç•ªä¸‹ã®å®Ÿè¡Œéƒ¨åˆ†ã«è¿½åŠ ã—ã¦ãã ã•ã„
            setupScrollRemote();


            // èµ·å‹•
            init();

            // PCç”¨ãƒã‚¦ã‚¹ç›£è¦–
            window.addEventListener('mousemove', (e) => {
                if (!isDragging) return;
                handleAutoScroll(e.clientY);
                lastTouchY = e.clientY; // ãƒã‚¦ã‚¹ã®Yåº§æ¨™ã‚’æ›´æ–°
                updateDragDisplay();    // è¡¨ç¤ºã‚’æ›´æ–°
            });

            // ãƒã‚¦ã‚¹ã‚’é›¢ã—ãŸæ™‚
            window.addEventListener('mouseup', () => {
                if (isDragging) {
                    stopDrag();
                }
            });

            // ã‚¹ãƒãƒ›ç”¨ã‚¿ãƒƒãƒç›£è¦–
            // windowã®touchmoveã‚¤ãƒ™ãƒ³ãƒˆå†…ï¼ˆæ—¢å­˜ã®å‡¦ç†ãŒã‚ã‚‹å ´æ‰€ã«è¿½è¨˜ï¼‰
            // windowã® touchmove ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆãƒ‰ãƒ©ãƒƒã‚°ä¸­ã®å‡¦ç†ï¼‰ã‚’æ¢ã—ã¦ã€ä¸­èº«ã‚’æ›´æ–°
            window.addEventListener('touchmove', (e) => {
                if (!isDragging) return;

                const touch = e.touches[0];
                lastTouchY = touch.clientY; // åº§æ¨™ã‚’å¸¸ã«æ›´æ–°

                // â˜…é‡è¦ï¼šã‚¹ãƒãƒ›ã§ã®ã‚ªãƒ¼ãƒˆã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«åˆ¤å®šã‚’å®Ÿè¡Œ
                handleAutoScroll(lastTouchY);

                // ãƒ‰ãƒ©ãƒƒã‚°ä¸­ã®æç”»æ›´æ–°ï¼ˆã™ã§ã«ã‚³ãƒ¼ãƒ‰ã«ã‚ã‚‹ã¯ãšï¼‰
                updateDragDisplay();
            }, { passive: false });

            window.addEventListener('touchend', stopDrag);
            window.addEventListener('touchcancel', stopDrag);
            // ãƒã‚¦ã‚¹ã‚’å‹•ã‹ã—ã¦ã„ã‚‹æœ€ä¸­ã®å‡¦ç†
            window.onmousemove = (e) => {
                if (!isDragging) return;
                lastTouchY = e.clientY;
                updateDragDisplay();
            };

            // ãƒã‚¦ã‚¹ã‚’é›¢ã—ãŸæ™‚ã®å‡¦ç†
            window.onmouseup = () => {
                if (isDragging) {
                    stopDrag(); // æŒ‡ã‚’é›¢ã—ãŸã‚‰çµ‚äº†å‡¦ç†
                }
            };

            // ã‚¿ãƒƒãƒæ“ä½œç”¨ã‚‚åŒæ§˜ã«
            window.ontouchmove = (e) => {
                if (!isDragging) return;
                lastTouchY = e.touches[0].clientY;
                updateDragDisplay();
            };

            window.ontouchend = () => {
                stopDrag();
            };

            // ãƒªãƒ¢ã‚³ãƒ³ãƒœã‚¿ãƒ³ã®è¨­å®šé–¢æ•°
            const setupRemoteBtn = (btn, speed) => {
                if (!btn) return;

                const start = (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    startAutoScroll(speed);
                };

                // touchstartã ã‘ã§å³åº§ã«åå¿œã•ã›ã‚‹
                btn.addEventListener('touchstart', start, { passive: false });
                btn.addEventListener('touchend', stopAutoScroll);

                // PCç”¨
                btn.addEventListener('mousedown', start);
                btn.addEventListener('mouseup', stopAutoScroll);
            };

            // HTMLã®èª­ã¿è¾¼ã¿ã‚’å¾…ã£ã¦å®Ÿè¡Œ
            document.addEventListener('DOMContentLoaded', () => {
                setupRemoteBtn(document.getElementById('remote-up'), -15);
                setupRemoteBtn(document.getElementById('remote-down'), 15);
            });

        </script>
</body>

</html>
